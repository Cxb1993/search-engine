弦分量投影信號，如此可得出 n階次電壓與電流諧波分
量的瞬時電壓和電流的均方根值，如(7)和(8)示。 
 
( ) ( ), , sin( )=n n t v,ns n rms +1V θ = V θ V θ θ2     (3) 
( ) ( ), , sin( )=n t v,nn s n rms i,n+1I θ = I θ I θ θ +θ2      (4) 
( )' , ,sin cos( )⎛ ⎞⎜ ⎟⎝ ⎠π =n v,n t v,nn rms t n rms +V θ =V θ +θ + V θ θ2    (5) 
( )' , ,sin cos( )n v,n t v,nn rms t n rmsi,n i,n+I θ = I θ +θ +θ + I θ θ +θ2⎛ ⎞⎜ ⎟⎝ ⎠π =
                                             (6) 
( ) ( ) 122 2', ⎡ ⎤⎢ ⎥⎣ ⎦+n nn rmsV = V θ V θ           (7) 
( ) ( ) 122 2', ⎡ ⎤⎢ ⎥⎣ ⎦+n nn rmsI = I θ I θ           (8) 
 
進一步由簡單的計算得到各級電壓與電流諧波分
量實功率和虛功率，如(9)和(10)。由各級諧波均方根(有
效)電壓和電流值的量測結果，或由實功率及虛功率的運
算可得到諧波複數功率，如(11)所示。 
 
( ) ( ) ( ) ( )' '⎡ ⎤⎣ ⎦⋅ + ⋅n n n n nP = V θ I θ V θ I θ             (9) 
    ( ) ( ) ( ) ( )' '⎡ ⎤⎣ ⎦⋅ − ⋅n n n n nQ = V θ I θ V θ I θ            (10) 
2 2
,⋅ = +n n nn,rms n rmsS =V I P Q          (11) 
 
2.2 電壓與電流訊號中各級諧波分量之濾出與餘弦函數
之取得 
 
前述各階次諧波之有效值與各式功率計算式，均需
先濾出各階次的電壓與電流，並取得其餘弦函數，此部
份可使用短時傅立葉濾波器(Short-Time Fourier filter)完
成。短時傅立葉濾波器的操作原理與頻域特性敘述如
下： 
假設電壓與電流訊號表為 y(t)，以傅立葉級數表示
如(12)，其中 n 為諧波階次。假設 fsamp為取樣頻率、fs
為基本波頻率，取樣數 N則為 fsamp/ fs。圖 1為傅立葉濾
波器取樣視窗示意圖，傅立葉級數中 an(正弦)與 bn(餘弦)
參數可由離散式積分通式(13)與(14)得到，其中 yk為取
樣視窗的輸入訊號序列，k為取樣順序。由通式(13)與(14)
中可知在使用短時離散傅立葉濾波器時，須要用取樣視
窗所有訊號，因此最多需一個視窗的時間才可得到第一
個正確的正、餘弦分量。但在實際運算上，可利用移動
性視窗的觀念進一步推得簡易的加速演算法，如此可將
運算量大幅減少，助益數位實現。 
 
 
圖 1. 使用移動性視窗作短時傅立葉濾波器計算。 
( ) ( )0
1
sin coss sn n
n
y t a a n t b n t
∞
=
= + ω + ω∑        (12) 
1
,
0
2 2sin
−
=
⎛ ⎞⎜ ⎟⎝ ⎠
π= ∑Nn k k
k
a y nk
N N                  (13) 
1
,
0
2 2cos
−
=
⎛ ⎞⎜ ⎟⎝ ⎠
π= ∑Nn k k
k
b y nk
N N                     (14) 
 
短時傅立葉濾波器的頻域特性如下示，假設輸入電
壓與電流訊號表示成標準指數函數型式，如(15)所示，
其振幅為 1。設定積分時間 t介於-nT/2至 nT/2之間， sω
為基頻頻率，n 為諧波階次，將此訊號作傅立葉轉換，
可得傅立葉濾波器轉移函數如(16)示，其頻率響應如圖 2
所示。其中基頻 377sω = 以 60Hz為濾出頻率，此時諧
波階次 n=1、時間 t介於-T/2至 T/2之間，為全週型傅立
葉濾波器，其整數倍諧波(120、180、240Hz…)均落於零
增益點，頻率響應如圖 2(a)所示，可具有高次諧波濾除
能力。若 1 131s ,ω = 以 180Hz為濾出頻率，此時諧波階次
n=3、時間 t介於-3T/2至 3T/2之間，頻率響應如圖 2(b)
所示，為三週型傅立葉濾波器。此時除 180Hz 以外之
60Hz 整數倍諧波(60、120、240、300Hz…)，亦均落於
零增益點，可將其它諧波成份完全濾除。 
 
*2 *  ( ) j t j f tz t e eω π= =                        (15) 
 
/ 2
/ 2
( ) ( ) s
nT jn t
nT
F z t e dt− ω−ω = ∫  
/ 2( )/ 2 / 2 ( )
/ 2 / 2
/ 2
( )
s
s s
nTj tnT nTjn t j tj t
nT nT
s nT
ee e dt e dt
j
ω−ω
− ω ω−ωω
− −
−
= = = ω−ω∫ ∫
2sin( ( ))
2
( )
s
s
nT ω−ω
= ω−ω
                         (16) 
 
 
(a)全週型( 377snω = )   (b) 三週型( 1 131sn ,ω = ) 
 
圖 2. 多週取樣傅立葉濾波器之頻率響應圖。 
 
以基頻 60Hz成份之正、餘弦分量 a1,k與 b1,k的分離
為例，假設 fsamp為 5.4k Hz，則一週期取樣數為 90點，
使用全週型傅立葉濾波器可將其正餘弦分量表示成
(17)、(18)，此時取樣視窗長度為 90 點，計算完整取樣
視窗內整個資料後可得到 60Hz 之正、餘弦分量 a1,k與
b1,k。 
 
89
1,
0
1 sin
45 45=
⎛ ⎞⎜ ⎟⎝ ⎠
π= ∑k k
k
a y k
            (17) 
89
1,
0
1 cos
45 45=
⎛ ⎞⎜ ⎟⎝ ⎠
π= ∑k k
k
b y k
            (18) 
 
圖 6. 即時諧波偵測器的 FPGA裝置實現方塊圖。 
 
考慮 FPGA資源利用(單通道需要 4個乘法 5個加法
經合成需要 36個 DSP Block，36*2*25=1,800，而 FPGA
只提供 288個 DSP )，故本實作採用分時多工方式，將 4
個乘法器，用記憶體配合一個乘法器來計算，5 個加法
器，用記憶體配合一個加法器來計算，再整合 V與 I兩
channel 合計 8 個乘法器，用一個乘法器來計算，10 個
加法器用一個加法器來計算，如此只使用 8 個 DSP 
block，25*8=200，資源足夠。 
    以分時多工經實際調整所需的時間為 280 clock，
FPGA設定振盪頻率為 50MHz，280/50M=5.6μsec，訊號
輸入基本頻率為 60Hz， N=90，所以取樣時間
T=1/60/90=0.2 msec，可計算時間相當充裕。在第一週期
過後 5.6 μsec，就可得到 1~49 階諧波波形，以及 1~49
階諧波的 P、Q、Vrms、Irms等參數。 
 
 
四、實測驗證 
 
實測驗證時以可程式型訊號產生器輸出含特定成
份諧波之電壓與電流訊號作測試源，確認所研製偵測器
的精確度與響應速度。圖 7為偵測的電流、電壓訊號及
其濾出的正弦與餘弦基頻波形，圖 7(a)中輸入電流訊號
於 0.055 秒時發生變化，隨後濾出的正弦與餘弦基頻電
流波形訊號亦隨之變動。圖 7(b)為輸入電壓訊號與濾出
之正弦與餘弦分量，亦有相同效果。 
圖 8 為實測 FPGA 計算的基本波至 23 級諧波偵測
響應，圖 9為 FPGA計算的實測 25次至 49級諧波偵測
響應，以傳統 FFT計算結果比較相當一致，可確認本計
畫的成效符合要求。 
 
 
(a) 輸入電壓訊號及濾出之正弦與餘弦波形。 
 
(b) 輸入電流訊號及濾出之正弦與餘弦波形。 
圖 7. 以 FPGA偵測電流與電壓訊號濾出的基頻波形。 
 
 
(a) 基本波電壓及電流有效值。 
 
(b) 基本波之各式功率。 
 
(c) 3次諧波電壓及電流有效值。 
Lo
ca
tio
PI
N_
18
O
pt
io
n
V
al
ue
VC
C
cl
k_
in
IN
PU
T
Lo
ca
tio
n
PI
N_
23
O
pt
io
n
V
al
ue
VC
C
sw
1
IN
PU
T
Lo
ca
tio
n
PI
N_
29
O
pt
io
n
V
al
ue
di
g1
O
U
TP
U
T
Lo
ca
tio
n
PI
N_
30
O
pt
io
n
V
al
ue
di
g2
O
U
TP
U
T
Lo
ca
tio
n
PI
N_
31
O
pt
io
n
V
al
ue
di
g3
O
U
TP
U
T
Lo
ca
tio
n
PI
N_
32
O
pt
io
n
V
al
ue
di
g4
O
U
TP
U
T
Lo
ca
tio
n
PI
N_
11
0
Lo
ca
tio
n
PI
N_
11
2
Lo
ca
tio
n
PI
N_
11
4
Lo
ca
tio
n
PI
N_
11
8
Lo
ca
tio
n
PI
N_
12
0
Lo
ca
tio
n
PI
N_
12
2
Lo
ca
tio
n
PI
N_
12
4
Lo
ca
tio
n
PI
N_
12
7
O
pt
io
n.
..
V
al
ue
...
D
A
_O
ut
[1
5.
.0
]
O
U
TP
U
T
re
se
t
cl
k_
in
A
V
si
ng
le
0[
11
..0
]
si
ng
le
1[
11
..0
]
si
ng
le
2[
11
..0
]
si
ng
le
3[
11
..0
] R
D
R
W
C
S0
C
S1
D
at
a[
11
..
0]
A
D
_c
on
tr
ol
in
st
3 cl
k_
in
re
se
t
do
t0
[1
1.
.0
]
do
t1
[1
1.
.0
]
do
t2
[1
1.
.0
]
do
t3
[1
1.
.0
]
C
os
_o
ut
[1
5.
.0
]
S
in
_o
ut
[1
5.
.0
]
H
ar
m
on
ic
in
st
P_
Co
s
40
76
P_
Si
n
40
1
Pa
ra
m
et
er
V
al
ue
D
_i
n[
31
..
0]
cl
k
tri
p1
tri
p2
S
qa
rt
_o
ut
[1
5.
.0
]
S
qa
rt
in
st
5
N
O
T
in
st
8
VC
C
da
ta
a:
 U
ns
ig
ne
d
da
ta
b:
 U
ns
ig
ne
d
M
UL
T0
c0 c0
c0
M
UL
T1
c0 c0
c0
c0
da
ta
a_
0[
15
..0
]
da
ta
b_
0[
15
..0
]
da
ta
a_
1[
15
..0
]
da
ta
b_
1[
15
..0
]
cl
oc
k0
re
su
lt[
32
..0
]
ad
d_
m
ul
t
in
st
10
D
A
_O
ut
13
[1
5.
.0
]
O
U
TP
U
T
VC
C
sw
2
IN
PU
T
cl
k_
in
ou
t0
ou
t1
ou
t2
ou
t3
C
LK
_g
en
in
st
14
 
(t) 19次諧波各式功率。 
 
(u) 21次諧波電壓及電流有效值。 
 
(v) 21次諧波各式功率。 
 
(w) 23次諧波電壓及電流有效值。 
 
(x) 23次諧波各式功率。 
圖 8. 實測基本波至 23級諧波偵測響應。 
 
 
(a) 25次諧波電壓及電流有效值。 
 
(b) 25次諧波各式功率。 
 
(c) 27次諧波電壓及電流有效值。 
 
(d) 27次諧波各式功率。 
 
(e) 29次諧波電壓及電流有效值。 
 
(f) 29次諧波各式功率。 
 
(g) 31次諧波電壓及電流有效值。 
 
(h) 31次諧波各式功率。 
 
(i) 33次諧波電壓及電流有效值。 
 
(j) 33次諧波各式功率。 
 
(k) 35次諧波電壓及電流有效值。 
