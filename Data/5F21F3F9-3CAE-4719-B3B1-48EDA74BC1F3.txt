2行政院國家科學委員會專題研究計畫成果報告
一個調降解析度與高品質轉換 JPEG 連續靜態影像為 H.264/AVC
視訊串流之方法
計畫編號：NSC 98-2221-E-155-056-
執行期限：98 年 08 月 01 日 至 99 年 07 月 31 日
主 持 人：林啟芳 元智大學 資訊工程學系
計畫參與人員：張揚政 元智大學 資訊工程學系
計畫參與人員：李宗明 元智大學 資訊工程學系
計畫參與人員：林彥寬 元智大學 資訊工程學系
一、中文摘要
本計畫提出修正開放式架構的方法，將 JPEG 影像
轉換為 H.264 的視訊串流，除能保留原來 JPEG 的
高品質影像外，並且具備低複雜度與快速轉換的特
性。所提方法可解決轉換過程中所遭遇的問題，包
括畫面模式的選擇、宏塊模式與區塊模式的選擇、
整數轉換的問題、色彩模式的轉換、量化選擇、及
預測值問題。除此之外，我們也討論可能導致轉換
失真的原因。最後，實驗結果將驗證所提方法的優
越性。
關鍵詞：格式轉換、視訊串流、開放式架構。
二、緣由與目的
近幾年隨著網路基礎建設的普及與數位傳輸
技術的進步，帶動以提供視訊(video)為主的服務網
站出現，例如 Youtube (www.youtube.com)網站，可
以提供給訪客上傳或下載視訊資料，滿足人們對視
訊瀏覽所產生娛樂效果的需求，因此 Youtube 在短
時間內就吸引大量瀏覽人潮成為熱門網站。但由於
影片的龐大視訊串流造成資料儲存、視訊傳送、網
路頻寬等諸多問題出現，這些問題都迫切需要得到
解決。另一方面，以串流格式為主的網路數位視訊
錄影(Network Digital Video Recorder；NVR)，逐漸
成為安全監控產業的主流，取代傳統以 JPEG 影像
壓縮模式為主的安全監控系統。後者雖然可以提供
高品質的監看影像，但在網路有限傳輸頻寬的條件
限制下，無法順暢瀏覽視訊而逐漸被 MPEG-4 及
H.264 [1,2]等串流格式所取代。另外一項因素是
JPEG 影像壓縮模式無法在一般播放器（例如
Realplayer 或 MediaPlayer）上播放，也無法以 3G 手
機來瀏覽，因此在未來發展上受到很大的限制。
相較於 MPEG-4 或 H.264，JPEG 雖然有上述缺
點與限制的存在，但仍具有下列競爭優勢：(1) JPEG
的相關技術發展較早所以成熟度與穩定性高；(1)
JPEG 影像品質極佳，對後續發展智慧視訊辨識系統
較具優勢；及(3) JPEG 晶片製作成本低且體積相對
較小，在某些產業上仍具有不被取代的地位，例如
PC Camera (or Web Camera)，目前仍舊採用 JPEG 壓
縮晶片。在網路攝影機(IP Camera)產業上，目前的
發展現況是以提供多種壓縮格式（多模）為主，例
如雙模（JPEG 與 MPEG-4）或三模（JPEG、MPEG-4、
與 H.264）。設計多模的目的是內部網路儲存選擇影
像品質較佳的 JPEG 格式，而外部網路傳輸則採用
瀏覽較順暢的 MPEG-4 或 H.264 格式。發展多模與
多解析度的網路攝影機，是未來監控產業的發展趨
勢。
本計畫的主要目的是提出格式轉換(transcode)
的方法，在維持影像品質的前提下，將靜態影像格
式(JPEG)轉換為視訊串流格式(H.264)。所發展技術
可應用在傳統監控設備或網路攝影機，達到高品質
的儲存影像與瀏覽順暢的傳輸要求，並可在一般播
放器或 3G 手機上瀏覽。
基本上，JPEG 壓縮格式是設計用來壓縮單張
靜態影像，而 H.264 為多媒體串流的壓縮格式，兩
者之間的轉換最直接的作法是將 JPEG 影像解壓縮
後再以 H.264 方式重新編碼，但如此一來會浪費大
量的轉換時間，且重複編碼會導致影像品質流失，
因此我們不採用此種作法。為維持高品質影像的要
求，上述重複壓縮的作法必須排除。目前較少論文
有針對兩者格式提出轉換方法，但仍有許多相關的
文獻研究提供參考。下列文獻瀏覽可分為 H.264 區
塊轉換相關研究及格式轉換的研究，內容敘述如
下。。
在 H.264 的區塊轉換相關研究中，H. S. Malvar,
A. Hallapuro, M. Karczewicz, and L. Kerofsky[3]對於
H.264 底層轉換與量化方式做詳細介紹。他們提出轉
換公式將傳統 88 區塊 (block)的離散餘旋轉換
(Discrete Cosine Transform; DCT) 推導到 H.264 中的
44 區塊的 DCT，並且使 44 區塊在運算上能避
免乘除法運算，僅需做位移動作 (shift operation) 和
加法運算即能完成轉換功能。V. Patil and R. Kumar
[4]提出能在 DCT 空間對 H.264 做運算，並改變
H.264 串流影像解析度大小的方法。J. Xin, A. Vetro,
and H. Sun [5]推導一個 88 DCT 區塊轉成四個
44 H.264 整數轉換區塊的轉換公式。Z. He and M.
4處理時會遭遇到一些問題，這些問題包括：(1)畫面
模式(picture type)的選擇；(2)宏塊(macroblock)模式
與區塊(block)模式的選擇；(3)整數轉換的問題；(4)
色彩模式的轉換；(5)量化選擇；及(6)預測值問題。
每一項問題都必須妥善處理，否則無法正確進行
H.264 的量化與編碼處理。細節於下各節中說明。
(1) 畫面模式選擇
首先說明 JPEG 靜態影像在轉換為串流格式
時，我們所選擇的畫面模式。在轉碼架構(transcoding
architecture)的選擇上，我們採用開放式架構，理由
是此架構的計算複雜度低，能降低轉換所需處理時
間。但開放式架構最大問題在於有參考失真(drift)的
問題[10]，即參考 P 畫面(Predictive-coded picture)和
參考 B 畫面(Bidirectionally predictive-coded picture)
會受到前面畫格失真的影響而產生更差的結果。然
而對 I 畫面(Intra-coded picture)而言，不管採用何種
轉換架構均能得到很好的效果。為了達到快速轉換
並維持高影像品質，本計畫提出在格式轉換的過程
中，將轉換結果(即 H.264 畫面)均設定在 I 畫面。依
照 H.264 規格書所定義，滿足所有畫面均為 I 畫面
的配置文件 (profile)共有四種，分別為 High 10
Intra、High 4:2:2 Intra、High 4:4:4 Intra、及 CAVLC
4:4:4 Intra。選擇上述四種配置文件，除了可以解決
因轉碼時畫面間動態預測(inter prediction)必須耗費
巨大的時間消耗外，同時也能避免上述參考失真的
問題產生，並讓轉碼過程簡單化。因此我們使用上
述四種規格做為 H.264 的畫面模式選擇。
(2) 區塊模式選擇
在格式轉換中，每一個 88 的 DCT 區塊必須
決定對應到 H.264 的何種預估宏塊(macroblock)，及
所採用動態預估區塊中的何種預估模式。以 H.264
的畫面內預測(intra prediction)模式而言，在編碼流
程中，首先需要決定該宏塊所使用的預測宏塊大
小。一般而言，可供選擇使用的有 1616 預測宏塊
( I16MB )、 88 預測宏塊( I8MB )、 44 預測宏塊
( I4MB )、及不預測宏塊( IPCM )四種。決定預測宏
塊大小後，計算預測宏塊所提供的每個模式，選擇
一個差異值最小的模式做為該宏塊的預測模式。
在 H.264 的眾多編碼程式中，JM 是 H.264 官方
認可的開放原始碼之一，也是最常被使用在學術研
究與公開討論的用途上，所以又稱為校驗模型
(model calibration)。JM 的特性是支援度高但實用性
差(編碼速度緩慢)。以 JM 14.2 的版本而言，使用單
一預測宏塊可以加快編碼速度，而使用混合預測宏
塊(例如混合使用 I16MB和 I8MB或混合使用 I16MB
和 I4MB）則可得到較佳的壓縮率。
選擇好的宏塊模式能得到壓縮效果較佳的
H.264 檔案，然而選擇模式的過程卻會需要額外的計
算與時間花費。本計畫所擬定的目標重點，在於快
速封包轉換及維持 JPEG 的高影像品質。若在轉換
封包時，使用大小可調整的宏塊(macroblock)與區塊
(block)，雖能得到較小的輸出檔案(壓縮效果好) ，
但處理時間卻會增加。我們考慮在 JPEG 中所解得
DCT 區塊的大小為 88 ，而一個宏塊的大小為
1616 ，使用 I8MB 宏塊剛好可以切成四個 88 區
塊，在編碼時無需再做額外的變更運算，因此在轉
換一致性和效能取捨的考量下，我們選擇每個畫面
內預測區塊均設定成 I8MB 宏塊。
在決定使用 I8MB 做為預測宏塊大小後，我們
觀察在九種 88 區塊的預測模式中，其中 DC 模式
在計算預測值時，必須計算上方相鄰 88 區塊最下
一列(the Bottom Most Row; BMR)的平均，和左方相
鄰 88 區塊最右一行(the Right Most Column; RMC)
的平均，在本計畫中都有列出對應公式來計算結
果。相較其餘八種預測模式，DC 模式比較容易快速
取得預測值。由於我們不希望在轉碼過程中，花費
太多時間去做九種參考模式的分析，因此我們選擇
DC 模式作為區塊的預測模式。
(3) 整數轉換問題
H.264 轉換到頻率域可分為 44 整數轉換與
88 整數轉換兩種。早期規格書中並沒有列出
88 區塊的轉換方式，因此許多研究，例如 J. Xin,
A. Vetro, and H. Sun [5]，提出將帶有小數的 DCT 區
塊轉為 44 IDCT(整數離散餘旋轉換 )區塊的方
法。Z. He and M. Bystrom [6]對上述轉換方式提出進
一步改進效能的做法。在使用開放式架構的轉換
中，JPEG 原本使用的轉換區塊即為 88 大小，因
此直接沿用 DCT 區塊是一個最簡便與省時的做法。
(4) 色彩模式的轉換
JPEG 所使用的色彩模式一般為 YCbCr，而
H.264 所使用的色彩模式則稱為 YUV。針對 JPEG
轉換到 H.264 色彩模式在轉換中是否需要作調整，
在這裡說明如下。YUV 格式是在 80 年代由新力
(SONY)公司所發展出來的視訊格式，將訊號資訊分
成三個頻道，分別是 Y（亮度）、U（藍色色差）、
及 V（紅色色差）。發展成熟之後，YUV 規格成為
傳統類比電視的主要規格，但是不同國家對於 YUV
的計算方式還是存在不同之處，大致上分為歐規
(PAL)、美規(NTSC)、及法規。在電視訊號朝數位
化轉變時，YCbCr名稱出現並且開始制定標準，轉換
到數位化的取樣過程有個重要因素被考慮，在於人
眼對明暗變化敏感程度高於顏色變化，感官上的敏
感曲線大致呈現對數分佈，因此對 YCbCr 規格做相
對應調整。因此可以說，YCbCr是 YUV 色度的一種
經由不同縮放及抵補的版本。在電腦中做封包轉
換，對於 H.264 與解到 DCT 係數的 JPEG 而言，兩
者的色域空間同屬數位化 YUV 規格。對數位化資料
而言，YUV（或 YCbCr）對於紅(R)、綠(G)、藍(B)
三個顏色分量有著相同比重的轉換，轉換公式會遵
守 BT.601 或 BT.709 等協定，因此省略色彩轉換模
式的選擇並不會影響整體轉換的正確性。
(5) 量化選擇
JPEG 使用的量化表隱藏在標頭檔(header file)
中，允許使用者採用自行定義的區塊量化方式。而
在 H.264 中，量化表是搭配整數轉換使用，分為 0
到 51 個量化依據(QP)，QP 設定愈高則壓縮率愈
高，但得到的壓縮品質愈差。在本質上整數轉換與
量化運算是相互配合來完成彼此工作。JPEG 解碼
所得到的 DCT 區塊，當 QP = 4 時，正好相等於
H.264 的區塊，而在 H.264 的量化意義即代表不做
量化。對於 H.264 的其他量化值而言，DCT 區塊雖
64M 之上方區塊，及以 3M 取代 3M作為 4M 之左方
區塊，存在解碼端的上方區塊(即 2M)與左方區塊
( 即 3M ) ， 因 此 預 測 值 設 定 為
4)8)()(( 32  MRMCMBMR 。
如上所述可以得知，由於無法使用 iM的資訊
來協助預測值的取得，導致所取得的預測值與真實
的預測值會有差異而產生失真。但藉由上述方法的
處理，可以降低預測值失真所造成的影響。
H.264 所使用的整數轉換是由修正 DCT 轉換
公式而來，為了達到整數運算的優勢，實際 H.264
轉換的結果並不完全等於修正前的 DCT 區塊，所以
在反轉換時，這項差異會造成解碼時的失真。
H.264 共有三種編碼方法，分別是(1)基於上下
文的二元算數編碼（CABAC）；(2)基於上下文的變
動 長 度 編 碼 （ CAVLC ） ； 及 (3) 指 數 哥 倫 布
（Exponential-Golomb）編碼。指數哥倫布編碼主要
用於編碼控制參數，或用於編碼語法元素例如量化
參數、移動向量(motion vector)、及參考畫面索引
(reference frame index)等。對於實際需要編碼的影像
資訊內容，會在 CABAC 或 CAVLC 二者擇一使用，
而這兩種編碼方法均採整數型態的編碼方式。H.264
為加速編解碼的處理時間，因而採用整數型態的運
算，例如在時域(time domain)轉為頻域(frequency
domain)的核心轉換或是量化處理，都是採用整數運
算，因此不會有浮點數的進位或捨棄的誤差。但在
所提方法中，取得 JPEG 的 DCT 區塊內容是浮點數
型態，不論是先採四捨五入轉換為整數型態，或是
經過預測值的運算後再做四捨五入轉為整數型態，
都是屬於強迫轉換方式而產生進位或捨棄的誤差，
導致失真問題的發生。
在 H.264 畫面內預測( intra-prediction )中，如果
依照完整的編碼流程去轉換，每個宏塊的正確性不
會因為畫面內預測而產生任何失真，可確保 I 畫面
的品質。然而在所提修正之開放式轉換架構中，前
面宏塊(macroblock)所產生的輕微失真，就有可能在
計算下一個宏塊時，產生預測值上的錯誤，而造成
接下來連續宏塊錯誤的累積。這種因錯誤累積所導
致的畫面失真，尤其在高解析影像的轉換過程中會
更加明顯。
上述的失真產生原因都是無可避免的，也都會
多少對最後結果產生影響。在下一章的實驗結果
中，可以看出這些失真將導致最後結果的影像品質
降低。但即便如此，整體而言都還在可接受的範圍
內。對於最後一項失真(即錯誤累積)，在高解析影像
的轉換上的確會有較明顯的影響。如何在格式轉換
的處理過程中消除錯誤累積，是未來研究的一個主
要課題。
我們以實驗結果來展示所提方法在轉換速度
與高畫質的優勢。實驗中所採用的設備包括個人電
腦 AMD Athlon 64 X2 Dual Core 4800+， 2GB DDRII
記憶體，系統環境為 Microsoft Windows XP SP3。
JPEG 解碼使用開放原始碼組織 Saillard [30]所開發
的解碼程式( TinyJPEG Decoder )。H.264 編碼與解碼
之比較使用 JM 14.2 [31]參考軟體，其中使用 JM 做
編碼時，調整參數檔案( encoder.cfg )的幾個重要設
定如表 1(共用參數之設定)及表 2(搜尋參數之設定)
所示。最後所提方法之撰寫語言為 Dev-C++。
所提方法在比對品質時使用三種檢驗方法，分
別為 PSNR (Peak Signal-to-Noise Ratio ) 、 UQI
(Universal Quality Index; UQI)[32]、及 MSSIM (Mean
of Structural Similarity Image Measurement; MSSIM)
[33]，而比較方式為比對原始 JPEG 解碼得到的 YUV
檔案，與轉換後 H.264 解碼得到的 YUV 檔案，比較
兩者之間的差異。PSNR 是常見的影像品質檢測方
法，單位為 dB。PSNR 值愈大代表失真愈少。基本
上 PSNR 值大於 30 以上，則人的視覺感官就不太會
察覺有差異性存在，而 PSNR 值大於 40 以上，則人
眼幾乎無法分辨其差異。結構相似度影像評估(SSIM)
是一種計算相似度的做法，用來判斷兩張影像是否
相似，是一種客觀的影像品質評量方法。SSIM 能改
善傳統檢測方式如 PSNR 或 MSE 等方法的缺點，後
者的缺點是易受雜訊影響計算結果且無法考慮人眼
主觀敏感區的感受[34]。SSIM 檢測使影像品質能更
符合人眼的感官曲線。SSIM 值越接近 1 代表測試影
像品質越好。
本計畫計算結構相似度時使用 UQI 與
MSSIM，兩種測量值都是代表一群 SSIM 之平均值。
作法是將影像A及影像B分別切割成M個 pp 大
小相等的視窗(window)，對此 M 個視窗分別計算其
SSIM 值後再予加總。在本實驗中，UQI 的 p 值設定
為 8。UQI 的定義為



M
j
jSSIMM
UQI
1
1 . (2)
MSSIM 與 UQI 作法相似，但在計算視窗上加入
了權重的概念，能避開 UQI 可能產生區塊效應
(blocking effect)的缺點。MSSIM 計算各分割視窗的
SSIM 值時，視窗內的每一個像素依所在位置做權重
分 配 ， 權 重 值 採 高 斯 對 稱 權 重 函 數 (circular
symmetric Gaussian weighting function)
},...,2,1|{ ppigG i  ，其中高斯函數的標準差
設定為 1.5，且加以正規化使權重總合為 1(即




pp
i
ig
1
1)。MSSIM 在本實驗中 p 值設定為 11。
我們對下列四種轉碼方式做比較，分別為(1)
使用串聯式架構的 JM_FullSearch；(2)使用串聯式架
構的 JM_FastSearch；(3)使用修正式開放式架構且驗
算精準度設為 0；及(4)使用修正式開放架構且驗算
精準度設為 64。為方便起見，四種方法依序簡稱為
JM(I)、JM(II)、所提方法(0)、及所提方法(64)。實驗
結果對轉換所需時間、壓縮資料大小、及壓縮品質
分別作比較。
測試圖分為三組測試圖，皆為 JPEG 影像。第
一組與第二組之壓縮品質設為 94，來源為數位相機
所拍攝的影像。第三組之壓縮品質設為 70，來源為
AXIS 網路攝影機所拍攝影像。每組影像均有四種解
析度，分別為 QCIF (176x144)、CIF (352x288)、VGA
(640x480)、及 4CIF (704x576)。
表 3將三組測試圖片的轉換所需時間列出。JM(I)
在轉換速度上表現最慢，JM(II)在轉換速度上略優於
8VLD (Q1)-1 IDCT
MC FrameStore
DCT Q2 VLC
MC FrameStore
(Q2)-1
IDCT
+
+ ++
-
圖 1、影像壓縮格式相互轉換之串聯式架構。
VLD (Q1)-1 (Q2) VLC
圖 2、影像壓縮格式相互轉換之開放式架構。
VLD (Q1)-1
DCT
Q2 VLC
MC FrameStore
(Q2)-1
IDCT
+
+
+
_
+
圖 3、影像壓縮格式相互轉換之封閉式架構。
圖 4、原始之開放式架構(無預測值)的轉換結果。 圖 5、修正之開放式架構的轉換結果。
10
DisableIntra16x16 1 DisableIntra16x16 0
DisableIntraInInter 1 DisableIntraInInter 0
Intra4x4ParDisable 1 Intra4x4ParDisable 0
Intra4x4DiagDisable 1 Intra4x4DiagDisable 0
Intra4x4DirDisable 1 Intra4x4DirDisable 0
Intra16x16ParDisable 1 Intra16x16ParDisable 0
ChromaIntraDisable 1 ChromaIntraDisable 0
SearchMode -1 (Full) SearchMode 0 (Fast)
表 3、格式轉換之時間分析(單位：秒)。
第一組
JM(I) JM(II)
所 提
方 法
(0)
所 提
方 法
(64)
QCIF 1.765
0.169
5
0.01
5 0.14
CIF 6.856 4.916
0.82
8
0.89
9
VGA
17.38
4
13.43
2
1.76
5
1.82
8
4CIF
20.45
4
17.63
3
2.29
3
2.43
7
( 第 二
組)
JM(I) JM(II)
所 提
方 法
(0)
所 提
方 法
(64)
QCIF 1.933 1.395
0.07
2
0.15
6
CIF 6.532 5.214
0.54
6
0.56
2
VGA
19.07
4
15.45
1
1.67
1
1.87
5
4CIF
24.85
9
20.36
1
2.20
3 2.39
( 第 三
組)
JM(I) JM(II)
所 提
方 法
(0)
所 提
方 法
(64)
QCIF 1.272 1.045
0.02
5
0.15
6
CIF 4.895 4.052 0.5
0.65
6
VGA
12.30
8
10.13
8
1.92
1
2.12
5
4CIF
15.65
5
15.68
6
2.40
6
2.71
8
表 4、三組測試圖之 PSNR 分析。
第一組
JM(I) JM(II)
所 提
方 法
(0)
所 提
方 法
(64)
QCIF
58.25
1
57.33
3
37.3
6 41.8
CIF
58.02
4
57.98
8
39.1
5
36.9
7
VGA
58.66
7
58.40
1
35.5
1
30.3
8
4CIF
58.58
8
58.45
1
31.0
9
31.4
8
( 第 二
組)
JM(I) JM(II)
所 提
方 法
(0)
所 提
方 法
(64)
QCIF
58.74
1
57.23
8
36.2
1 41.3
CIF
58.66
7
57.83
3
34.5
3
36.3
4
VGA
58.87
1
58.29
6
33.6
4
31.2
8
4CIF
58.78
5
58.38
6
31.2
7
30.0
4
( 第 三
組)
JM(I) JM(II)
所 提
方 法
(0)
所 提
方 法
(64)
QCIF
58.54
7
57.91
6
38.3
6 41.5
CIF
58.27
2
58.54
7
37.9
5
36.7
7
VGA
59.06
3
59.00
2
35.8
4
32.6
1
4CIF
59.20
4
59.23
2
38.5
7
33.9
1
無衍生研發成果推廣資料
其他成果 
(無法以量化表達之成
果如辦理學術活動、獲
得獎項、重要國際合
作、研究成果國際影響
力及其他協助產業技
術發展之具體效益事
項等，請以文字敘述填
列。) 
無 
 成果項目 量化 名稱或內容性質簡述 
測驗工具(含質性與量性) 0  
課程/模組 0  
電腦及網路系統或工具 0  
教材 0  
舉辦之活動/競賽 0  
研討會/工作坊 0  
電子報、網站 0  
科 
教 
處 
計 
畫 
加 
填 
項 
目 計畫成果推廣之參與（閱聽）人數 0  
