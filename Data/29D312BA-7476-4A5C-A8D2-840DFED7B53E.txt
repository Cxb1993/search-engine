2結案報告大綱
結案報告大綱..................................................................................................................... 2
摘要..................................................................................................................................... 4
Abstract ............................................................................................................................... 5
第一章 第一期計畫目的與成果回顧............................................................................... 6
1.1 計畫目的回顧...................................................................................................... 6
第二章 以效能為導向之層級式 SIP移動性架構之設計............................................... 7
2.1 系統架構.............................................................................................................. 7
2.1.1 服務網域伺服器....................................................................................... 9
2.1.2 代理網域伺服器......................................................................................11
2.2信令設計............................................................................................................. 13
2.2.1註冊程序.................................................................................................. 13
2.2.2 非註冊請求程序..................................................................................... 15
2.3 SIP伺服器軟體 OpenSER................................................................................. 18
2.3.1 配置檔與路由規則................................................................................. 21
2.3.2 SL模組 .................................................................................................... 25
2.3.3 USRLOC模組......................................................................................... 25
2.3.4 REGISTRAR模組 .................................................................................. 27
2.3.5 TM模組................................................................................................... 29
2.4 軟體架構與設計................................................................................................ 29
2.4.1 服務網域伺服器..................................................................................... 30
2.4.2 代理網域伺服器..................................................................................... 34
第三章 基於層級式 SIP移動性架構上之個人化移動性管理機制............................. 36
3.1系統架構............................................................................................................. 36
3.1.1 聯繫管理伺服器..................................................................................... 39
3.1.2 個人化資料庫......................................................................................... 41
3.2 信令設計............................................................................................................ 43
3.2.1 1-to-n模式信令交換程序....................................................................... 43
3.2.2 n-to-1模式之信令交換程序................................................................... 47
3.3軟體架構與設計................................................................................................. 48
3.3.1 聯繫管理伺服器..................................................................................... 48
第四章 開發一支援會議移動性之環境感知伺服器..................................................... 52
4.1 系統環境............................................................................................................ 52
4摘要
本子計畫將以效能為導向，針對會談起始協議之移動性架構，實現終端機移動
性與漫遊機制，在這個架構上業者可以彈性地增加元件用以擴充服務或用戶群，並
自由地規劃服務網域下的用戶分群方式，且此架構依然保留了會談起始協議之高擴
充度的特性；此外並以服務為導向，針對個人化移動性設計一管理機制，此機制以
群播方式實現請求分叉，用以改進單點傳送上耗費網路層資源的缺點，並為位址伺
服器加入了動態映射的位址記錄更新方式，預期可以提供例如環境感知等更多元化
的服務。
接著我們設計出一套環境感知伺服器，用來支援環境感知的應用，並採用集中
式的方式收集與管理環境資訊，採用這種方式的好處是面對龐大的環境之下，這樣
的機制設計可以更有效率的管理與處理環境資訊，並具有即時更新環境資訊的好
處。此外除了考量使用者移動到不同環境後，所需要的服務不盡相同，甚至希望能
延續先前的服務，不因為外在環境的改變被中斷，因此結合 SIP協定中的會議移動
性(Session Mobility)服務，讓使用者可以在任何地方，使用任何裝置不中斷原先的會
談。
關鍵詞：網路語音傳輸技術、會談起始協議、終端機移動性、漫遊、個人化移動性、
環境感知、SIP、會議移動性
6第一章 第一期計畫目的與成果回顧
1.1 計畫目的回顧
因為本計畫原本預期是三年，但只通過一年了原本預期，不過實際上在這一年內，
我們幾乎完成了前二年該達到的進度，故我們列出前兩年預期完成之工作項目及成
果。請分年列述如下：
第一年預期完成以SIP 信令為基礎之多媒體串流服務。以下幾項將是我們這一年之
研究工作項目：
 H .264 語音影像壓縮技術及其他語音壓縮研究與編解碼程式追蹤修改
 其他多媒體 Audio/Vedio codec: include G.723,MPEG-4
 MPLS technology background (與所有子計畫相關)
 MPLS Traffic Engineering(與所有子計畫相關)
 Diffserv與MPLS整合
 Content Delivery and distribution technology
 Network processor (Monta Vista Linux OS)
 Multimedia Capture, delivery and content management
 以 DirectX、DirectShow 及 Visual C++ 程式語言實現一使用者終端多媒體
播放器並掛載 H.264影音 Codec及 SIP解譯器
 整合 SIP 信令與 RTSP 串流控制達成使用者應用程式對於多媒體的完整實
現
 進行 SIP信令之相關 RFC及其他文獻研讀
 撰寫研究報告與資料整理
第二年預期完成工作為設計工作並實現以SIP信令為溝通基礎之各項信令流程。以
下幾項將是我們第二年之研究工作項目：
 建置 SIP Proxy, SIP Registra, Application Function等重要 SIP 協定相關模組
 設計與實現以 SIP為基礎來支援應用層移動性的信令流程
8合，本身並非 SIP所定義的元件，不過其設計目的是提供 SIP服務用，例
如位址伺服器即屬於這個類別的伺服器。
 延伸服務代理伺服器。此類別為多個 SIP伺服器之集合，可以是媒體閘道
器、會議伺服器、代理伺服器等其他 SIP元件。此類別中的代理伺服器為
特殊用途，並非一般 UA的對內/對外代理伺服器。
層級一的服務對象為服務網域下的所有終端設備，主要角色為外部網域對此網
域的聯繫點(contact point)、服務網域下的用戶管理、服務網域下的延伸服務之提供，
並且服務網域對外的連線也必須經由層級一取得外部資訊。由於此層級涵蓋的用戶
與主機相當多，因此在信令設計的重點上以效能與負載分散為主要考量。
層級二為多個代理網域伺服器(Proxy Domain Server)之集合，每一個代理網域伺
服器負責掌管一個代理網域(Proxy Domain)且隸屬於一個服務網域，這些代理網域
分別涵蓋與掌管各自的用戶端(層級三)，代理網域的範圍通常是靜態設定的。代理
網域伺服器角色為擔任代理網域的對內/對外代理伺服器，除了代理的工作之外不會
負責其他工作。
圖 2- 1 層級式 SIP移動性架構圖
層級三為用戶端，可為用戶終端機或是其他用戶主機，這些主機為非 SIP標準
元件，但可用於延伸 SIP 服務。每一個 SIP UA同一時間只座落於一個代理網域，
意即被一個代理網域伺服器所掌管。
10
轉送作法，對於內部的請求為了處理通話計費等細節因此需要以全狀態代理模式來
掌握通話時間與狀態(當內部請求目的為同服務網域時則採用重新導向的作法來大
幅減輕服務網域伺服器的負擔，而通訊記錄的工作可交由代理伺服器負責)；而外部
網域的請求不需由本網域做紀錄，因此採用重新導向的作法用以節省伺服器資源。
層級一的位址伺服器並不屬於服務網域伺服器內部的 SIP元件，不過其設計與
服務網域伺服器息息相關，架構上服務網域伺服器並不會直接接受 UA的請求，也
不會去干涉代理網域的涵蓋範圍，因此服務網域伺服器並不會真正瞭解自己的網域
涵蓋了哪些 IP 網路與 IP 網域，它只在意隸屬於自己的代理網域伺服器有哪些，而
這些伺服器的服務範圍就構成自己的服務網域，因此層級一的位址伺服器不會維護
UA 所在的詳細地點，只會記錄 UA 位於哪一個代理網域的管轄內，當請求傳送到
代理網域時再由代理網域伺服器轉送到 UA真正的位址。層級式的設計在來源過濾
上顯的更加益於管理，如圖 2- 3，服務網域伺服器可以設定接受本身服務網域下的
所有代理網域伺服器、以及其他信任的服務網域伺服器的 SIP訊息，當來源端不屬
於上述的任何網路位址時，可以完全不受理，甚至可以在網路層防火牆即刻丟棄該
封包，不論網路層或會議層的存取控制上都相當有效率，讓伺服器致力於該作的服
務。
圖 2- 3服務網域的來源過濾機制
位址伺服器將維護兩個主要的表單，分為別 HUT(Home User Table)與
FUT(Foreign User Table)，HUT用來維護隸屬於本服務網域的用戶位址；FUT用來
維護屬於其他服務網域而漫遊到此網域的用戶位址。分離原屬用戶與他網用戶的主
12
圖 2- 5 代理網域示意圖
代理網域伺服器包含了兩個 SIP元件：代理伺服器與位址伺服器，當 UA移動
到該網域下時，該伺服器則為 UA的對外/對內代理伺服器，在接受且轉送 UA的註
冊訊息給服務網域伺服器之前會記錄 UA 的實際位址到位址伺服器元件的
PDT(Proxy Domain Table)，位址伺服器通常不會以資料庫的型態存在，而是記錄於
實體記憶體，用以加快層級二的映射速率。代理網域伺服器並不在乎網域下的用戶
是否為服務網域的原屬用戶，因為那是屬於層級一所掌握的資訊，關於用戶的認證
動作一律交給服務網域來處理，在表單設計上把用戶資訊全部紀錄到 PDT，雖然比
對速度比服務網域伺服器較慢，不過由於減少了對用戶識別的步驟，因此加快層級
二的轉送速度，而這也是層級二的職務上較迫切加強的；除此之外，當服務網域支
援多重網域時(Multiple Domain)，層級二對於用戶原屬網域的忽視特點才不會增加
其實現複雜度。
在代理網域伺服器設置位址伺服器元件，除了讓服務網域更容易管理來源過濾
之外，還有兩個優點：
 微移動性(micro mobility)的快速註冊。當 UA 發生終端機移動性時，重新
註冊的訊息將傳送給同一個代理網域伺服器，而代理網域伺服器將察覺
UA 發生微移動性，因此註冊訊息不需要再轉送給服務網域伺服器，這讓
14
圖 2- 8微移動性(micro mobility)的快速註冊
圖 2- 9為終端機在跨代理網域的註冊流程，與終端機微移動性的差別在於移動
之前的代理網域伺服器內的 PDT之位址記錄移除，說明如下：
圖 2- 9 代理網域的終端機移動性
(1) UA 原本位於右邊的代理網域，並完成註冊程序，之後移動到左邊的代理
網域，UA透過 DHCP了解發生了終端機移動與得知所在的代理網域伺服器位置，
對其發送註冊訊息，而代理網域伺服器接收註冊訊息的處理流程(process-A)則如同
圖 2- 7所描述。
(2) 服務網域伺服器接收到代理網域的註冊訊息時 (process-B)，根據
Request-URI分辨註冊者為自己的原屬用戶，且經查詢過後發現 UA先前已經註冊於
右側的代理網域，因此要求位址伺服器對 HUT做修改，更新該 UA的新位址，並回
應 200 OK給代理網域伺服器。
圖 2- 10為跨網漫遊的系統信令交換過程，關鍵在兩個服務網域伺服器的溝通
與使用者認證。在此案例中上方的服務網域為 UA的原屬網域，而上下方兩個服務
16
時，透過 PDT的查找可以得知接聽者位於同一個代理網域，因此伺服器會直接將請
求轉送給接聽者。與註冊程序不同的是，代理網域伺服器在處理非註冊請求的轉送
方式會以交易基礎來轉送，因此在圖 2- 11 中的構成一個交易的四個 SIP 信令中
(INVITE、180 ringing、200 OK、ACK)，只有 INVITE需要作 PDT的查找動作(100
Trying 的信令並不需要作轉送)，這樣的設計讓 INVITE 的交易節省了 3 次的 PDT
查找程序(process-A、process-B與 process-C)，即使在其他的 SIP請求交易中也可以
節省至少一次的 PDT查找程序。
圖 2- 11 同代理網域的請求程序
圖 2- 12的案例為呼叫者與接聽者處在同一個服務網域但不同代理網域的呼叫
流程，圖中的 UA-1與 UA-2都為該網域的原屬用戶。其說明如下：
(1) 服務網域伺服器收到 SIP 請求(process-B)，取出 Request-URL 去位址伺服
器的 HUT作查詢(若 UA-2為非原屬用戶則查找 FUT)，得知 UA-2的位址之後回傳
302 move訊息要求代理網域伺服器作重新導向。
(2) 接聽者所在的代理網域收到請求(process-C)後，查詢 PDT 得知接聽者位
址，並以交易模式轉送請求給接聽者。
18
(1) 當 UA-1的服務網域接收到請求時(process-A)，根據 Request-URI得知接聽
者不屬於自己的用戶，因此先查詢 FUT是否在本身網域，查無資料後向 DNS伺服
器求得 UA-2的原屬網域位址，並以交易模式轉送此請求。
(2) UA-2 的服務網域接收到該請求時(process-B)，查詢 HUT 找出 UA-2 所在
的代理網域，要求 UA-1的服務網域伺服器作重新導向。
2.3 SIP伺服器軟體 OpenSER
建構一個以 SIP為基礎的移動性 VoIP環境，除了 IP網路的建置外，最重要的
就是挑選一個容易開發且具彈性、易維護的 SIP 伺服器軟體，OpenSER是一個成熟
且具高度彈性的開放原始碼(open source) 之 SIP 伺服器，於 2005 年六月自 SIP
Expiress Router(SER)專案中獨立出來，不同於 SER的是，OpenSER的開發取向是以
開放原始碼社群為主，在模組選料、程式風格和修正更新等題目上，採取了更加適
合開放原始碼的模式，而在效能的評估上，最新版本的 OperSER V1.2 與 SER V2.0
在效能表現則是不相伯仲，只是在尖峰期時 ( > 200 傳呼/秒)，SER V2.0 佔用較少
記憶體, OpenSER 則較少延誤撥接。
OpenSER 由 C 語言所撰寫，並無使用其他的 SIP 堆疊 (stack)，適用於
Unix/Linux-like的平台。模組化的結構配置讓 OpenSER能夠選擇扮演 SIP 註冊、位
址、重新導向、代理、即時訊息等多樣的伺服器，並且各人化所需要的特殊功能，
這樣的設計讓 OpenSER的運作更有效率且節省系統資源。表 2- 列出 OpenSER核
心主要的特色，而 OpenSER真正實現的功能性則取決於模組。
特色 說明
Performant SIP (RFC3261) 實現 RFC3261所定義的元件功能與行為
Support for UDP/TCP/TLS 在傳輸層完整支援 UDP/TCP/TLS
IPv4 & IPv6 於網路層支援 IPv4與 IPv6
NAT traversal 於 SIP與 RTP的傳輸都支援 NAT穿越
Replication 支援複製 SIP 訊息的功能
Modular architecture/
plug&play module interface
模組化的結構配置能易於延伸功能，且不需要更
改核心配置，讓核心運作更穩定
Scripting language 核心與管理者之間透過命令稿語言(sripting
20
其寫在程式碼內，而是提供一個命令稿語言讓管理者容易的去自訂與修改
一個路由規則，而伺服器再根據這個路由規則決定每一個 SIP訊息的處理
方式。這意味著配置 OpenSER就像設定一台路由器一般。路由規則內可以
針對 SIP訊息作任何的判斷，並作對應的動作，這些動作包含核心的功能
呼叫或是模組的功能呼叫。
 路由規則執行者(Route rule executer)。核心會分析管理者定義的路由規則，
讓每一個 SIP訊息進入伺服器時都經過這些規則來運作，當路由規則呼叫
模組函數時，核心會透過模組管理來執行模組的函數。除此之外核心也提
供了讓管理者藉由命令稿語言來存取 SIP訊息的介面，讓路由規則的功能
更加強大。
 模組管理(Module Management)。系統啟動時，核心會根據管理者在命令稿
語言指定的命令來載入需要的模組並指定引數給模組參數 (module
parameter)，當路由規則呼叫到模組函數時也是透過核心來呼叫。除此之外
模組之間也可以互相呼叫，這些行為都是透過核心的模組管理來達成。
22
時其參數使否合法等，最後進入主迴圈傾聽 SIP訊息。
配置檔依照設定目的可以區分為四個部分：全域配置參數、模組載入、模組參
數與路由規則。其中全域參數(Global parameter)又稱為核心參數(Core parameter)，在
本論文則稱為核心參數，管理者可以對核心參數作設定，這些設定將影響核心的運
作。表 2- 列出與本論文相關的主要核心參數。
核心參數 說明
Check_via 是否偵測路由迴圈(利用 via欄位作檢查)
Fork 指示一個對話是否能有兩個以上的交易
Children 設定若一個 INVITE執行分枝(branch)時最大的分枝數
Advertised_address
當 SIP訊息要轉送出之前填入的 vai欄位，設定其中本伺
服器的位址或網域名稱
表 2- 3 核心參數
第二部分為模組載入。編譯過的模組將會產生.so檔，核心也是以此檔案作模組
的載入，在此部分需告知模組的正確名稱。模組成功載入後才能在路由規則內順利
呼叫。第三部分為設定模組參數。大部分的模組都會對核心登記參數，這些稱為模
組參數(module exported parameter)，模組參數只隸屬於該模組，管理者可以透過模
組參數改便模組的運作行為。
最後一個部分為設定路由規則。用來針對每個 SIP在接收之後，所做的條件判
斷與對應動作。路由規則的運行就像 C語言一般為由上而下由左自右的運作，如圖
2- ，一個路由規則將由名為 route的函數開始(等同於 main函數)，這個函數稱為主
路由區塊(main route block)，而管理者也可以自訂其他的子函數，稱為子路由區塊
(sub-route block)，除了主路由區塊之外其他的子路由區塊亦可以彼此互相呼叫。
24
圖 2- 17 路由區塊的呼叫時機與執行關係
在路由區塊首先就是要對 SIP訊息作判斷的動作，核心提供了數十個核心關鍵
字(Core krywords)與虛擬變數(Pseudo-variables)讓路由區塊對 SIP訊息作判斷，這些
關鍵字與變數可用來確認 SIP訊息在網路層、傳輸層與 SIP訊息中所有欄位的值，
部分的值也可以透過虛擬變數來作變更，各個核心關鍵字與虛擬變數的意義將會在
第三章與第四章使用到時作解說。在路由規則內，當針對 SIP訊息做完判斷之後便
可以決定要對應的工作，這些工作可以靠核心函數(Core function)與模組函數來達
成，其中核心函數並非所有核心所開放的介面，而是某些定義可以用在路由規則內
的核心函數，表 2- 說明了與本論文相關的主要核心函數。
核心函數 說明
Append_branch 對此 SIP訊息強制增加一個分枝
Force_send_socket 強制對此 SIP訊息設定傳送時的 IP位址與埠號
Forward 轉送此 SIP訊息到指定的位址，會增加 via的欄位
Send
將此 SIP運席直接傳送到指定的位置，不會增加 via的欄
位
Resetdsturi 將 Request-RUI設為空
表 2- 4 核心函數
26
位址伺服器最重要的工作是做名稱比對的動作，但是在名稱比對之前必須先找
到是否有符合的位址記錄(AOR, Address Of Record)，若找到符合的位址記錄則將對
應的聯繫(contact，由於中文翻譯容易造成模糊，因此在本論文內皆稱為 contact)取
出，至此完成名稱比對。USRLOC模組在位址記錄的比對有兩種預設模式，分別為
non-use domain與 use domain，在圖 2- 左邊代表 non-use domain；右邊則代表 use
domain的比對方式，在此例中 non-use domain會比對出兩筆資訊，而 use domain僅
會有一組，由此可知在支援漫遊的環境下必須使用 use domain的比對方式。
圖 2- 18 USRLOC模組的位址記錄比對方式
 ul_lock_udomain(domain)、ul_unlock_udomain(domain)。參數 domain 在此
並非 SIP的網域，而是告訴 USRLOC目標的表單，由於一個伺服器會為了
不同服務而建立許多表單，甚至一個 USRLOC模組也可以維護多個表單，
因此需要指定需要存取的表單，讓核心介面透過模組呼叫時能夠辨別。在
存取表單之前都必須鎖定該表單讓其它處理程序無法同時存取，並於結束
存取之後釋放使用權。
 ul_insert_ucontact(record, contact, expires, q, callid, cseq, flags, cont, ua,
sock)。插入一筆新的位址記錄，所有的參數代表指定該位址記錄的值，這
些也是 USRLOC所預設的表單欄位內容，其中 record代表受比對的內容，
而 contact則是當 record比對成功後會回傳的 contact資訊，sock為 IP位址
與埠，代表此位址記錄是屬於哪一個註冊伺服器所管轄。
 ul_get_ucontact (record, contact)、ul_delete_ucontact (record, contact)。取得
28
圖 2- 19 位址記錄更新主要流程
若圖 2- 的位址記錄更新流程執行無誤，則 save 函數將會利用 SL模組回
應一個 200 OK的訊息給上一個請求節點；反之若處理失敗，一個錯誤訊
息的回應也將回傳之，因此在路由規則內，一個註冊訊息的判斷式常隨著
save函數的呼叫而結束。
 lookup(domain)。此函數用在針對一個 INVITE訊息內的 Request-URI作名
稱比對，此函數將根據 Request-URI與位址記錄的比對結果回傳識別碼給
路由規則，比對的模式如同之前介紹，有 use domain與 non-use domain兩
種模式，當比對出符合的位址記錄之後，如錯誤! 找不到參照來源。的流
程，將會更改 INVITE訊息的 Request-URI。當爾後呼叫 TM模組轉送時該
模組就會將此訊息轉送到修改過的 Request-URI的位置。若一個位址記錄
內有多筆的 contact，則此函數會呼叫核心的 append_branch，指定加入有所
contact成為數個分枝，因此分枝請求的紀錄由核心所維護，這些分枝請求
將由 TM模組的 t_relay被呼叫時一併傳送到目的端。
30
服器作探討，在UA的部分只要是遵從RFC3261所設計則完全不需要作任何的變更。
2.4.1 服務網域伺服器
表 2- 列出服務網域伺服器所需要的所有模組與它們的用途，這些模組提供的
函數將會在路由規則裡所呼叫，其中 UAC_REDIRECT只負責 3xx系列訊息的解析，
真正的重新導向則使用 SL模組來達成。
模組名稱 用途說明
REGISTRAR 實作註冊伺服器
SL 處理無狀態回應
TM 用於具交易模式的轉送代理
RR 作 record-route欄位的檢查
MAXFWD 限制訊息最大節點轉送次數
UAC_REDIRECT 實作 302 move解析
URI 讓伺服器可對訊息的 Request-URI作處理
TEXTOPS 讓伺服器可對訊息內的所有表頭欄位作處理
UERLOC 與位址伺服器的溝通介面
MYSQL 與位址伺服器的溝通介面
表 2- 6 服務網域伺服器所載入的模組
模組所需要的參數設定則如表 2- 所示，append_branch與 max_contacts的參數
在於限制服務網域伺服器不去支援多重註冊的服務，服務網域伺服器本身也不支援
分叉代理伺服器，原因在於分叉代理伺服器將佔用伺服器相當大的資源，若將這角
色置放於服務網域伺服將會嚴重影響效能，而多重註冊的功能將於第三章作介紹。
db_mode用於限制位址紀錄的存取全部使用資料庫的模式；use_domain則是要求比
對位址記錄時一併將網域的部分作比對；db_url則是設定位址伺服器的 IP位址與欲
存取的資料庫名稱，而 HUT與 FUT都是存放於同一個資料庫中。fr_timer限制一個
交易在沒有最終回應的等待時間；fr_inv_timer則是限制在 INVITE交易中接收到第
一個暫時回應的訊息後仍沒有收到最終回應的等待時間。若兩者的計時器設定過長
將嚴重佔用伺服器的資源。
模組名稱 參數名稱 參數值
REGISTRAR default_expires 3600
32
圖 2- 20 服務網域伺服器對於註冊訊息的路由規則
在 Process C-1中，首先分析訊息的上一個來源節點是否為所屬的代理網域或合
法的其他服務網域，若皆非則代表這是一個非法的註冊來源。不論來源為所屬的代
理網域合法的其他服務網域，都會則呼叫 save 函數更新 HUT，且通知該用戶之前
註冊的代理網域清除 PDT的位址記錄，不同的是在於 Process D-1會提供原屬用戶
的資訊給該用戶所在的其他服務網域伺服器。
在 Process C-2中，代表一個非原屬用戶移動到了自身網域，原屬服務網域伺服
器會先詢問該用戶的原屬網域與索取其資訊，當該網域認可且回應時，會將用戶的
位址記錄到 FUT，並且改寫註冊訊息的 contact欄位成為自己的 IP位址並轉送到用
戶的原屬網域。而當原屬網域接收到註冊訊息時，其處理流程則為 Process D-1所描
述。
在 REGISTRAR模組中只提供 save函數來作位址記錄的更新，然而由於服務網域伺
34
2.4.2 代理網域伺服器
表 2- 列出服務網域伺服器所需要的所有模組與它們的用途，這些模組提供的
函數將會在路由規則裡所呼叫，除此之外代理網域伺服器不會透過 SL 模組產生任
何 3xx系列的訊息，只會分析網域伺服器的重新導向要求。PDT的儲存媒介則為記
憶體，透過 UERLOC模組亦可對這些位址記錄作存取。
模組名稱 用途說明
REGISTRAR 用以維護 PDT
SL 處理無狀態回應
TM 用於具交易模式的轉送代理
RR 作 record-route欄位的檢查
MAXFWD 限制訊息最大節點轉送次數
UAC_REDIRECT實作 302 move解析
URI 讓伺服器可對訊息的 Request-URI作處理
TEXTOPS 讓伺服器可對訊息內的所有表頭欄位作處理
UERLOC 與 PDT的溝通介面
表 2- 8 服務網域伺服器所載入的模組
模組所需要的參數設定則如表 2- 所示。代理網域伺服器支援多重註冊，因此
append_branch與 max_contacts的參數可以視情況來增減；db_mode指定為 0，讓代
理網域伺服器以記憶體維護於本機的 PDT，用以加快映射的速率；若該代理網域不
接受跨網漫遊的用戶請求，則可將 use_domain設為 0增加映射的速率，但是若代理
網域接受跨網漫遊的用戶請求時則必須設為 1，避免不同網域的客戶有相同用戶名
稱時造成比對不完整而轉送到錯誤的目的地。
模組名稱 參數名稱 參數值
REGISTRAR append_branch 10
REGISTRAR max_contacts 10
USRLOC db_mode 0
USRLOC use_domain 0
TM fr_timer 30
TM fr_inv_timer 120
表 2- 9服務網域伺服器所設定的模組參數
36
第三章 基於層級式 SIP移動性架構上之個人化移
動性管理機制
3.1系統架構
如圖 3- 1所示，在階段一所設計的架構上，階段二新增了兩個伺服器，分別為
聯繫管理伺服器 (Contact Manage Server, CMS)與個人化資料庫 (Personally
Database)。聯繫管理伺服器負責 1-to-n模式的註冊、解註冊等一切有關 SIP 信令的
處理，而個人化資料庫則是用來存放用戶簽訂的資訊，用以讓聯繫管理伺服器取得
資訊並根據條件來運作。此兩個伺服器將在稍後作說明。
圖 3- 1 個人化移動性系統架構
本計畫從三個面向來設計一個目標尋找機制(Target Discovery Policy,以下簡稱
TDP)來實現 1-to-n模式，這三個面向分別為註冊支援模式、請求分叉模式與群組機
制，其詳細說明如下：
 註冊支援模式。由於服務網域伺服器為整個網域的服務入口，其負擔相對
沈重，因此在階段一規劃為僅支援單一註冊；而代理網域伺服器亦保持設
定，支援多重註冊；本階段新增的聯繫管理伺服器則支援多重註冊，但不
接受 UA的動態註冊更新，只接受特定主機的動態通知來更新。
 請求分叉模式。分叉伺服器會請求分枝到 SIP URL 映射到的所有網路位
址，以單點傳送處理請求分叉時，當映射的網路位址有 n筆時就會複製 n-1
38
主機資源的負擔。如圖 3- 3所示，針對所有 SIP URL映射出來的網路位址
作分群，並給予各群組不同的優先權，處理請求時先針對第一個群組作分
枝，若回應逾時則結束這群組的請求並對下一個群組作分枝。
圖 3- 3 輪詢與分叉整合機制
由 TDP的設計面向並結合階段一的規劃之後，可以歸納出 1-to-n模式的運作流
程，如圖 3- 4所示，以一個 UAC邀請一個已申請 1-to-n模式服務的 UAS為例，當
這個請求訊息送達網域伺服器時，該伺服器查詢 HUT，若 UAS 已經註冊則代表用
戶的位置已經確定，因此不需要啟動 1-to-n服務；若用戶尚未註冊，直接將請求轉
送給聯絡管理伺服器，聯絡管理伺服器將根據此用戶的簽訂條約將寫定的數個網路
位址分群，並對最高優先權的群組織內的所有網路位置作請求分叉(這些請求都屬於
同一個交易)，這些請求目的端可能為代理網域或其他服務網域，若為代理網域則傳
送給代理網域伺服器；若為其他服務網域則傳送給該網域的聯絡管理伺服器。當代
理網域伺服器接收到請求之後會直接將訊息以廣播的方式轉送給所有聯絡清單定義
的網路位址，若聯絡管理伺服器的計時器逾時且 UAS 沒有回傳最終回應，則聯絡
40
現 TDP。
 代理註冊。當用戶離線時，代理網域都不會有此用戶的位址資訊，在這樣
的狀況下便無法達成請求的群播機制甚至是單一的請求的轉送，因此在用
戶離線的同時，聯絡管理伺服器會向代理伺服器作註冊的行為，如此當聯
絡管理伺服器轉送請求給該網域時，該網域伺服器就會轉送(或是請求分叉)
到註冊時所指定的位址。註冊的對象也可以是其他服務網域的聯絡管理伺
服器與代理網域伺服器，若兩個服務網域伺服器是彼此信任的，則註冊的
行為完全不用增加服務網域伺服器的負擔便可以達成，在這樣的架構下
1-to-n模式的運行對於服務網域伺服器而言就像是 over layer的概念一般。
圖 3- 5說明了跨服務網域的代理註冊行為，詳細說明如下：
(1) UA進行解註冊的離線動作。
(2) 服務網域伺服器接收到用戶離線的解註冊訊息，通知聯絡管理伺服器
告知該用戶離線。
(3) 聯絡管理伺服器啟動代理註冊服務，首先對服務網域伺服器作註冊，
成為該用戶離線時的聯絡點，接著根據簽訂內容針對網路位址所屬的代理
網域作註冊。
(4) 若簽訂內容包含了其他服務網域，則聯絡管理伺服器會送出通知給該
服務網域的聯絡管理伺服器。
(5) 該網域的聯絡管理伺服器接收到通知後，進行的處理如同步驟(3)所描
述，但不會進入到步驟(4)的處理。
42
個人化資料庫除實現 SIP常見的靜態映射外更支援動態映射，兩者詳述如下：
 靜態映射的清單通常是來自於用戶與業者的簽訂內容，這些內容是可以修
改但是其異動頻率相當低，例如，爸爸與業者簽訂其 SIP URL映射到 3個
實體裝置，其位置分別為家中客廳、個人辦公室與公司實驗室，而這三個
網路位址除了設定各自的預設優先之外，也設定了在不同的時間上所映射
的優先權。當媽媽在上班時間打給爸爸時就會映射到個人辦公室，若無人
接聽會再轉送到公司實驗室，若在下班時間則會映射到家中的客廳；而客
戶打給爸爸時，不論在任何時間都只會映射到個人辦公室。
聯絡管理伺服器會將請求訊息傳送給個人化資料庫，個人化資料庫則可以
取出請求訊息的參數，並進行條件來判斷出當時應該映射與回傳的網路位
址，而這些條件判斷都是靜態的，且取決於業者擬定提供的服務，當用戶
想變更規則或增加判斷參數時則必須手動更改內容。
 動態映射則不會有固定的清單，這些清單將隨事件的觸發不斷的變動，例
如，當用戶沒有簽訂任何的映射位址時，個人化資料庫可以根據該用戶的
使用特性來決定一個請求所要映射的網路位址，這些特性可以根據用戶在
不同實體裝置的最多登入次數、最近登入位址等資訊計來決定，甚至根據
些參數去預測應該映射的單一或數個網路位址，而這些用戶特性的數據可
以對層級一的位址伺服器作存取而取得。
圖 3- 6說明了聯繫管理伺服器、個人化資料庫與其他伺服器間的溝通關係，不
論 UA 註冊與解註冊(A)，這些資訊都會記錄在位址伺服器(B)，且註冊時服務網域
伺服器會通知聯繫管理伺服器(A-1)，這個通知將觸發聯繫管理伺服器對其他伺服器
作代理註冊的動作(C)。而個人化資料庫可以至位址伺服器取得用戶的註冊詳細資訊
(E)。當有請求指向該用戶時，會被轉送到聯絡管理伺服器(D)，並轉送到映射的伺
服器(F)。聯繫管理伺服器除了向個人化資料庫索取映射資訊外，也可以向客戶端的
伺服器索取資訊來達成客製化的服務，不過客戶端的溝通介面必須符合業者所定義
的格式方能順利存取資訊。
44
務網域的服務網域伺服器與代理網域伺服器作代理註冊。
圖 3- 7 1-to-n模式的代理註冊程序
當聯繫管理伺服器完成代理註冊之後，聯繫管理伺服器便可以針對其他呼叫者
對該用的呼叫執行請求分叉，圖 3- 描述了請求分叉的詳細流程，其中被呼叫者的
位址映射到兩個群組，第一個群組有兩個映射位址，都處於 Proxy Domain-A；第二
個群組有四個映射位址，其中兩個映射位址位於 Proxy Domain-A，另外兩個映射位
址位於 Proxy Domain-B，而在整個呼叫接聽者在 Proxy Domain-B下的映射位址作接
聽的動作。其詳細的程序說明如下：
46
(5) Proxy Domain-B接收到請求訊息後，建立一個 SIP交易(Transaction-C)，並根據
PDT 的位址記錄將請求分叉並傳送給兩個網路位址。而其中一個網路位址在 Proxy
Domain-B 與聯繫管理伺服器的交易計時器都尚未逾時之前作了回應，則 Proxy
Domain-B會對另一個網路位址送出CANCEL訊息，並將此交易的確認訊息(200 OK)
回傳給聯繫管理伺服器，當聯繫管理伺服器轉送 200 OK給 UAC也 UAC回應 ACK
之後，會議便成功建立。
映射清單的存取決定請求分叉的內容，在靜態映射上映射清單的存取順序是在
代理註冊與請求分叉之間，而動態映射通常在接受請求後且處理請求分叉之前作映
射清單的存取。圖 3- 描述的是靜態映射清單的存取範例，當聯繫管理伺服器接收
到用戶離線的通知後，會向個人化資料庫索取該用戶簽訂的映射清單，其中包含每
個群組的映射位址清單與其他詳細參數，用以讓聯繫管理伺服器決定請求分叉的順
序，之後查找這些位址清單所對應的服務網域以及代理網域，並對其作代理註冊。
其中 Case1與 Case2是相同的行為，只是清單存取對象分別為個人化資料庫或客戶
伺服器，不過注意的是由於客戶伺服器通常座落於單一代裡網域，因此聯絡管理伺
服器取得的映射清單其位址不會座落於其他網域，因此只會對該代理網域作代理註
冊的動作。圖中最後一個信令為解註冊，這代表聯絡管理伺服器可以在代理註冊之
後且用戶註冊之前任意的對其他網域作解註冊，這樣的設計目的在提供動態映射時
的映射位址調整。
48
3.3軟體架構與設計
階段二的伺服器為聯繫管理伺服器與個人化資料庫，在 UA的部分只要是遵從
RFC3261所設計則完全不需要作任何的變更，而層級三的客戶伺服器其設計原則如
同個人化資料庫。
3.3.1 聯繫管理伺服器
為了完成代理註冊與群組化映射清單的存取，設計了一個註冊產生器並為
OpenSER增加了一個 CM模組，這兩個元件將在稍後作介紹。表 3- 1列出了聯繫
管理伺服器所載入的模組與其用途，其中 REGISTRAR是用來存取個人化資料庫的
映射清單(CAT)，而非用於用戶的註冊處理，因為聯繫管理伺服器並不接受用戶的
動態註冊。模組所需要的參數設定則如表 3- 2所示。
模組名稱 用途說明
REGISTRAR 用以存取 CAT(映射清單)
SL 處理無狀態回應
TM 用於具交易模式的轉送代理
RR 作 record-route欄位的檢查
MAXFWD 限制訊息最大節點轉送次數
URI 讓伺服器可對訊息的 Request-URI作處理
TEXTOPS 讓伺服器可對訊息內的所有表頭欄位作處理
UERLOC 與個人化資料庫的溝通介面
MYSQL 與個人化資料庫的溝通介面
exec 用以執行外部元件(註冊產生器)
表 3- 1 聯繫管理伺服器所載入的模組
模組名稱 參數名稱 參數值
REGISTRAR append_branch 1
USRLOC db_mode 3
USRLOC use_domain 1
USRLOC db_url 個人化伺服器的位址
TM fr_timer 30
TM fr_inv_timer 60
表 3- 2 聯繫管理伺服器所設定的模組參數
50
在 OpenSER的 REGISTRAR模組中，其 lookup函數在作映射時並不會有分群
的概念，且當位址記錄為多重註冊時該函數會將所有映射的位址紀錄加入到請求分
枝，除此之外對於 ontact表頭欄位中的 Q參數也是一概忽略，這樣的作法並不適用
於 TDP 中分群且輪詢的請求分叉作法，為此本計畫新增一個 CM(Contact
Management)模組，用來處理多重註冊的註冊與映射查找動作。
圖 3- 9為 CM模組的模組函數，其中 get_Q_group_num函數為取得映射位址的
群組數，該函數會根據從服務網域伺服器接收到的用戶解註冊通知，取得該用戶的
靜態映射清單群組數量，而 lookup_first_Qgroup會取得第一個群組的位址清單，並
且將所有位址清單加入請求分叉；lookup_follow_Qgroup 則是會根據參數取得第 n
組的位址清單。將 lookup_first_Qgroup從 lookup_follow_Qgroup單獨獨立出來的原
因是兩者的位址清單的查找方式並不相同，lookup_first_Qgroup 只會取得最高權限
的位址清單，而 lookup_follow_Qgroup則是會將位址清單作所有優先權的排列之後
在取得指定的群組清單。當某 SIP URL指定不使用分群輪詢的機制時，該用戶的映
射清單的所有優先權都為一致，在這樣的情況下呼叫 lookup_first_Qgroup將能加快
映射的處理速度。
圖 3- 9 CM模組函數
CM模組的 3個模組函數都可以在 failure_route的路由區塊中呼叫，其目的在於
可透過 TM模組來達成當交易逾時則繼續輪詢下一群組的機制，這樣的設計保留了
OpenSER 路由規則的彈性設計，讓輪詢機制可以在日後於路由規則下輕易的作調
整。
相對於服務網域伺服器與代理網域伺服器，聯繫管理伺服器的路由規則簡單的
52
第四章 開發一支援會議移動性之環境感知伺服器
4.1 系統環境
我們所用的系統網路環境架構圖如圖 4- 1所示，CAS會記錄家中或企業內部的
有線網路或無線網路中所有 UAC的位址、裝置擁有人、及服務狀態等等。在這樣
的網路環境下，透過 RFID感測技術，為使用者提供與外部 Internet使用者自動建立
連線，以及會議移動性等服務。
圖 4- 1系統網路環境架構圖
4.2 環境感知伺服器中訊息溝通流程
圖 4- 2 CAS中訊息流程的邏輯示意圖
在本計畫中的環境感知伺服器中，主要有三大功能方塊，位於最下層的是 RFID
54
圖 4- 3 軟體發展系統架構圖
4.4 實驗環境設定
圖 4- 4實驗環境圖
本計畫的實驗環境如圖 4- 所示，主要可分為三部分：環境感知伺服器(CAS)、
UAS、UAC。其中 CAS與 UAS都位於圖 4- 左半部，其餘的 PC都扮演著 UAC角
色，而每一台 PC旁邊都會配置一台 RFID Reader，用來感應使用者的出現。當使用
者移動到不同環境下(不同網段或有線/無線網路)，依然可以透過 CAS享受到不同的
服務。
56
出一個Message通知 dev 1去發出 REFER請求給 dev 2，當 dev 2收到後，會自動發
出一個 RE-INVITE請求給 UAS，於是 UAS就會自動把原先送給 dev 1的 RTP封包
轉送往 dev 2，最後 dev2再重新更新 Table資訊，如表 4- 4所示。
Location Tag SIP UA Owner
Bob’s Ofice sip:Bob@140.123.107.119 Bob
LAB sip:Lab@140.123.107.120 Everyone
Joe’s Ofice sip:Joe@140.123.107.125 Joe
表 4- 1 CAS Table
Location Tag SIP UA Owner
Bob’s Ofice Bob’s ID sip:Bob@140.123.107.119 Bob
LAB sip:Lab@140.123.107.120 Everyone
Joe’s Ofice sip:Joe@140.123.107.125 Joe
表 4- 2 CAS Table
SIP UA Service Session ID
sip:Bob@140.123.107.119 Conversation 5294
sip:Lab@140.123.107.120 None Null
sip:Joe@140.123.107.125 None Null
表 4- 3 Session Table
SIP UA Service Session ID
sip:Bob@140.123.107.119 None Null
sip:Lab@140.123.107.120 Conversation 5294
sip:Joe@140.123.107.125 None Null
表 4- 4 Session Table
透過各個裝置一開始都先跟 CAS註冊使用者的身份，對使用者來說還可享受到
Session隱私的保障，舉個例子來說，當另外一個使用者出現在 dev 3時(並不是該裝
置的擁有人)，這時候 CAS發現該使用者不是合法的用戶，就不會提供使用者任何
服務，能真正達到屬於環境感知的會議移動性(Context-Aware Session Mobility)。
4.6 SIP UA開發與設計原理
VideoNet是一套點對點(Peer to Peer)的通訊軟體，可以用於兩個人在
LAN/Internet上進行視訊會議，目前有很多支援視訊會議的程式，且大部分都有提
58
圖 4- 6 SIP UA介面圖
圖 4- 中紅色框起來的部分，是我們新加入用來啟動 REFER命令的按鍵，在一般通
話轉移的流程裡，使用者都必需要手動去發送 REFER命令給下一個要使用的裝置，
但結合本計畫中的環境感知伺服器，使用者完全不需要作這些瑣碎的步驟，環境感
知伺服器會自動感測使用者出現在何處，並通知先前有 Session存在的裝置發出
REFER命令，來完成一個會議移動性的服務。
本計畫中 UA配合環境感知伺服器的運作流程如圖 4- 所示：
圖 4- 7SIP UA設計流程圖
	
 
                                                             
 NSC 95-2219-E-194 -007 
  
  	 
        	 
           
  	 
      SIP    ! " # $ %      & ' (    
 
SIP-Based Multimedia Service Supports over Mobility Aware Heterogeneous 
Networks 
) * + , -  
  . / 0 1   
	
       
2 3 4 5 6 7  9699 96912      
2 3   The International Society for Optical Engineering (SPIE) Optics East   
8 9 : ; < =  A System-Awareness Decision Classifier to Automated MSN Forensics 
 
>?@ A 2 3 B C  
2007 SPIE Optics East conference    Boston Seaport World Trade Center     
4 9 - 12 September!" #  $ % &# Program TracksProgram Tracks I $ % '8# 
conference(Program Tracks II $ % '18# conference!) * + ,- Program Tracks I ,
Broadband Access Communication Technologies II Conference! 
. Conference ,/ 0 1 2 3 4 : 
Conference Chairs 
Raj Jain, Washington Univ. in St. Louis; Benjamin B. Dingel, Nasfine Photonics, Inc.; Shozo 
Komaki, Osaka Univ. (Japan); Shlomo Ovadia, Entropic Communications 
Monday 10 September 
Plenary Session  
Date: Monday 10 September 
Time: 9:00 AM - 10:20 AM 
Location: Harbor Level - Waterfront III 
Plenary Session  
Date: Monday 10 September 
Time: 10:50 AM - 12:10 PM 
Location: Harbor Level - Waterfront III 
Session 1 :   A d v anc es in W ireless B road b and  A c c ess and  Sensor N et w ork s  
Date: Monday 10 September 
Time: 1:10 PM - 3:40 PM 
Location: Harbor Level - Waterfront IB 
W O R K SH O P:  R ec ent  Prog ress in H ig h  Pow er L asers and  A m p lif iers  
Date: Monday 10 September 
Time: 6:00 PM - 8:45 PM 
G?H I  
1. J K LM
M
M
M
M
M
M
M
M
M
  
 
 
 
  
 
 
 
 
  
 
 
 
  
 
 
 
 
