 2
一、 緣由與目的： 
 
全數位化平台驅動控制器系統，已蔚然
成為一種運動控制器之主流，而常見於自動
化機具、雷射切割機、點膠機、倉儲設備、
半導體廠設備、X-Y 平台、零件抓取機、運
輸系統、表面處理廠、3D 工作機…的場所
中。近年來，文獻中有關於平台之驅動控制
技術也引起廣泛之研究[1-13]。常見的平台驅
動由一顆馬達帶動滾珠導螺導運轉，使得轉
轉運動變成直線運動，以帶動平台移動。而
平台位置控制方法中，又分為半閉迴路伺服
控制器系統及全閉迴路伺服控制器系統兩
種，此兩種控制器架構描述如下： 
(1) 半閉迴路伺服控制器系統： 
控制器架構如圖 1(a)所示，其中平台上沒
有位置感測器，僅利用馬達尾端之光編碼器
間接計算平台位置，作為位置迴授值以進行
閉迴路控制。因此稱為半閉迴路伺服控制系
統。然而，轉動馬達及平台間之機械結構，
例如：齒輪、導螺桿等，這些結構引入的一
些問題；譬如背隙(backlash)造成的定位不精
確、摩擦力的增加、導螺桿之導程誤差、因
此將造成能量損失、故障率高、控制不易精
準。 
(2) 全閉迴路伺服控制器系統： 
控制器架構如圖 1(b)所示，其中平台上具
有位置感測器，可直接量測平台位置，作為
位置迴授值以進行閉迴路控制。因此稱為全
閉迴路伺服控制系統。此系統將機械結構體
之非線性問題，如背隙、摩擦力及導螺桿之
導程誤差等含在內，因此控制上較精準，但
是控制的困難度較高。 
隨著半導體製造之進步，各種性能優異之
晶片不斷的被開發完成，如數位訊號處理器
(DSP)晶片、現場可程式邏輯閘陣列(FPGA)
晶片、微控制器(μC)晶片等，而這些晶片常具
有體積小、價格低、功能強--具有通訊、伺服、
即時計算、資料儲存、可程式等優異性能，可
提供各行業發展及設計適合該行業之應用軟
硬體，以提昇其產品與設備之品質與功能，使
之達到小型化、網路化、低成本、省元件、智
慧型與高性能的目的。尤其是 Altera Stratix
晶片具有最高效率、最高密度、廣闊的記憶體
資源及豐富特色的平台，最適合作為研發用之
驗證晶片。Altera Stratix EP2S60，共有 48,352
個 ALUTs 元件， 最大有 718 使用者 I/O 腳
位，36 個 DSP 方塊，共有 2,544,192 bits 的
記憶體，而 Nios 嵌入是處理器有 16 位元或
是 32 位元可規劃 CPU 程式碼，1~20Kbytes 
晶片內部記憶體與 4Gbytes 晶片外部記憶
體，可以下載到 FPGA 與 IP 電路一起運作來
組合出 SoPC 環境[14-17]。需要計算速度快，
可在 FPGA 內以硬體實現；需要彈性處理程
序但運算速度不需很快者，可應用 Nios II 以
軟體實現。軟硬體分別實現但是平行處理，不
僅不會減低系統性能，且可提高設計之靈活
性。 
因此本計畫本年度將引入 SoPC 技術來研
製單軸平台全閉迴路控制之系統整合晶片，如
圖 2 所示。此系統整合晶片內主要包括兩個模
組，第一個模組在 Nios 處理器內以軟體程式
實現，其功能包含點對點運動軌跡之計算；第
二個模組在 FPGA 晶片內以數位硬體方式實
現，其功能主要為全閉迴路平台位置控制。 
 
二、 研究方法： 
 
此計畫今年度著重『單軸平台全閉迴路
控制晶片之設計』，並以有限狀態機法設計模
糊控制器及以 VHDL 語言描述。圖 2 為以
FPGA 為基礎建構的單軸平台伺服控制器系
統架構。圖中 Nios 嵌入式處理器執行運動軌
跡計算，而單軸平台之電流迴路、速度迴路
及位置迴路之控制器全部在 FPGA 以硬體實
現。詳細之設計方法說明如下： 
2.1 單軸平台(含永磁同步馬達)的數學模式 
首先說明永磁同步馬達的伺服系統控制
方塊圖如圖 2 所示，馬達的動態方程式如下：  
d
d
q
d
q
ed
d
sd v
L
i
L
L
i
L
R
dt
di 1   (1) 
q
qq
f
eq
q
s
d
q
d
e
q v
L
1
L 
 
i
L
Ri
L
L
dt
di    (2) 
其中 vd, vq 是 d 軸與 q 軸的電壓 ; id, iq, 
是 d 軸與 q 軸的電流, Rs 是相繞組電阻; 
Ld, Lq 是 d 軸與 q 軸的電感; px  為 轉子
速度; f 是永久磁鐵的係數. PMSM 的電流
控制是以向量控制來實現。因此假如控制 id 
為 0，則 PMSM 將會解耦合，因此在控制
PMSM 將會變得如同控制直流馬達般的容
 4
用 24 步驟來執行整體電路計算。圖 5(a)中資
料型態為 Q11 之 12 位元且具 2 的補數之運
算。此電路中，步驟 s0~s1 為 sin/cos 查表；
步驟 s2~s5及 s5~s8 為 Clark、 Park 座標轉換
計算；步驟 s9~s14 為 d-軸及 q-軸 PI 控制器之
計算；步驟 s15~s19 及 s20~s23 各自為反向 Park、
反向 Clarke 之座標轉換計算。在 FPGA 內每
一個計算步驟為 40ns(25MHz 時脈)；因此 24
個步驟需要 0.96 s 的操作時間。至於後者位
置迴路模糊控制器及速度迴路 P 控制器電路
也是採有限狀態機(FSM)法設計，如圖 5(b)
所示。此電路使用一個加法器、一個乘法器、
數個比較器及暫存器、可查表格而組成，並
運用 23 步驟來執行整體電路計算。雖然模糊
控制器之計算相當複雜，FSM 法也可很適當
以 VHDL 語法來描述此電路。此電路中，步
驟 s0~s2 為速度、位置誤差、及位置誤差變化
值之計算；步驟 s3~s6為模糊化計算；s7 描述
查表功能；s8~s16 為解模糊化；s17~s22 執行速
度及電流命令輸出之計算。在 FPGA 內每一
個計算步驟為 40ns (25MHz 時脈)；因此執行
23 個步驟需要 0.92 s 的操作時間。 此時間
因為比 500 s (2 kHz)小，所以不會影響系統
控制性能。圖 4(a)中單軸平台運動控制晶片
之 FPGA 資源使用表如圖 4(b)所示，總共使
用 10,157 ALUTs 及 129,792 bits RAM，其中
NiosII 處理器使用 5,059 ALUTs 及 78,592 bits 
RAM 而位置控制 IP 使用 5,098 ALUTs 及
51,200 bits RAM。 
 
2.5 實驗系統與實驗結果： 
 
(1) 實驗系統:  
XYZ平台控制系統及以 FPGA為基礎單
軸平台伺服控制器之架構圖如圖 6 所示。此
系統包括一組 FPGA 實驗板，三組具有六顆
IGBT 之電壓源式換流器及一組具有 30cm   
x30cmx15cm 工作行程之 XYZ 平台。此平台
每一軸由一顆 PMSM 驅動滾珠螺桿運轉。
PMSM 之額定功率、電壓、電流及轉速為
200W、92V、1.6A 及 3000rpm。馬達尾端附
有一顆光編碼器，其解析度為 2500ppr。平
台內滾珠導螺桿，每旋轉一圈平台將位移
0.5cm。X 軸及 Y 軸平台上附有一條線型光學
尺，其解析度為 5m。圖 6(b)中，換流器有
六個 IGBT 型式之功率晶體。IGBT 電晶體
集射極之額定電壓為 600V，閘射極額定電
壓為20V，集極 DC 額定電流為 25A，短時
間(1ms) 額定電流為 50A。光耦合隔離 IC 型
號為 TLP250，其輸出具有推挽放大器功能，
相當適合作為 IGBT或MOSFET晶體閘極之
驅動電路。換流器與驅動電路之輸入信號為
FPGA 晶片輸出之三組 PWM 信號。FPGA
元件採用 Altera Stratix EP2S60，共有 48,352
個 ALUTs 元件， 最大有 718 使用者 I/O 腳
位，36 個 DSP 方塊，共有 2,544,192 bits
的記憶體，而 Nios 嵌入是處理器有 16 位
元或是 32 位元可規劃 CPU 程式碼，
1~20Kbytes 晶片內部記憶體與 4Gbytes 晶片
外部記憶體，可以下載到 FPGA 與使用者設
計之 IP 電路一起運作來組合出 SoPC 環境。 
(2) 實驗結果： 
為驗證所提 FPGA-based 單軸平台運動控
制晶片之正確性，本計畫進行平台半閉迴路
及全閉迴路位置控制精度比較、方波步級響
應及點對點軌跡追蹤響應性能之實驗。首先
為平台半閉迴路及全閉迴路位置控制精度比
較。單軸平台位移行程設計為 35mm，並以
光學線性尺當位置回授值的全閉迴路控制及
以馬達尾端之光編碼器間接計算平台位置，
作為位置迴授值之半閉迴路控制，來進行實
驗。實驗結果如圖 7 所示，其中取出前後兩
段圖形(圖 7(b)~圖 7(d))出來觀察，可以發現
半閉迴路控制的誤差越來越大，且由圖 7(c)
顯示，行程 35mm 時累積誤差約 0.026mm。
因此若整個 X 軸平台 300mm 的工作行程將
產生約 0.223mm 的位置累積誤差，相當可
觀。此結果也證實全閉迴路位置控制雖然控
制技術較複雜，但是可獲得較高的定位精
度。接著以位置步級響應來評估所提控制系
統控制性能。在位置步級響應實驗中，X-軸
平台之之位置命令為大小 10 mm 及週期
0.5Hz 之方波訊號；而其響應結果如圖 8 所
示。其上升時間、超越量及穩定值各自為
110ms、14%及幾乎 0mm。在點對點運動軌
跡控制實驗中，採用梯形速度運動軌跡且其
加減速值為 500mm/s2、最大速度為 125mm/s
及移動總行程從 0 mm 到 100 mm；其軌跡
追蹤響應結果如圖 9 所示。此結果顯示不管
在位置或速度方面，平台運動都能追蹤到命
令軌跡。因此由圖 7~圖 9 的實驗結果可以驗
證，所提 FPGA 單軸平台運動控制晶片的有
 6
FPGA Technology”, IEEE Trans. on Industrial 
Electronics. Vol. 56, No. 1, Jan. 2009, pp. 43-53. 
(SCI) 
[20] R.F. Fung, M.H. Weng and Y.S. Kung, 
“FPGA-Based Adaptive Backstepping Fuzzy Control 
for a Micro-positioning Scott-Russell Mechanism,” 
Mechanical Systems and Signal Processing, Vol. 23, 
No.8, Nov. 2009, pp. 2671–2686. (SCI) 
[21] Y.S. Kung and M.H. Tsai, “SoPC-based Position 
Control IC for PMLSM Drive”, International Journal 
of Electrical Engineering (IJEE), Vol.15, No.5, Oct. 
2008. (EI) 
[22] 蔡明宏、陳良榮、龔應時, “以 FPGA 為基礎線型
X-Y 平台控制晶片研製,” 電力電子月刊, vol.7, 
no.1, pp.41~50, 2009. 
[23] 龔應時, “以 TMS320F2812 DSP 為基礎無位置感
測器電動跑步機速度控制器之研製,”工程科技通
訊期刊, 2009 年 8 月. 
[24] Y.S. Kung, Nguyen Khanh Quang and Le Thi Van 
Anh, “FPGA-based Neural Fuzzy Controller Design 
for PMLSM Drive,” Accepted by the 8th 
International Conference on Power Electronics and 
Drive Systems (PEDS'09), Nov. 2~5, 2009, Taipei, 
Taiwan. (EI) 
[25] Y.S. Kung, M.S. Wang and T.Y. Chuang, 
“FPGA-Based Self-Tuning PID Controller using 
RBF Neural Network and its Application in X-Y 
Table,” 2009 IEEE International Symposium of 
Industrial Electronics (IEEE ISIE 2009), pp. 
694~699, July 5~8, 2009, Seoul, Korea. 
[26] Y.S. Kung, T.W. Tsui and N.H. Shieh, “Design 
and Implementation of a Motion Controller for XYZ 
Table based on Multiprocessor SoPC,” 2009 
Chinese Control and Decision Conference (2009 
CCDC), pp. 274~252, June 17-19, 2009, Guilin, 
China. (EI) 
[27] Y.S. Kung, M.S. Wang and C.C. Huang, 
“DSP-based Adaptive Fuzzy Control for a 
Sensorless PMSM Drive,” 2009 Chinese Control 
and Decision Conference (2009 CCDC), pp. 
2390~2395, June 17-19, 2009, Guilin, China. (EI) 
[28] 龔應時, “馬達電流轉速電流控制模組”，工研院
能環所產學合作計畫，98年4月~ 98年10月。 
 
Motion Table 
rSVPWM
PI
PI
rfxv
rfyv
rfzv
ai
wici
*
qi
*
di



v
v
dv
qv
Z
3-Phase
inverter
PWM1
PWM2
PWM3
PWM4
PWM5
PWM6
Current
detector
ui
U
V
W
qi
di

Encoder
detector & 
Transform.
-
Rectifier
 
AC
A/D
bi
1
Modified 
Clarke1Park
Park Clarke
A
B
,
,
cba ,,
cba ,,
,
qd,
,
qd,
Sin&Cos
= 0
LPF
A/D LPF
αi
βi
Full digital implementation
e Comparator
Circuit
To x-axis or 
y-axis PMSM
Signal from 
Rotary Encoder
+
-
1-z-1
vK
u
Intelligent
controller
*
px Reference 
Model
+
_
e
Position loop using Intelligent Controller
and Speed loop using PI controller
px
mx
pxTrajectory
Planning
Position 
command
Current loop 
using vector control
PMSM
px
 
(a) 
rSVPWM
PI
PI
rfxv
rfyv
rfzv
ai
wici
*
qi
*
di



v
v
dv
qv
Z
3-Phase
inverter
PWM1
PWM2
PWM3
PWM4
PWM5
PWM6
Current
detector
ui
U
V
W
qi
di

Encoder
detector & 
Transform.
-
Rectifier
 
AC
A/D
bi
1
Modified 
Clarke1Park
Park Clarke
A
B
,
,
cba ,,
cba ,,
,
qd,
,
qd,
Sin&Cos
= 0
LPF
A/D LPF
αi
βi
Full digital implementation
px
e Comparator
Circuit
Z
-A
B
Comparator
Circuit
To x-axis or 
y-axis PMSM
Signal from 
Rotary Encoder
Signal from
Linear Encoder
Encoder
detector & 
Transform.
Motion Table 
Linear 
encoder 
+
-
1-z-1
vK
u
Intelligent
controller
*
px Reference 
Model
+
_
e
Position loop using Intelligent Controller
and Speed loop using PI controller
px
mx
pxTrajectory
Planning
Position 
command
Current loop 
using vector control
PMSM
 
(b) 
圖 1. 單軸平台(a)半閉迴路及(b)全閉迴路伺服控制器系統架構圖 
Nios Processor II
Altera FPGA 
XYZ Table
Comparator 
circuit
B,B
A,A
A, B
LP filter 
circuit
bi
L
C
Rectifier Inverter
ac source
Isolated and driving circuits

AT

AT

BT

BT

CT

CT
U,V,W
ADC
ADC
ai
PWM6PWM1
zz,z
Comparator 
circuit
B,B
A,A
A, B
zz,z
PMSM
Linear encoder
Digital circuit (PLD)
of servo controller
for single-table
External
memory
Rotary encoder
Motor power
PC
 
圖 2. FPGA-based 單軸平台伺服控制器系統架構圖 
 8
FPGA 
controller
X-table
Y-table
Drivers of 
PMSM
Z-table
  
(6) IGBT
UP VP WP UN VN WN
邏輯保護電路
光耦合
FPGA motion controller
PWM1  ~  PWM6
U
V
W
PMSM
Current 
sensor
低通濾波器
AD1 AD2
比較電路
Rotary 
Encoder
QEP1~QEP3   QEP4~QEP6
L
C
整流器
交流
來源
P
N
低通濾波器
Motion Table 
Linear 
Encoder
ADC574 ADC574
 
(a)                                           (b) 
圖 6. XYZ 平台(a)實體圖及(b)FPGA-based 單軸控制器方塊圖 
0 1 1.5 2 2.5 3.5
0
30
35
A
Measured by linear encoder
Measured by rotary encoder 
0.5 3
5
10
15
20
25
Time (s)
Po
si
tio
n 
(m
m
)
1.02 1.03 1.04 1.05 1.06 1.07 1.08 1.091.01 1.11.0
10
11
B
(a)
Measured by linear encoder
Measured by rotary encoder 10.2
10.4
10.6
10.8
Time (s)(b)
Po
si
tio
n 
(m
m
)
0 1 1.5 2 2.5 3.50.5 3
Time (s)(c)
Er
ro
r (
m
m
)
3.42 3.43 3.44 3.45 3.46 3.47 3.48 3.493.41 3.53.4
Time (s)(d)
Measured by linear encoder
Measured by rotary encoder 
Po
si
tio
n 
(m
m
)
A
B
34
35
34.2
34.4
34.6
34.8
0.03
0.005
0
0.015
0.025
0.01
0.02
 
圖 7. 平台半閉迴路及全閉迴路位置控制精度性能比較 
0 1 2 3 4 5 6 7 8 9 10
-5
0
5
10
15
Time (s)
P
o
si
ti
o
n
 (
m
m
) X-axis table (using FC)Position response Position command
Output of 
reference model
(a)
0 1 2 3 4 5 6 7 8 9 10
-2
0
2
Time (s)
C
u
rr
en
t 
(A
)
(b)    
圖 8. X 軸平台步級響應 
0 2 4 6 8 10 12 14
-50
0
50
100
150
Time (s)
P
o
si
ti
o
n
 (
m
m
)
0 2 4 6 8 10 12 14
-200
0
200
Time (s)
S
p
ee
d
 (
m
m
/s
)
Mover position
X-axis table
Speed command
Mover tracking speed
(b)
Position command
(a)
X-axis table
 
圖 9. 點對點運動軌跡性能(a)位置軌跡追蹤(b)速度軌跡追蹤 
 1
出席國際學術會議心得報告 
                                                             
計畫編號 NSC 97-2221-E-218 -055  
計畫名稱 以 FPGA 為基礎三軸 XYZ 平台運動控制晶片軟硬體設計技術 
出國人員姓名 
服務機關及職稱 
龔 應 時 
南台科技大學電機工程系教授 
會議時間地點 98/6/17 ~ 98/6/19 
 Guilin, China (中國桂林) 
會議名稱 
(中文) 2009 年中國控制及決策研討會 
(英文) Chinese Control and Decision Conference (2009 CCDC)   
發表論文題目 
第一篇:  
(中文)  以多處理器 SoPC 為基礎 XYZ 平台運動控制器之研製 
 (英文) Design and Implementation of a Motion Controller for XYZ 
Table based on Multiprocessor SoPC 
第二篇:  
(中文)  以 DSP 為基礎無感測器永磁同步馬達適應性模糊控制器
之研製 
 (英文) DSP-based Adaptive Fuzzy Control for a Sensorless PMSM 
Drive 
 
一、 參加會議經過 
 
本人此次參加的國際會議為中國東北大學主辦及新加坡IEEE Industrial 
Electronics分支協辦的『2009年中國控制及決策研討會』(2009 Chinese Control 
and Decision Conference)。會議時間為2009年6月17至19日，會議地點在中國廣
西桂林(Guilin, China)的桂山大飯店(Guishan Hotel)舉辦。此會議之論文將被收
錄於IEEE 之資料庫並且為EI Index。此會議之論文分為下列類別：  
1. Control and Decision : (控制與決策) 
 
 Adaptive control; Robust and H-infinity control; Process control; Variable 
structure control; Optimal control and optimization; Complex systems; Co-operative 
control; Identification and estimation; Nonlinear systems; Intelligent systems; 
Discrete event systems; Game theory; Decision-making theory and method; Decision 
 3
National University of Ireland Maynooth, Ireland. 
Plenary Lecture 3: "Cloud Simulation Platform" -----A New Networked 
Modeling & Simulation Platform Based on the Concept of 
Cloud Computing, by Professor Bohu Li, Beihang University, 
China. 
Plenary Lecture 4: Randomly Switching Systems: Models, Analysis, and 
Applications, by Professor Gang George Yin, College of Liberal 
Arts & Sciences Wayne State University, China. 
Semi-plenary Lecture 1: A unified approach to analysis and design of networked 
and quantized control systems, by Professor Dragan Nesic, 
University of Melbourne, Australia. 
Semi-plenary Lecture 2: Hybrid meta-heuristics based research on the planning 
and scheduling in the process industry, by Professor Lixin 
Tang, Northeastern University, China. 
Semi-plenary Lecture 3: Multi-agent control with multi-resolution sensing over 
networks, by Professor Geir E. Dullerud, University of Illinois 
at Urbana-Champaign, USA. 
Semi-plenary Lecture 4: Quantized Linear Quadratic Gaussian Control, by 
Professor Minyue Fu, University of Newcastle, UK. 
Semi-plenary Lecture 5: Recent Developments in Nonsmooth Feedback Control 
of Nonlinear System, by Professor Wei Lin, Case Western 
Reserve University, USA. 
Semi-plenary Lecture 6: Batch Process Control from Practice to 2D Model 
Predictive Control, by Professor Furong Gao, The Hong Kong 
University of Science and Technology, Hong Kong. 
Semi-plenary Lecture 7: Parametric Control Systems Design with Application in 
Missle Attitude Control, by Professor Guang-Ren Duan, 
Harbin Institute of Technology, China. 
Semi-plenary Lecture 8: Recent Advances on Stochastic Distribution Control: 
Probability Density Function Control, by Professor Hong 
Wang, University of Manchester, UK. 
Semi-plenary Lecture 9: Stochastic hybrid systems and their applications to 
networks and biology, by Professor João P. Hespanha, 
University of California, Santa Barbara, USA. 
Semi-plenary Lecture 10: Modelling and control of large-scale physical systems - 
challenges in reservoir engeering, by Professor Paul M. J. Van 
den Hof, Delft University of Technology, Netherlands. 
Semi-plenary Lecture 11: Low Gain and Low-and-High Gain Feedback: A 
Review and Some New Results, by Professor Zongli Lin, 
University of Virginia, USA. 
 5
慧型控制、遊戲理論、控制系統與應用、電動車輛、機電整合、微機電
系統、機器視覺與最新發展技術等，都有很新穎的技術展現。不過，此
會議之論文 80%為中國學者所發表。因此，參加此會議可以很快了解中
國在這些領域目前的發展技術，也可提供國內專家學者在研究方向之參
考。  
(二) 此次 CCDC 2009 會議中，由現場討論較為熱烈的論文評定，應稍為偏重
實務應用之論文，而其論文涵蓋相當廣泛，因此，CCDC 2009 會議適合
國內研究電機與電子之學者或研究生參與。 
(三) 此次 CCDC 2009 會議共有 1,233 論文被接受在此會議發表，因此總註冊
會相當可觀。因此不管在邀請演講之場次，會場之佈置及膳食方面，都
比較豐富與精緻。也由於論文篇數多，此會議之論文也較被收錄於 IEEE 
之資料庫並且為 EI Index。相對的，也由於可收錄於 IEEE 之資料庫並且
為 EI Index，投稿的論文也較踴躍。 
 
三、 攜回資料名稱及內容 
 
大會研討會論文 CD 片及明年度各項研討會資料。 
 
1. INTRODUCTION 
Development of a high performance controller and servo 
system for precision XY table, CNC machine, etc. is a 
popular research work in literature [1-2]. In position control, 
there are two methods, which are semi-closed-loop control 
and full closed-loop control. The full closed-loop control 
algorithm, which is a signal of table position detected by a 
linear encoder and feedbacked for position control, had 
been proven a better position control method. 
Nowadays, the FPGA has brought more attention before. 
The advantages of the FPGA includes their programmable 
hard-wired feature, fast time-to-market, shorter design 
cycle, embedding processor, low power consumption and 
higher density for the implementation of the digital motor 
system; such as M.F. Tsai[3], D. Deng[4] adopted the 
CPLD and FPGA to develop the SVPWM scheme for 
inverter; Y. Y. Tzou[5], Y.S. Kung[6-7], etc, applied the 
FPGA to implement the vector control, current control and 
position control for the PMSM drive. Furthermore, the 
SoPC [8] and IP (Intellectual Property) designs can be 
developed and downloaded into FPGA with embedded 
processors to construct a multiprocessor SoPC environment. 
Using multiprocessor SoPC technology, the software and 
hardware co-design are reprogrammable and can be parallel 
processing in FPGA to increase the system performance 
and flexibility.  
In recent year, fuzzy control has been used to solve the 
control problem regarding as the parameter uncertainty and 
                                                          
This work is supported by National Science Council of the R.O.C. under 
grant no. NSC 97-2221-E-218 -055 
nonlinear system. Implementation of fuzzy control based on 
FPGA has the advantages of flexible design and fast 
computation; therefore, several researchers have been 
successfully used those techniques in the field of the servo 
control system. Such as, Li, T.S. [9] utilized an FPGA to 
implement the autonomous fuzzy behavior control on 
mobile robot. Lin, F.J. [10] presented a fuzzy sliding-mode 
control for a linear induction motor drive based on FPGA.  
Due to the advantage, a full close-loop control IC for XYZ 
table based on the multiprocessor SoPC technology is 
developed and shown in Fig.1. It has two modules in 
proposed motion control IC. One module is Nios-II 
multi-processor, which performs the function of trajectory 
planning and position control of XYZ table. The other 
module performs the function of three PMSMs’ current 
loop control, that each includes SVPWM generation, 
coordinate transformation, PI controller and the pulse 
detection of the quadrature encoder. Therefore, all of the 
function needed to construct a full closed-loop control for 
XYZ table can be integrated and realized in an FPGA chip. 
Herein, FPGA adopts Altera Stratix II EP2S60F672C5ES 
[11-12], which has 48,352ALUTs, maximum 718 user I/O 
pins, 36 DSP blocks, total 2,544,192 RAM bits, and a Nios 
II embedded multi-processor which has a 32-bit 
configurable CPU core, 16 M byte Flash memory, 1 M byte 
SRAM and 16 M byte SDRAM, is used. Therefore, this 
FPGA chip is very suitable to develop a motion controller 
system for XYZ table. 
 
Design and Implementation of a Motion Controller for XYZ Table based on 
Multiprocessor SoPC 
Ying-Shieh Kung1, Tai-Wei Tsui1, Nan-Hui Shieh1 
1. Department of Electrical Engineering, Southern Taiwan University, Taiwan 
E-mail: kung@mail.stut.edu.tw  
 
Abstract: The new Field Programmable Gate Array (FPGA) technologies enables a Nios-II multi-processor and an 
application IP to be integrated into an SoPC (System-on-a-Programmable-Chip) developing environment. Therefore, 
this study presents a motion control IC for XYZ table under this SoPC environment. Each axis of XYZ table is driven by 
a Permanent magnetic Synchronous Motor (PMSM). In implementation, it has two modules in proposed motion control 
IC. One module is Nios-II multi-processor, which performs the function of trajectory planning and position control of 
XYZ table. The other module performs the function of three PMSMs’ current loop control, that each includes SVPWM 
generation, coordinate transformation, PI controller and the pulse detection of the quadrature encoder. The former is 
implemented by software with C code in the Nios-II embedded multiprocessor. The latter is described by VHDL and 
implemented by hardware in FPGA. At last, to confirm the effectiveness of the proposed FPGA-based motion control IC 
for XYZ table, an experimental system with an XYZ table, an FPGA experimental board, a peripheral board for 
analog-to-digital transformation, three inverters and three rectifiers has been set up and some experimental results have 
been demonstrated. 
Key Words: XYZ Table, PMSM drives, FPGA, Fuzzy control, Multiprocessor SoPC. 
 
247978-1-4244-2723-9/09/$25.00 c© 2009 IEEE
  
on the X-axis table, and send a measured position of the 
X-axis table to the main CPU. 
(c) The third CPU: perform the computation of the fuzzy 
control algorithm for Y-axis table, receive the Y-axis 
position command from main CPU and the QEP signal 
on the Y-axis table, and send a measured position of the 
Y-axis table to the main CPU. 
(d) The fourth CPU: perform the computation of the fuzzy 
control algorithm for Z-axis table, receive the Z-axis 
position command from main CPU and the QEP signal 
on the Z-axis table, and send a measured position of the 
Z-axis table to the main CPU. 
2.3   Fuzzy controller design 
The fuzzy controller in this study uses singleton fuzzifier, 
triangular membership function, product inference rule and 
central average defuzzifier method. In Fig. 1, the tracking 
error e  and the error change de  are defined by  
)()()( kskske rm   (4) 
)()()( 1kekekde   (5) 
and uf  represents the output of the fuzzy controller. Where 
the ms  and rs  are the position command and the measured 
displacement of the table, and s denotes X, Y or Z. The 
design procedure of the fuzzy controller is described as 
follows:  
(a) Take e, de as the input variable of fuzzy controller, and 
define their linguist variables as E and dE. The linguist 
value of E and dE are {A0, A1, A2, A3, A4, A5, A6} and 
{B0, B1, B2, B3, B4, B5, B6}, respectively. Each linguist 
value of E and dE are based on the symmetrical 
triangular membership function which is shown in 
Fig.2. The symmetrical triangular membership 
function are determined uniquely by three real 
numbers 321 			 

 , if one fixes 0ff 31  )()( 		  
and 1f 2 )(	 . With respect to the universe of 
discourse of [-6.6], the numbers for these linguistic 
values are selected as follows: 
A0=B0 : {-6,-6,-4},  A1=B1 : {-6,-4,-2}, A2=B2 : 
{-4,-2,0}, A3=B3: {-2,0,2},A4=B4 : {0,2,4}, A5=B5 : 
{2,4,6}, A6=B6: {4,6,6} (6) 
(b) Compute the membership degree of e and de. Figure 2(a) 
shows that the only two linguistic values are excited 
(resulting in a non-zero membership) in any input value, 
and the membership degree )(eAi  can be derived from 
Fig. 2(b), in which the error e is located between ei and 
ei+1, two linguist values of Ai and Ai+1 are excited, and 
the membership degree is obtained by 
    
2
eee 1iAi

 )(   and   )()( e1e i1i AA    (7) 
where )(* 1i26e 1i   . Similar results can be 
obtained in computing the membership degree )(deB j .  
(c) Select the initial fuzzy control rules by referring to the 
dynamic response characteristics, such as, 
ij,fji c  is  u  THEN   B is e  and  A is  e  IF   (8) 
where i and j = 0~6 and Ai and Bj are fuzzy number, and 
cj,i is a real number. The fuzzy rule table is shown in Fig. 
3.  
(d) Construct the fuzzy system uf(e,de) by using the 
singleton fuzzifier, product-inference rule, and central 
average defuzzifier method. Although there are total 49 
fuzzy rules in Fig. 3 will be inferred, actually only 4 
fuzzy rules can be effectively excited to generate a 
non-zero output. Therefore, if the error e is located 
between ei and ei+1, and the error change de is located 
between dej and dej+1, only four linguistic values Ai, Ai+1, 
Bj, Bj+1 and corresponding consequent values cj,i, cj+1,i, 
cj,i+1, cj+1,i+1 can be excited, and the (8) can be replaced 
by the following expression: 
m,n
i
in
j
jm
n,mi
in
j
jm
BA
i
in
j
jm
BAn,m
f d*c
)de(*)e(
)]de(*)e([c
)de,e(u
mn
mn


 










 
1 1
1 1
1 1
 

   (9) 
where )de(*)e( d
mn BAm,n
 . And those n,mc are adjustable 
parameters. In addition, by using (7), it is straightforward to 
obtain 1 d 
1i
in
1j
jm
mn  




,
 in (9). 
1
A0 A1 A2 A3 A4 A5 A6
0 6-6
e
(e)
42-4 -2
1
B0 B1 B2 B3 B4 B5 B6
0 6-6
de
(de)
42-4 -2
1
(e)
Ai Ai+1
ee
ei = -6+2*i ei+1 = -4+2*i
)(e
iA
)(e
1iA 
e de
(a)
(b)  
Fig. 2. (a) Membership function of error and error change 
(b) Membership degree 
c00
dE
1 A0 A1
A2 A3 A4 A5 A6
0 6-6
e
e
E
de
de
(e)
(
de
) 1
A3(e)
A4(e)=1- A3(e)
 B
1(
de
)
 B
2(
de
)=
1-
 B
1(
de
)
0
6
-6
Fuzzy Rule Table
Input of e  (for i=3)
In
pu
t o
f d
e 
 (f
or
 j=
1)
A0 A1 A2 A3 A4 A5 A6
c01 c02 c03 c04 c05 c06
c10 c11 c12 c13 c14 c15 c16
c20 c21 c22 c23 c24 c25 c26
c30 c31 c32 c33 c34 c35 c36
c40 c41 c42 c43 c44 c45 c46
c50 c51 c52 c53 c54 c55 c56
c60 c61 c62 c63 c64 c65 c66
B0
B1
B2
B3
B4
B5
B6
B 0
B 1
B 2
B 3
B 4
B 5
B 6
42-4 -2
4
2
-4
-2
 
Fig. 3 The fuzzification and fuzzy rule table 
3. MOTION TRAJECTORY OF XYZ TABLE  
3.1. One dimensional motion trajectory  
To smooth the table motion, a trajectory using a 
point-to-point motion control scheme with a trapezoidal 
constant acceleration/deceleration profile is adopted. In 
addition, in long distance motion, all axis in XYZ table is 
2009 Chinese Control and Decision Conference (CCDC 2009) 249
  
communication between main and others CPU adopts 
Avalon bus interface. Four CPUs operate with parallel 
which will speed up computational performance. The 
second module in FPGA performs the function of three 
PMSMs’ current loop control, that each includes vector 
control, SVPWM generation, coordinate transformation, PI 
controller and the pulse detection of the quadrature encoder. 
Therefore, all of the function needed to construct a full 
closed-loop control for XYZ table can be integrated and 
realized in an FPGA chip. The clock frequency of the Nios 
II multi-processor is 50MHz, and the interrupt interval in 
position loop is designed with 1kHz. In this paper, FPGA 
chip adopts Altera Stratix II EP2S60F672C5ES, which has 
48,352ALUTs (equivalent 120,880LEs), maximum 718 
user I/O pins, 36 DSP blocks, total 2,544,192 RAM bits, 
and a Nios II embedded multi-processor which has a 32-bit 
configurable CPU core, 16 M byte Flash memory, 1 M byte 
SRAM and 16 M byte SDRAM, is used. A custom software 
development kit (SDK) consists of a compiled library of 
software routines for the SoPC design, a Make-file for 
rebuilding the library, and C header files containing 
structures for each peripheral. Finally, the FPGA utility of 
the motion control IC in Fig. 5 is evaluated and the result is 
listed in Table 1, which shows that the overall circuits of the 
proposed motion control IC included a Nios II embedded 
multi-processor IP (9,334 ALUTs and 192,512 RAM bits) 
and the three tables’ position control IP (9,422 ALUTs and 
239,616 RAM bits), use 38.7% ALUTs resource and 17% 
RAM resource of the Stratix II EP2S60F672C5ES.  
5. EXPERIMENTAL SYSTEM AND RESULTS 
The experimental system of the proposed motion control 
system for XYZ table is shown in Fig. 1. This system 
includes an FPGA experimental board, three sets of voltage 
source IGBT inverter and an XYZ table which is driven by 
three PMSMs and three ball-screws. The power, rating, 
voltage, current and rating speed of PMSM are 200W, 92V, 
1.6A and 3000rpm, respectively. A 2500 ppr rotary encoder 
attached to PMSM is used to measure the motor’s electrical 
angle. The linear encoders with 5m resolution are 
mounted on the X-axis and Y-axis table as a position sensor. 
Each ball-screw has 5mm lead.  The inverter has 6 sets of 
IGBT type power transistors. The collector-emitter voltage 
of the IGBT is rating 600V, the gate-emitter voltage is 
rating ±12V, and the collector current in DC is rating 25A 
and in short time (1ms) is 50A. The photo-IC, Toshiba 
TLP250, is used for gate driving circuit of IGBT. Input 
signals of the inverter are PWM signals from FPGA chip. 
In the experimental system, the PWM switching frequency 
of inverter is designed with 12k Hz, dead-band is 1s, and 
the sampling frequency in current loop and position loop of 
the PMSM are designed with 16kHz and 1kHz, 
respectively. 
To demonstrate the effectiveness of the proposed motion 
control IC, one-dimensional trapezoidal motion trajectory, 
two-dimensional circular and window motion trajectory, as 
well as the three-dimensional spiral motion trajectory are 
tested and its experimental tracking results are shown in 
Figs. 6 ~ 9. In Fig. 6, the overall displacement is designed 
with moving from 0 mm to 50 mm position and it maximum 
speed is 50mm/s. The result shows that the maximum 
tracking error is 0.5mm. In Figs. 7, the circular motion 
trajectory control with center (60, 60) mm and radius 50mm 
is evaluated and the tracking errors are the maximum 
 0.55 mm in X-axis, and  0.75 mm in Y-axis. The 
window motion trajectory control in Fig. 8 also shows the 
tracking errors maximum  0.5 mm in X-axis, and  0.9 
mm in Y-axis. Finally, the spiral motion trajectory with 
radius 40mm in X-Y plane and 100mm deep in Z-axis is 
evaluated, and its tracking errors are about  1.2 mm. 
Therefore, from the experimental results in Figs 6~9, those 
show that the motion trajectory for XYZ table can follows 
the trajectory command very well, and demonstrate that the 
proposal motion control IC using multi-processor SOPC is 
correctness and effectiveness. 
IDD[11..0]
IBB[11..0]
I-U[11..0]
IQQ[11..0]
IAA[11..0] I-W[11..0]
KP-q[11..0] VQQ[11..0]
VDD[11..0]
VAA[11..0]
VBB[11..0]
VA[11..0]
VC[11..0]
IQ[11..0]
IQQ[11..0]
PWM-f[11..0]
KI-q[11..0]
KP-p[11..0]
ID[11..0]
CLK-ctrl
IDD[11..0]
I-U[11..0]
I-W[11..0]
KI-p[11..0]
Encoder-A
SIN/COS
PI 
Controller
IQ[11..0]
STSB
RCB
RCA
STSA
CHB
CHA
SVPWM
ADC
Control
Modified
INV CLARK
CLARKPARK
INV PARK
QEP[15..0]
PI 
Controller
QEP
VB[11..0]
VC[11..0]
VB[11..0]
VA[11..0]
ID[11..0]=‘0’
Dead-band[11..0]
Estimation 
of Flux 
angle
rotor-position[15..0]
EN-Z
Flux-angle[11..0]
EN-A
EN-B
EN-ZEncoder-B
Encoder-Z
PWM-1
PWM-2
PWM-3
PWM-4
PWM-5
PWM-6
ADIN[11]
ADIN[10]
ADIN[9]
ADIN[8]
ADIN[7]
ADIN[6]
ADIN[5]
ADIN[4]
ADIN[3]
ADIN[2]
ADIN[1]
ADIN[0]
BDIN[11]
BDIN[10]
BDIN[9]
BDIN[8]
BDIN[7]
BDIN[6]
BDIN[5]
BDIN[4]
BDIN[3]
BDIN[2]
BDIN[1]
BDIN[0]
Servo on
Servo on
Servo on
CLK-ctrl
CLK-sys
CLK-sys
CLK-sys
CLK-sys
CLK -sys
CLK-sys
CLK-sys
CLK-sys
CLK-sys
CLK-ctrl
CLK-sys
CLK-sp
CLK-sys
CLK-sp
QEPx[15..0]
IQx[11..0]
QEP[15..0]
Altera FPGA (Stratix II EP2S60 )
CPU
On-chip
ROM
On-chip
RAM
UART
PIO
Timer
SPI
A
va
lo
n 
B
us
A
va
lo
n 
B
us
Nios Embedded Processor IP
sram_cs
sram_we
sram_oe
sram_be[3]
sram_be[2]
sram_be[1]
sram_be[0]
D[31]
D[0]
A[22]
A[0]
Encoder-A QEPEN-AEN-B
EN-ZEncoder-B
Encoder-Z
CLK-sys
CLK-sp
QEP[15..0]
EN-Z
QEP[15..0]
From Linear
Encoder
From Rotary
Encoder
X_STSB
X_RCB
X_RCA
X_STSA
X_CHB
X_CHA
X_PWM 1
X_PWM 2
X_PWM 5
X_PWM 3
X_PWM 4
X_PWM 6
X_ADIN[11]
X_ADIN[0]
X_BDIN[11]
X_BDIN[0]
CKCK
X_STSB
X_RCB
X_RCA
X_STSA
X_CHB
X_CHA
X_PWM 1
X_PWM 2
X_PWM 3
X_PWM 4
X_PWM 5
X_PWM 6
X_ADIN[11]
X_ADIN[0]
X_BDIN[11]
X_BDIN[0] Position control IP
for Z-Axis
Position control IP
for Y-Axis
Position control IP
for X-Axis
Clk
Clk-cur Frequency 
divider
CKClk-sp
QEPy[15..0]
IQy[11..0]
QEPz[15..0]
IQz[11..0]
A
va
lo
n 
B
us
A
va
lo
n 
B
us
ʳ
Fig.5.Architecture of the proposed motion control IC for XYZ Table  
Table 1 Utility evaluation of a motion control IC in FPGA  
01,610other
0159 *3ADC read in and transformation
Position control IP
(x-axis y-axis & z-
axis )
0105 * 3QEP detection and transformation
432,12818,756
01,339 *3SVPWM generation
79,872 *31,001 * 3Current vector control
Total
192,5129,334Nios II Embedded Processor IP
Memory
(bits)
ALUTsModule circuitIP
 
 
6. CONCLUSION 
This study adopts an Altera Stratix II EP2S60F672C5ES 
and a Nios-II multi-processor to build up a motion control 
IC for XYZ table. The trajectory planning and position loop 
2009 Chinese Control and Decision Conference (CCDC 2009) 251
 
1. INTRODUCTION 
Owing to the advantages of the superior power density, the 
high performance in speed control – dynamic response and 
better accuracy, permanent magnet synchronous motors 
(PMSMs) have been used in many automation control 
fields as actuators [1]. Conventional motor control needs a 
speed sensor or an optical encoder to measure the rotor 
speed and feedback it to the controller for ensuring the 
precision speed control. However, such sensor presents 
some disadvantages such as drive cost, machine size, 
reliability and noise immunity [2]. In recent year, a 
sensorless control for PMSM drive become an important 
issue and variable sensorless control strategies have been 
investigated [2-5], such as, the sliding mode observer, the 
back EMF, Kalmam filter, the neural network, etc. 
However, the back EMF and the sliding mode observer are 
suitable to be implemented by the fix-pointed processor. In 
industrial applications, there are many uncertainties, such 
as system parameter uncertainties, external load 
disturbances, unmodeled uncertainties, etc. which always 
diminish the performance quality of the pre-design 
specification in the motor driving system. To solve this 
problem, intelligent control techniques [6-8] such as the 
fuzzy control, the neural networks control, the AFC, have 
been developed and applied to the speed control of servo 
motor drives to yield high operating performance. 
With rapid developments of the system-on-chip, a 
high-performance digital signal processor (DSP) has 
become a popular area of research in the field of the digital 
control [9] for ac drives because they exhibit high-speed 
performance, combine peripheral circuits, memory and 
                                                          
This work is supported by National Science Council of the R.O.C. under 
grant no. NSC 97-2221-E-218 -055 
have an optimized CPU structure on a single chip. In 
particular, the DSP controller TMS320F2812 [10] 
produced by Texas Instrument, which provides a high 
speed (150MIPS) computational power, up to 128Kx16 
flash, two sets (total 12 lines) of PWM outputs, two sets 
(total 4 lines) of QEP inputs, a 16-channels 12-bit A/D 
converter (200ns conversion time) and a 56-bits GPIO. 
Therefore, a complex control algorithm, such as the neural 
network control or the AFC, applied to servomotor to 
improve the dynamic performance become possible. 
Accordingly, in this work, a TMS320F2812 DSP controller 
used to realize a current vector control, a SVPWM (Space 
Vector Pulse Width Modulation) scheme, a flux angle and a 
rotor speed estimation scheme, an AFC, etc, has been 
developed for a sensorless PMSM drive. All software 
implemented in DSP is coded in C language. The excellent 
characteristic of the proposed DSP-based controller system 
makes the sensorless PMSM drive robust, well 
performance and easy to program. 
2. CONTROLLER DESIGN OF SENSORLESS 
PMSM DRIVE  
The architecture of the proposed speed controller applied in 
the sensorless PMSM drive is shown in Fig.1. In this figure, 
the functionalities of Park, Park-1, Clark, Clark-1, SVPWM, 
AD converter, PI current control, flux angle and rotor speed 
estimation, AFC etc. are all implemented in a DSP chip. 
Detailed design technologies are described as follows. 
2.1 Mathematical model of a PMSM drive 
PMSM is a coupled and nonlinear system. Under vector 
control in current loop, it will become a decoupled and 
linear system which likes DC motor. Generally, the 
mathematical model of the PMSM in d-q axis can be 
expressed by, 
 
DSP-based Adaptive Fuzzy Control for a Sensorless PMSM Drive  
Ying-Shieh Kung1, Ming-Shyan Wang2, Chung-Chun Huang3 
1,2. Department of Electrical Engineering, Southern Taiwan University, Taiwan 
E-mail: kung@mail.stut.edu.tw1  mswang@mail.stut.edu.tw2 
3. Energy & Environment Research Laboratory, Industrial Technology Research Institute, Taiwan 
E-mail: CCHuang@itri.org.tw 
 
Abstract: A study on DSP-based PMSM (Permanent Magnet Synchronous Motor) drive without the encoder sensor is 
presented in this work. In the sensorless technique, a flux angle estimator mainly constructed by a sliding mode observer 
is utilized to estimate the back electromotive force (EMF) and the flux angle, and indirectly compute and the rotor speed 
of the motor. These estimated values are feedback for vector control in the current loop and for speed control in the speed 
loop. To increase the performance of the speed controller, an adaptive fuzzy controller (AFC) consisted by a fuzzy 
controller, a reference model and an adjustable mechanism is applied; after that, the rules of the fuzzy controller can be 
online updated in real time. Finally, the TMS320F2812 DSP (Digital Signal Processor) is adopted to implement the 
aforementioned controllers. Combined a sensorless technique and an adaptive control technique into the speed controller 
of a PMSM drive make its performance be improved, the cost be reduced and the reliability be increased. 
Key Words: PMSM, DSP, Sliding mode observer, Sensorless technique, Adaptive fuzzy controller. 
2390978-1-4244-2723-9/09/$25.00 c© 2009 IEEE
  
 Park  transformation: stationary - frame to 
synchronously rotating d-q frame. 
























f
f
f
f
ee
ee
qs
ds
cossin
sincos
  
(7) 
 1
Park  transformation: synchronously rotating d-q frame 
to stationary - frame. 











 







qs
ds
ee
ee
f
f
f
f




cossin
sincos
 
(8) 
In Fig.1, the PMSM will be decoupled if control id = 0; thus 
to control a PMSM is like to control a DC motor [1]. 
Considering the mechanical load term, the electrical and 
mechanical equations of PMSM can be written by the 
following equations. 
*
qie i KT   (9) 
Lermrm TTBdt
dJ 
	   (10) 
where eT , iK , mJ , mB  and LT  are motor toque, torque 
constant, inertial value, damping ratio and load toque, 
respectively. 
a
c
f
f
dsf
qsf
rotor
stator
Sf
e
e 
d
q 
axes rotatingsly synchronou  qd 

axes stationary   

axes stationary  cba 


b
 
Fig. 2. Transformation between stationary axes and synchronously rotating 
axes 
2.3  The estimation of a rotor flux angle 
A flux angle estimator constructed by a current observer, a 
bang-bang controller, a back EMF estimator and a flux 
angle calculation, is shown in Fig. 3. The feedback 
currents i , i  and the voltage commands v , v  are the 
inputs and the estimated flux angle eˆ  is the output. When 
the estimated currents have a difference with the actual 
measured currents, the error will be used to drive the 
bang-bang controller. Then, the output of a bang-bang 
controller will regulate the back EMF value and force the 
estimated currents to follow the actual measured currents. 
From (4), the mathematic model of current observer is 
rearranged by the following equation 
 aaaa e-vBAiidt
d
	  (11) 
with
2
a
a I
L
R-A  , 2
a
I
L
1B  , ma L2
3L  ,  Ta iii  , 
 Ta vvv  and  Ta eee  . The Ra and Lm are 
winding resistance and inductance, respectively. The I2 is a 
2x2 unity matrix. Next, the sliding mode observer is used to 
the current observer in Fig.3, and the formulation is 
expressed as  
 ze-vBiAi
dt
d
a
*
aaa 		 ˆˆˆ  (12) 
Where  Ta iii  ˆˆˆ  ,  Ta eee  ˆˆˆ  ,  
 aa i-ikz ˆsgn  (13) 
The sgn is defined as follows 
 
 
 







0i-i1-
0i-i0
0i-i1
aa
aa
aa
ˆ
ˆ
ˆ
sgn  (14) 
and 22Rk   is a gain matrix. In (13), the z is the output 
gain of the bang-bang controller for use to compensate a 
value to reduce the error between estimated current and 
measured current. In Fig. 3, the back EMF aeˆ  is used to 
compute the flux angle eˆ . To consider the noise effect, a 
low-pass filter is applied to estimate of back EMF, as 
follows, 
 a00a0a e-zze-edt
d ˆˆˆ  	  (15) 
where   eeea ˆˆˆ  , 00 f2    and 0f  is the cut-off 
frequency of the filter.  
In implementation, the above formulations in the 
continuous system have to transfer to the discrete system; 
therefore, the sliding mode current observer in (12) can be 
formulated to the difference equation by 
          nzne-nvGniF1ni a*aaa 			 ˆˆˆ  (16) 
where 2
T
L
R-
IeF
s
s
s
 , )( s
s T
L
R-
s
e-1
R
1G   and sT  is the sampling 
time. In addition, the difference equation of the back EMF 
estimator can also be expressed by  
        ne-nzf2ne1ne a0aa ˆˆˆ  		  (17) 
Once the back EMF is estimated, the flux angle can be 
computed as,  
eef sin-e  ˆˆ   (18) 
eef cose  ˆˆ   (19) 
and the magnet angle eˆ  can be directly computed by 
!
"
#
$
%
&

 e
e- tan 1-e ˆ
ˆˆ  (20) 
ɠ
e
Current
Observer
(12)
Bang-Bang
Control
(13)
PMSM
Low-pass
Filter
(15)
Flux angle
Calculation
(20)ɠ
ɡ
ɠ ɠ
ɡ











i~
i~
i~a









i
i
ia









v
v
va

av
z









e~
e~
e~a
ae~ e
~
Rotor Flux Position Estimator
Back EMF Observer
 
Fig. 3. Architecture of a rotor flux angle estimator 
2392 2009 Chinese Control and Decision Conference (CCDC 2009)
  
optical encoder (1000 ppr) attached to PMSM is used to 
recheck the accuracy and correctness of the estimated 
rotor speed.  
 Inverter : The inverter has 6 sets of IGBT type power 
transistors.!The collector-emitter voltage of the IGBT is 
rating 600V, the gate-emitter voltage is rating!320V, and 
the collector current in DC is rating 25A and in short time 
(1ms) is 50A. The photo-IC, Toshiba TLP250, is used for 
gate driving circuit of IGBT. Input signals of the inverter 
are PWM signals from DSP chip.  
 DSP Controller : The DSP controller TMS320F2812  
produced by Texas Instrument, which provides the high 
speed (150MIPS) computational power, up to 128Kx16 
flash, two sets (total 12 lines) of PWM outputs, two sets 
(total 4 lines) of QEP inputs, a 16-channels 12-bit A/D 
converter (200ns conversion time) and a 56-bits GPIO. 
In Fig.1, a current vector control scheme, a SVPWM 
generation, two A/Ds conversion, the coordinate 
transformation, a rotor speed estimation and an 
intelligent fuzzy control strategy are all realized by the 
software in DSP chip. The PWM switching frequency of 
inverter is designed with 16k Hz, dead-band is 1-s, and 
the control sampling frequency of current and speed 
loop are 16kHz and 1kHz, respectively. The flow chart 
of main program and the interrupt service routine for 
digital motor control algorithm are designed and shown 
in Fig. 6. Those programs are coded with C language, 
the computation time in DSP for executing current loop 
and AFC algorithm of speed loop is 25 -s.  
IGBT 
(or IPM)
UP VP WP UN VN WN
Protection logic circuit
TLP250
TMS320F2812 DSP Controller
PWM1  ~  PWM6
U
V
W
PMSM
Current 
sensor
LP filter
AD1 AD2
LP filter
L
C
Rectifier
ac 
source
P
N
 
Fig. 4. DSP-based  sensorless PMSM driving system 
 
Fig. 5. The DSP-based experimental system for sensorless PMSM drive 
Start of 
main program
Initial interrupt
Initial timer 1,
QEP,ADC etc.
Setting of
PWM Mode
Setting of 
speed command
loop
Start of  ISR
(each 16kHz)
Read iu , iw current
from ADC
Park & Clark 
transformation
Calculation of 
current error of 
PI controller
Park-1 & Clark-1
transformation
Calculation of
SVPWM scheme
and PWM output
(each 500Hz)
(each 16kHz)
Return
yes
no
Estimate rotor 
Position from
Sliding mode observer
Speed control
model ?
Calculation of 
speed error of 
Adaptive Fuzzy 
controller
Estimate rotor speed
Calculation of
q-axis current 
command
Get reference speed
of model reference 
19.8Ӵs
 
Fig. 6. The flow chart of the main and interrupt program in DSP 
3.2 Experimental results 
In the implementation, the PWM frequency, dead-band, 
current loop sampling frequency, speed loop sampling 
frequency in PMSM drive are designed with 16 kHz, 1 -s, 
16 kHz and 500 Hz, respectively. The cut-off frequency of 
low-pass filter for back EMF estimator in Fig. 3 is set to be 
50Hz. In the experiment of the flux angle estimation, the 
running PMSM are tested in the condition of 60rpm (4Hz 
flux rotation frequency), 300rpm (20Hz) and 1200 rpm (80 
Hz). To evaluate the correctness of the measured flux angle, 
an encoder attached to the PMSM is adopted to measure the 
rotor flux position for comparing the accuracy of the 
estimated value; and the experiment results are shown in 
Figs. 7~9. In Figs. 7~8, the PMSM runs at 60 rpm and 300 
rpm and the estimated flux angle has 30° and 7°phase error 
compared with the measured value by encoder sensor, 
respectively. However, the PMSM runs at 1200 rpm in 
Fig.9, the estimated flux angle almost match the measured 
value by encoder sensor. The experiment results show that 
the method of sliding mode current observer applied to 
estimate the flux angle is suitable for a moderate or a high 
speed motor running. At a low speed of the motor rotor, the 
weak back EMF signal will affect the accuracy of the flux 
position. After confirming the correctness of the sensorless 
flux estimation, and further, the vector control and AFC are 
applied to the current loop and speed loop, respectively, for 
improving the speed control performance. Then the 0.5 Hz 
square wave with amplitude varying between 300-600, 
600-900 and 900-1200 rpm are used as the tested command 
signal. The experimental rotor speed responses 
corresponding with aforementioned command under 
without encoder sensor are shown in Fig.10 to Fig.12. The 
results show that all the rotor speed track the output of 
reference model well after 1-2 period square wave 
command in different running speed condition of the 
PMSM. Thus, the experiments in Figs. 7~12 demonstrate 
that our proposed DSP-based sensorless PMSM drive 
control system using AFC is effectiveness and correctness. 
2394 2009 Chinese Control and Decision Conference (CCDC 2009)
