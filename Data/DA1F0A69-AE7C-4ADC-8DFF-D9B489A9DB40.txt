國科會專題研究計畫成果報告
兼具效率與準確性的兩階段新型網路蠕蟲偵測
計畫主持人：陳彥錚 國立暨南國際大學 資訊管理學系
計畫編號：97-2221-E-260-012-
摘要
網路蠕蟲威脅日趨嚴重，常常造成網路與電腦主機無法正常運作，如何有效偵測網
路蠕蟲降低對網路與電腦之傷害是一個重要研究課題。目前網路蠕蟲偵測技術包含主要
包括特徵比對和異常偵測兩類技術，特徵比對藉由從網路擷取的封包內容比對已知的蠕
蟲特徵字串找出可疑網路蠕蟲封包，此方法可以獲致較高的準確率和低誤報率，然而特
徵比對通常需耗費大量的計算成本。異常偵測技術則藉由平時網路訊務的統計分析，建
立正常訊務的行為模型，當網路蠕蟲大量出現造成網路訊務異常時，異常偵測系統便能
發現網路異常行為，進而得知網路蠕蟲之存在，使用異常偵測技術偵測網路蠕蟲通常具
有較高的誤報率。本研究計畫提出一個結合異常偵測與特徵比對技術之兩階段蠕蟲偵測
機制，第一階段採用較有效率的異常偵測機制，利用訊務流的統計分析建立網路訊務動
態基線，在事先無須得知任何蠕蟲特徵條件下，先過濾出可疑的訊務。第二階段為特徵
萃取比對階段，針對第一階段所篩選出的可疑訊務，依據網路蠕蟲之流行性、分散性、
以及主機掃瞄的特性進行特徵萃取與比對，找出新型網路蠕蟲之特徵，並將特徵回饋至
第一階段較大範圍的訊務資料進行特徵比對，以期找出受網路蠕蟲感染的主機。
關鍵詞：網路蠕蟲，網路安全，異常偵測
Abstract
Internet worms have become a major threat to the Internet due to their ability to propagate
themselves rapidly among numbers of Internet hosts. Many Internet worm attacks will cause
malfunctions in hosts and networks. Therefore, it is important how to detect Internet worms
effectively. Current worm detection technologies can be classified into: signature-based and
anomaly-based ones. Signature-based detections find worms by recognizing the known
features or sub-strings appearing in the payloads of worm packets. Signature-based detection
systems can effectively detect known worms but usually consume many computing resources.
Anomaly-based detection systems build baselines of normal network traffic and use them to
distinguish worm traffic from normal ones. The dispersion of many Internet worms usually
introduces a lot of network traffic in a short period of time. Thus, anomaly-based detection
systems can be used to detect such worms, especially zero-day worms, i.e. new worms
unknown previously. In this project, we will propose a two-stage worm detection scheme
based on both detection technologies. In the first stage, the proposed scheme uses flow-based
baseline analysis of network traffic to find the abnormal time intervals when worm traffic
may happen. Then, in the second stage, signature-based techniques are then applied to
analyze the suspected traffic based on the prevalence, dispersion, and host scanning
characteristics of worms. The extracted worm features are further feedback to the system to
identify the victim hosts. With both advantages of the two detection methodologies, the
proposed two-stage scheme achieves better performance and higher accuracy.
Keywords: Network worm, Network security, Anomaly detection
的 NetFlow 工具[19]，蒐集訊務流資料。第二階段為特徵萃取比對階段，此階段針對第
一階段所篩選出的可疑訊務，進行進一步的特徵萃取與比對，我們將利用網路蠕蟲之流
行性(Prevalence)、分散性(Dispersion)、以及主機掃瞄(Host Scan)的特性，找出新型網路
蠕蟲之特徵，由於此新發現之網路蠕蟲特徵只針對第一階段所篩選之部份可疑訊務，我
們將此特徵再回饋(Feedback)至第一階段較大範圍的訊務資料進行特徵比對，以期找出
受網路蠕蟲感染的主機。此兩階段式的網路蠕蟲偵測機制，具異常偵測技術之高效率
性，以及特徵比對技術的高準確率與低誤報率，是一個計算成本較低又能有效偵測未知
網路蠕蟲之蠕蟲偵測機制。
三、文獻探討
近年來網路蠕蟲的相關研究[8]認為一套可靠的偵測系統必須包含四種應變能力，
分別是(1).全面性和可信賴的安全偵測機制，能處理各種已知網路蠕蟲可能發生的情形
[9, 10]，(2).整合性的架構，且能分散式環境下偵測出網路蠕蟲[11]，(3).能偵測出未知
的網路蠕蟲 (Zero-Day Worm)和分散式阻斷服務攻擊 (Distributed Denial of Service
Attacks)，(4).能有效率的找出蠕蟲特徵和蠕蟲的流行性，且能順應外在網路環境變化進
行擴充模組[12, 13]。在早期，利用單一主機找出網路蠕蟲特徵的相關研究，Early Bird
系統 [14]有不錯的表現，Early Bird系統用特徵(fingerprint)的演算法比對蠕蟲的封包中
重複出現太多次的二進位字串片段，而這些找出來的字串可視為網路蠕蟲封包的特徵，
該系統的優點在於能正確的找出網路蠕蟲的特徵，但其缺點在於必須於網路上佈置很多
蠕蟲感應器(Sensor)，而且這些蠕蟲感應器彼此獨立，並不互相交換資訊，對於用在大
型網路環境之管理上面，網路節點上必須佈置為數眾多的感應器，建置成本非常高。2004
年Hyang Kim和Brad Karp也提出了一套能夠自動化偵測網路蠕蟲攻擊的系統：
Autograph[15]，此套系統透過傳輸層封包的擷取，成功的找出網路蠕蟲封包的特徵，該
系統還能利用廣播的方式，告知其他感應器收集這些掃瞄弱點主機的封包，並進行封包
內容的比對工作，由於Autograph透過比對封包內容找出蠕蟲特徵，因此與Early Bird系
統一樣，具有很高的正確率和很低誤判率的優點，然而其缺點同樣在在封包內容比對必
須耗費太多計算資源，當蠕蟲正在爆發大規模感染時，系統無法即時的應付龐大的網路
流量，另外Autograph也必須在網路佈置很多感應器，因此建置成本高。類似Early Bird
系統和Autograph在網路佈置感應器的蠕蟲偵測方法還有糖罐(Honeypot)技術[16]，該技
術也常被入侵偵測系統(IDS)廠商用來找出入侵攻擊封包特徵，是種被動誘捕技術，顧
名思義，Honeypot技術在網路上放置作為誘補蠕蟲或入侵攻擊的糖罐主機，網路糖罐的
系統記錄記載糖罐所有資料通訊的詳細內容，蠕蟲攻擊資料也不例外，此偵測方式優點
是能夠記下完整的蠕蟲攻擊記錄，作為日後判斷蠕蟲特徵的重要依據，缺點是受限於太
被動，如果沒有入侵者跟糖罐進行過通信，就無法取得入侵攻擊的資訊，此外，使用糖
罐技術必須在多個子網路佈置糖罐主機，需額外的建置成本。
上述著重逐一封包特徵萃取與比對之研究，在蠕蟲偵測上通常能獲致較高的準確
性，但必須耗費相當的計算資源，對於突然暴發的Zero-Day蠕蟲攻擊可能因計算資源不
足而無法即時偵測。相對於特徵比對偵測系統，另一類則是異常(Anomaly)流量偵測系
統，基本上是利用統計方式[17, 18]，平常統計正常網路流量建立基準，當有異常流量
發生，與正常流量基準嚴重偏移時，網管人員就很容易察覺異狀。當網路蠕蟲進行攻擊
時，若產生大量網路封包，便很容易被異常偵測系統所偵測，這種偵測方式的優點是系
統不需逐一地比對封包內容，也不需事先建立蠕蟲特徵資料庫，對於突然暴發的
Zero-Day蠕蟲攻擊，不致於產生過量的計算成本，因此能獲致較佳的系統執行效率，另
外由於無需蠕蟲特徵資料，此方式也可偵測特徵未知的網路蠕蟲。由於造成流量異常原
的訊務，找出可能存在蠕蟲的訊務。基線(Baseline)分析是將一天分成多個時段並將每
天相同時段的正常流量計算其平均值，這些連續不同時段的流量平均值便形成基線；基
線反應網路正常行為下所呈現的流量變化，是一重要的流量指標。而一旦網路有蠕蟲發
生，網路訊務中由於加入了蠕蟲散佈的封包，網路之異常將直接反應於流量變化上。然
而，不同的蠕蟲影響流量程度不一，因此單從流量改變的觀察很難判斷是否有蠕蟲存
在，使用傳統以網路整體流量為基礎的基線分析，更難從中發現個別蠕蟲氾濫的情況。
傳統的基線分析通常都是依照每天網路流量狀況，制訂一套各時段相同的靜態基線和臨
界值，不管當天那個時段，只要網路流量有超過臨界值的時候，馬上進行告警動作，這
種靜態的基線誤判率很高，因為網路流量的高低往往跟隨著使用者的生活作息而改變，
像上述網路流量時高時低情形，如果使用靜態基線判斷流量異常，將會出現大量的誤
報，所以本研究計畫改採動態基線，取代傳統不因時段不同的靜態基線，一天中不同時
段雖然會有高低起伏的情形，但是不同天的同一個時段流量卻幾乎大同小異，因此我們
建議做基線計算時，可以取不同天的相同的時段進行平均，建構出針對「時段」、「通訊
服務埠號」和「基線分析項目」三個維度所計算出來的動態基線，取樣的天數越多，基
線之曲線越平滑，越能表達該通訊協定平均的使用情況。大部份的蠕蟲藉由固定的通訊
埠散佈，本計畫所採用蠕蟲偵測機制之基線分析對象為個別通訊埠流量，使用個別通訊
埠流量基線分析，將可直接查覺蠕蟲影響網路訊務的程度。並非所有的通訊埠有對應的
蠕蟲或安全漏洞，考慮系統執行效率，我們不需為所有的通訊埠建立基線分析，網管人
員可針對目前一些已知的蠕蟲的相關報告，以及電腦廠商公布系統安全漏洞資訊，決定
應進行基線分析之 TCP 通訊埠或通訊協定。
當我們選定蠕蟲可能所在的通訊埠進行網路訊務基線分析與蠕蟲偵測時，除了依時
段從 NetFlow 搜集訊務流記錄，尚包括四個工作：(1). 決定基線分析項目，(2). 計算訊
務基線值，(3). 訂定動態臨界值，(4). 找出受感染主機相關訊務。茲分述如下：
(1). 決定基線分析項目
我們從 NetFlow 的訊務流記錄之目的通訊埠(Destination Port)欄位可判別某一筆訊
務流記錄是否為基線分析的對象，此外我們尚需決定依訊務流記錄之哪一欄位進行基線
分析。訊務流記錄中記載某一訊務流的封包數目(Packets)及位元組數(Bytes)，蠕蟲的感
染行為是發送大量的封包，對網路流量而言，在蠕蟲感染時，不管封包數目或位元組數
均會增加，如果蠕蟲所散佈的封包非常小，而平常使用該通訊埠的正常訊務封包較大，
蠕蟲對位元組數目統計的影響較不顯著，不過封包數目則會明顯增加。相反地，如果蠕
蟲所散佈的封包比正常訊務封包大，位元組數目總數增加的情形會更明顯，此時封包數
目也會明顯增加。目前發現許多蠕蟲的封包較小，此種情形使用封包數目建立基線較容
易偵測蠕蟲的存在。考量蠕蟲的共通特性，可能的基線分析項目包括訊務流數目
(Number of flows)、封包數目(Number of packets)、封包大小(packet size)、訊務變化率
(differentiation) 等
(2). 計算訊務基線值
在一個公司或組織之企業內部網路，其網路訊務量是由一群具有集體相似行為的組
織成員所貢獻。隨著組織成員之作息，網路訊務通常會以一天為週期呈現規率性變化，
或有明顯的尖離峰分布情況。因此我們將每一天分成 m 個時段：I1, I2, …, Im，假設 Xi
為今日 Ii 時段之正常情況之基線分析項目 (例如封包數目)，我們以最近 n 天之訊務建立
基線，Xk,i 為最近第 k 天(1≦k≦n)之時段 i 的監測值，當有新的一筆正常訊務資料 Xn,i
進來時，新的基線值 Baseline(Xi)更新如下：
nXXXXAVGXBaseline iniiiki /)....()()( ,,2,1, 
在進行Baseline(Xi)更新計算時，我們必須先確定Xn,i是正常訊務的統計值，如果該時段
N)主機列為最有可能感染蠕蟲之主機群，N 可由下式決定：
}|min{
1
i
r
j
j fHrN  

上式意謂 N 為存在最小的 r 使得前 r 個主機的訊務量總和超過訊務偏離值 fi。一般而言，
fi 越大，滿足上式最小的 r 將越大，若所得 r 值小，則表示前 r 個主機遠較其他主機貢
獻更多的訊務量。針對所找出可疑的 Top N 個主機 H1, H2, …, HN，我們至 NetFlow 記錄
找出來源位址或目的位址包含這些主機的特定通訊埠訊務流資料，作為第二階段蠕蟲特
徵萃取比對之輸入資料。
第二階段：網路蠕蟲特徵萃取比對
大部份的網路蠕蟲為了能在短時間內感染網路的弱點主機，本身都會有一套搜尋的
演算法或是內建的網路位址清單，自動地掃瞄網路上的電腦。在這些找弱點主的動作
中，不論是內建演算法或是攻擊清單，都不外乎包含下列兩種特性[8][18]：(1).分散性、
(2).流行性，分散性是指已感染蠕蟲之主機，在傳播蠕蟲時，試圖與多少台主機建立連
線。流行性則是已感染蠕蟲之主機連結至其他主機後，這些主機是否有持續擴散的情
形。由於這些蠕蟲感染傳播的行為對應至 NetFlow 記錄是分散而不明顯的，我們必須考
慮這些 NetFlow 記錄的時間先後順序關係。當我們在前述步驟中找出可能爆發蠕蟲攻擊
訊務的時段和貢獻這些訊務的 Top N 後，此階段將就訊務的分散性與流行性進行進一步
篩選工作，以期在 Top N 中找出確切已經被網路蠕蟲感染的弱點主機和攻擊訊務的特
徵。訊務的分散性和流行性，可以從 NetFlow 記錄之下列四個欄位來找出關聯：分別為
訊務開始時間(Start)、來源位址(SrcIPaddress)、通訊協定(P)和目的端埠號(DstP)。以下
說明第二階段網路蠕蟲特徵萃取比對之執行步驟：
(1) 從 Top N名單逐一取出可疑的受感染主機相關訊務：針對前階段 Top N 的每一主機
位址，在 NetFlow 中找出以其為來源位址之訊務流記錄，這些訊務流的目的主機若受感
染，將也有類似的行為，因此我們再以相同方式取出相關訊務。
(2) 分散性(Dispersion)分析：找出相同來源位址(SrcIPaddress)、通訊協定(P)和目的端埠
號(DstP)的連結，並將訊務開始時間記錄下來
(3) 流行性(Prevalence)分析：使用步驟(2)中的目的端主機位址當來源端位址，重複找
出有用同樣通訊服務的主機，並依照時間先後的順序，計算出流行性的長度。
(4) 計算異常分數：當上述分散性和流行性程度很高時，我們可以合理懷疑所分析之可
疑主機確實受到蠕蟲感染，並且正在網路上進行蠕蟲的入侵攻擊，除了分散性和流行
性，我們發現大部份蠕蟲在傳染過程與其他惡意軟體(malware)一樣有隨機主機掃瞄
(Host Scan)行為，這些明顯的掃瞄行為在 NetFlow 會留下與未知主機建立連結的記錄，
這些記錄雖然無法在上述的分散性與流行性分析反應出來，卻是很重要的異常訊務證
據，有助於異常訊務偵測之準確性。
基於以上分析，我們提出一個用來計算主機異常分數公式，當分數越高時，代表網
路蠕蟲的攻擊行為越明顯，我們使用 wd、wp、wu 分別為計算分散性(dispersion)、流行
性(prevalence)、以及不存在的目的主機位址數(uDstIP)之權重值，這些權重值可依據不
同的網路使用情況進行調整。假設對 Top N 中某一主機，Dispersion 代表其對外掃瞄次
數，Prevalence 為傳播深度，dDstIP 為不存在的目的主機個數，則其異常分數(Anomaly
Score)為：
Anomaly Score = wd×Dispersion + wp×Prevalence + wu ×uDstIP
上述異常分數之計算，事實上也可以用來偵測 DoS 阻斷服務攻擊，像 TCP SYN Flooding
攻擊、「UDP Flooding attack」、「ICMP Flooding attack」和「ICMP Smurf Flooding attack」
都可以利用 NetFlow 找出。異常流量分數(Anomaly Score)後，當我們發現某台主機的異
圖 2 TCP 埠號 445 訊務量測結果
我們針對超過臨界值時段之可疑異常訊務進行第二階段的偵測分析，找出實驗的異常分
數超過 1 萬之訊務進行進一步分析流行性和分散性，我們發現受感染主機平均在 40 分
鐘內，試圖跟 3 萬台以上的 IP 位址建立連線，產生 9 萬多筆訊務，我們可以合理懷疑
這些電腦中了 Sasser 網路蠕蟲，其特徵為每筆訊務 Packet 數量為 2，Octets 大小為 96
位元組(如表 1 所示)。
表 1 TCP 埠號 445 受感染主機訊務特徵
感染蠕蟲主機 時段 特徵 出現次數 掃瞄電腦個數
10.10.189.50 00:40:00~01:20:00 Pkts=2, Octets=80 80567 34050
10.10.189.50 02:40:00~02:50:00 Pkts=2, Octets=96 13025 11210
10.10.189.237 16:30:00~17:20:00 Pkts=2, Octets=96 53246 28829
10.10.189.139 16:30:00~17:20:00 Pkts=2, Octets=96 46497 26970
10.10.189.237 18:40:00~19:10:00 Pkts=2, Octets=96 37048 23685
上述實驗結果證實本研究計畫所提之蠕蟲偵測方法能有效率的到真正的蠕蟲攻擊
行為，我們針對不同偵測階段使用不同偵測方法，同時兼顧了蠕蟲偵測的效率與效度，
因此本研究計畫所提偵測機制主要貢獻包括：
(1).系統擴充性高，適應大的網路環境：偵測系統所分析的資料來源為網路骨幹路由器，
可以監控的範圍大，且分析的資料為訊務流非原始封包資料，不會造成系統過量的負
擔，並可以觀察更多使用者之間的關連性，如分散性和流行性等，分析將更準確。
(2).分析資料標準化：NetFlow 為網路設備大廠 Cisco 公司所提出，有標準的資料格式規
範，支援的設備眾多。
(3).節省計算時間：透過階段性的處理網路訊務，先針對整體網路使用情形進行監控，
當有發生異行為時，才需要進一步分析網路主機的個別使用情形，針對不同的網路症
狀，對症下藥，節省不必要的分析計算時間。
(4).能偵測出未知的網路蠕蟲：傳統的異常流量分析的好處在於能找到未知的網蟲攻
擊，但是誤判率很高，本計畫所提機制除了能偵測未知的網路蠕蟲，還能維持很低的誤
判率。
(5).提出動態基線和合理的臨界值的計算方式：以往的基線分析和臨界值方式訂定過於
主觀，且無法看出個別通訊服務的特性因此本論文提出針對不同時段和不同通訊埠號建
立基線，可以依據不同時段觀察網路的尖離峰情形，還能瞭解各個通訊服務的使用狀
況，並依據該時段封包的差異性訂出合理的臨界值，大幅提升蠕蟲判斷的準確率。
(6).找出網路蠕蟲特徵，並具回饋能力：透過訊務特徵的收集，找到正在網路上進行大
規模感的蠕蟲，並回饋至偵測系統找出具相同特徵的蠕蟲入侵攻擊行為。
