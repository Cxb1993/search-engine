2 
 
( , )I x y 與高斯平滑函數 ( , , )G x y  $的 convolution 計算，模擬影像特徵在不同尺度
時的影像 ( , , )L x y  ，以模擬影像尺度 的變化。 
 
-( )/
( , , ) ( , , ) * ( , )
( , , )
2 2 2x y 2
2
L x y G x y I x y
1
G x y e
2
 
  
 

 (1) 
當高斯函數的 σ值越大，表示其計算 convolution 的面積也隨之擴大。為降低在
高尺度值時的龐大的運算量，我們透過影像壓縮的方式，以壓縮過的畫面計算
Gauss 函數的 convolution。維持固定計算量的前提下，不斷增大影像壓縮的比例
(以實際作法為例，每增加一倍，則壓縮影像為原來的一半)，並在原有的二維
像素座標，加入 scale 成為第三個影像座標，則 SIFT 的尺度空間將呈現金字塔的
形式(圖.1)。 

 
圖.1  尺度空間(Scale Space) 
尺度愈大，代表著將攝影機與目標物的物距以模擬的方式拉遠，故影像將因此逐
漸模糊(圖.2)。 
4 
 
Scale
(第1層)
Scale
(第2層)
Gaussian Difference of Gaussian (DoG)
 L x , y ,  D x , y ,

 
圖.3  DoG 示意圖 
Brown and Lowe(2002)以 3D 的二次多項式，近似 scale-space 中特徵點的 DoG 值
的分布.並以泰勒展開式： 
 ˆ ˆ ˆ ˆ( ) ( )
T 2
T
2
X X
D 1 D
D X X D X X X X
X 2 X
 
   
 
 (3) 
近似單一特徵點附近的 DoG 變化，其中  , ,
T
X x y  是特徵點的位置向量，而 Xˆ
代表偏離特徵點 X 位置的偏移量(offset)。當 DoG 達到局部最大(小)值的 Xˆ 值，Xˆ
可自下式獲得： 
 
-
max/ min
ˆ -
12
2
D
0
X
D D
X
X X



 

 
 (4) 
使 DoG 成為局部最大(小)值的最佳化特徵點偏移向量 Xˆ (4)帶入 DoG 公式(3)，可
以得到對應的局部 DoG 最大或最小值 ˆ( )D X X ： 
 ˆ ˆ( ) ( )
T1 D
D X X D X X
2 X

  

 (5) 
6 
 
的特徵點，才能辨識在各畫面中的相同物體其移動位置。為能區分特徵點之間的
差異，必須定義一項能代表特徵點內容的數學表示法，即所謂的 descriptor。 
Descriptor 能以簡短的方式代表一個特徵點的影像內容，以降低篩選相同特徵的
計算量。使得電腦程式僅需比對兩個特徵點少量的 descriptor 內容，即可判斷特
徵點間相似或相異的程度。 
 
特徵點
影像梯度
特徵點
descriptor
 
圖 .4  Descriptor 示意圖 
對特徵點附近的梯度分佈(圖 .4)以 4X4 像素為一組，合併成一個八方向的向量集
合，在上圖中合併成 2x2=4 個八向量和，共 2*2*8=32 個特徵點描述向量用以描
述該特徵點。實際上，因為 32 個分量的描述向量其唯一性不足，所以一組縮小
為 2*2 像素的面積，同樣以 8 個分量的向量代表。每個特徵點以具有 4*4*8=128
個分量的特徵點描述向量代表，以提高代表特徵點所需的獨特性。 
2.3 特徵點篩選 Feature screening 
在 vSLAM 演算法中，特徵點為輔佐攝影機定位的工具，其分佈的位置與穩
定性才是增進定位精確度的主要條件，大量的特徵點並無法對系統產生更多的助
益，相反地，數量的多寡最直接影響到的反而是運算的速度，特徵點愈多，計算
量相對愈大，所以對於特徵點的篩選相形之下更顯得重要。 
8 
 
 
圖.7  large scale 的特徵點(左右影像間隔為 1/30 秒) 
scale 1 2 3 4 5 6 7 8 
數目 86 335 88 30 20 19 12 4 
 
9 10 11 12 13 14 15~25 26 
5 2 1 3 1 3 0 1 
表.1  scale 層數與特徵點數目統計 
在研究中，攝影機所擷取的影像畫面尺寸為 320x240，經使用 SIFT 提取特徵
後，最高層數的 scale 值通常在 25 ~ 26  之間，藉由多次實驗與測試後，本論
文將篩選的門檻值下修到 7  ，將此層 scale 以上所偵測到的特徵點，視為較佳
的特徵點。 
3.4 特徵點匹配( Feature Matching) 
所謂特徵點匹配，即是將兩個影像畫面中具有相同特徵描述區域的特徵點
作對應，判斷該特徵點是否為不同畫面中的同一特徵點。此時，描述特徵點區域
內容，具有高度獨特性與代表性的 descriptor 即可利用來達成此目的。所使用的
比對方法是檢查前後兩個特徵點(假設為 A 與 B)的 descriptor 向量(公式(9))的
Euclidean distance(公式(10))，如果兩者的 Euclidean distance 低於預設的門檻值
時，即視為出現在前後畫面的同一特徵點。 
 ˆ ˆ{ } , { } , ~
i iA a B b
d d d d i 1 128    (9) 
10 
 
 
圖.10  large scale 的特徵點匹配結果 
正確匹配的特徵點將成為感測器獲得新的量測值 kz ，因此，藉由公式(12)攝影機
運動模型預測特徵點的位置與量測值的差異。 
 -k k kv z h  (12) 
其中下標 k 值為時間點。 kv 為量測過程的 innovation； kz 是目前影像特徵點的實
際位置； kh 為目前特徵點的估計位置。 
如圖 .11 所示，攝影機移動到新位置，並重新觀測 B、C 特徵點。圖中表示
的橢圓區域範圍為代表攝影機與特徵點 A、B、C 位置尚未更新前的不確定性。
而 B、C 特徵點在影像中的位置則分別為圖 .12 中的 'B 與 'C 。因此，藉由 'B 、 'C
以及 Bh 、 Ch ，即可求得更新過程所需的 kv 值。 
 
圖 .11  攝影機重新觀測到 B、C 點 
12 
 
( , )i im  
x
C
y
z
h
h h
h
 
 
  
 
 
1
( , )
i
i i i
i
i
x
y m
z
 

 
 
 
 
 
1
i
i
d


WCr
( , )WC WCr q
W
'C
i
i
i
x
y
z
 
 
 
 
  i
WC
i
i
x
y r
z
 
 
 
 
 
參考座標

C
cos sin
( , ) sin
cos cos
i i
i i i
i i
m
 
  
 
 
 
  
 
 
 
圖 13  Inverse depth parameterization 
其中: 
i
：特徵點的方位角(azimuth) 
i
：特徵點的仰角(elevation) 
i
：特徵點的深度倒數 
T
i i i
x y z ：攝影機第一次觀測到特徵點時所在的位置 
WCr ：攝影機的 3D 位置 
WCq ：攝影機的方位(orientation)，以 quaternion 表示 
Ch ：特徵點相對於攝影機的向量 
14 
 
間點 k瞬間，移動過程中皆有一高斯零均值的加速度 W
k
a 及角加速度 W
k
造成 pulse 
disturbance 干擾速度 W
k
V 及與角速度 W
k
，所以動態系統的速度與角速度 n 定義
為: 
 
W W
k k
W W
k k
V a t
t
n  (17) 
攝影機的更新狀態為 
 
1 1
1 1
1
1
( )
(( )
ˆ
k
WC WC W W
k k k k
WC WC W W
k k k k
W W Wv
k k k
W W W
k k k
r r v V t
q q x q t
x
v v V
 (18) 
定義
n
P 為雜訊 n 向量的協方差矩陣，藉由調整
n
P 值的大小，可以定義所預
期的攝影機移動平滑度。較小的
n
P 表示攝影機加速度較小，移動過程較平滑，
系統的不確定性收斂快，定位亦較準確，但無法處理突然的快速移動；而較大
n
P
的則表示攝影機的加速度大，移動較快，故系統的不確定性增加較明顯，雖可處
理攝影機快速移動的問題，但系統的不確定性收斂慢，且更需要精確的量測結果
來增加估測的穩定度。 
3.7 空間位置估測  
首先藉由 inverse depth 的量測方程，依據攝影機當前估測的狀態參數(包含位置
參數 CW
kr 及攝影機的旋轉矩陣
CW
kR )，及前一個時間點量測所得的特徵點參數
 i i i i i ix y z    推算出當前空間中特徵點相對於攝影機的位置向量
R
Lh 。再將
空間向量 RLh 轉換成為攝影機影像中的  ,u v 座標值，需配合透視投影幾何的針
孔成像原理( pinhole model)： 
16 
 
 k kk k
Th h
S P R
X X
  
 
 (21) 
其中 R 為影像本身的雜訊構成的對角線協方差矩陣，即是所謂的量測雜訊，
藉由調校 R 值的大小，能夠改變卡爾曼增益 kK 值，即系統預測值與量測值之差
對系統影響的權重。R 值愈小， kK 值愈大，則量測值的可靠度相對提高，系統
對預測值的信任度則相對降低，反之 R 值愈大，表示量測雜訊愈大，將導致系統
愈不相信量測值。 
由公式(21)所求得的協方差矩陣 kS 表示影像中各特徵點的 2D 高斯機率密度
函數，能夠在影像中分別定義出一橢圓範圍表示該特徵點最有可能的落點區域。
如圖.15 所示， Bh 和 Ch 分別為只單純利用攝影機的估測狀態與上個時間點的特徵
點資訊所推測出的特徵點位置，其值則分別位於橢圓圓心，由 kh 畫出，表示高斯
分佈的期望值； BS 及 CS 則分別為由 kS 的變異數值畫出，表示特徵點高斯分佈的
離散情形，也就是特徵點位置的機率值。 
(a) (b)
S
B
C
S
B
S
C
P’
P
Ch
Bh
 
圖.15  特徵點預測 
3.8. 以慣性測量裝置(Inertial Measurement Unit, 簡稱 IMU)估計攝影機空間方向 
我們使用慣性測量裝置推算攝影機空間方位(orientation)，由於慣性作用造成的
常見 IMU 裝置是以 3 軸陀螺儀與 3 軸加速規組成，我們另行加入一組 3 軸地磁
18 
 
計算 roll 角度 : 
 sin , cos
cos cos
b b
y z
a a
 
經過半角公式後，可得 roll 的 quaternion rq  
 cos 1 0 0 0 sin 0 1 0 0
2 2r
q  
由於還有 yaw 的角度還無法從加速度計算，我們還需透過磁力計的測量值 
 
b
b b
y
b
x z
b
b
m
m m m m
m
 
計算 yaw 角度。利用上述過程所求出的 roll 與 elevation (pitch) quaternion 
r
q , 
eq 。我們使用利用 quaternion 的旋轉計算，將代表磁場單位方向向量 bm 的
quaternion bm 還原為尚未施以 pitch 及 roll 旋轉的方向角度 'bm  
 1 1'b b
e r r e
m q q q qm  
其中 代表 quaternion multiplication，而 bm 是改成 quaternion 表示法的磁場方向
單位向量 0b b b b
x y z
mm m m 。由於 b
z
m 僅受到 yaw 角度 的影響，故
b n
z z
m m 。進一步簡化為 2D 的問題: 
 
cos sin
sin cos
n b
x x
n b
y y
m m
m m
 
由於可查得地球磁場的單位方向向量
x y
N N (USGS National Geomagnetism 
Program)與 IMU 的磁場測量單位向量
x y
M M ，利用兩者具有旋轉 角度前後
的關係，求得 azimuth 角度 的 cos 與 sin 值: 
20 
 
的 ADC 取樣後，透過 RS-232 傳到筆記型電腦端。IMU 與攝影機安裝在同一腳架
上，測量攝影機的運動角度。 
 
圖 17. IMU 模組 
3.10 攝影機參數校正 
為確定攝影機的光學參數以利推算目標空間距離，我們使用 Camera 
Calibration Tools (http://www.doc.ic.ac.uk/%7Edvs/calib/main.html)校正攝影機。校
正過程運用一 2D 平面校正物上所印製的已知圖形，透過攝影機拍攝該平面在各
個不同角度影像(圖 18)，使用該工具即可求得攝影機參數(表 2)。 
22 
 
4. vSLAM 定位結果 
 位驗證前述計算方法的正確性,我們以 C code 進行 SIFT 與 feature matching
的工作，而 Matlab code 負責 orientation 與 depth 的計算以及結果的呈現。我
們針對近 (1 公尺)，中(5 公尺)，長距離(10 公尺)進行影像定位與測距。在移動的
攝影機上完成全部的實驗。在短距離的實驗中(圖.20)，由於特徵點與攝影機的距
離短，只要有小幅度的攝影機運動，就會產生可觀的特徵點位移，使得 Kalman 
filter 所估計的目標特徵點在空間的位置，可以迅速地收斂到可信的範圍內(圖上
橢圓尺寸與 variance 成正比)。 
在中距離(圖 21)及長距離(圖 22)的定位實驗，由於特徵點的畫面位置變化
小，相對地需要較多的 frames 才能使定位可靠度降低到相同的程度。 
從機械人導航的角度思考，由於距離較近的目標物與機械人碰撞的機會較
高，以上述方法判斷目標物，可以較快偵測出相對機械人的位置，對於機械人避
障是一項優點。而遠距離的目標物需要較長的時間，雖然需要較長的時間，才能
得到可信的距離值，但是其方位角在短期即可確定。此現象可從短,中,長距離的
實驗結果(a)察覺。因此，從影像特徵所估出的 keypoints 方位角，可以做為
landmark 導航。 
 
圖.20  近距離影像定位:攝影機畫面(a)與路徑軌跡(b)(100 個 frames 後的收斂狀
況) 
