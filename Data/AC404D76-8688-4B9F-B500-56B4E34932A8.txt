I中 文 摘 要 ：
由於在資料通訊網路的技術迅速進步，特別是在網際網路上。使得網路在工業與商
業的應用越來越多，由於網路化可以帶來許多優點，如節省配線，減少安裝和維護的成本
與增加監控的距離。但是將控制系統網路化之後，也帶來了時間延遲(delay time)、資料遺
失（data dropout）、取樣週期降低…等等的問題，這些問題輕則降低系統效能，重則使整
個系統產生不穩定或是無法控制。本計畫建構了整合 Ethernet 和 CAN 兩種不同協定的網路
之網路控制系統平台，以實驗分析此異質性網路的時間延遲特性，提出即時量測網路時間
延遲的方法導入傳統 Smith Predictor 的時間延遲項，將此時間延遲項變更為適應性的補償
方法，此適應性 Smith predictor 再結合 PI 或 QFT 控制器，可克服實際網路控制系統因不
同之隨機與漂移時間延遲所造成的控制性能劣化，達到可靠的 NCS 控制性能。實際與模擬
應用於一 AC 伺服馬達驗證本研究發展之位置迴路控制器，可達到精密之控制效能。
關鍵詞：網路控制系統、時間延遲、適應性 Smith Predictor 加 PI/QFT 控制器
1一、前言：
近年來隨著網路的興起，相關的應用越來越多，由於網路化可以帶來許多優點，所以
在現代工業中的工廠自動化與工業電子已經逐漸獲得重視，透過網路資源將控制系統中的
裝置利用公用匯流排連接，使網路控制應用能方便與系統地被保持，甚至達成廣域化的分
散式控制系統。隨著控制系統規模擴大與網路技術的發展，控制系統網路化是必然地發展
趨勢。由於採用現有的網路構成控制迴路，在網路的覆蓋範圍與成本上的優勢，使得網路
化控制系統具有極大的應用價值。隨著網路負載改變和網路設備性能的變化，數據資料傳
輸的時間延遲也會隨之改變。而時間延遲的特性也隨著兩個通信節點間的傳輸距離和路由
的路徑而有所不同。
回授控制系統若是其控制迴路與回授迴路都經由網路來做傳輸媒介，則此控制系統稱
之為網路控制系統(networked control system, NCS)，其中使用的網路可能是有線網路如
Ethernet [1]或是無線網路如 IEEE802.11、 Bluetooth、GPS、CDMA、GSM…等，也可以是
工業用網路如 CAN、Profibus、ControlNet、P-NET、Foundation Fieldbus…等等[2]。除了點
對點的傳輸外，可利用公用匯流排網路提供更有效率重新配置，更好的資源利用，以及降
低安裝和維修費。網路控制系統主要的優點是簡化系統導線，便於系統診斷和維修，並且
增加系統的穩定度。在網路控制系統中，網路所引起的延遲是在感測器、致動器和控制器
間透過網路交換數據資料時所發生的。直接回授控制系統和網路化控制系統的結構比較：
(一)直接回授，以假設時間延遲在一個取樣週期內變化，並且時間延遲的分佈特性已知，
但對於網際網路，這些假設不再成立；(二)網路化控制系統的本質問題在於消除網路時間
延遲對系統性能的影響。目前網路控制系統的研究方向主要分為兩個部分：(1)以網路角度
出發，提出改善網路性能的方法；(2)以控制系統角度研究，設計控制器補償網路時間延遲
對系統穩定性和性能的影響。
Baillieul, J.與 Antsaklis, P.J.，提出網路及時控制系統於控制與通訊的挑戰 [3]，而 S.
Tatikonda, 與 S. Mitter, 說明控制於通訊系統下的限制[4]。所提的缺點，目前都有許多研
究成果，並且提出解決方法來改善。Feng-Li Lian 等人研究先判定有幾個時間延遲的關鍵
元件，然後去分析網路的協定和控制的動態，網路和控制參數的分析被使用來決定取樣週
3後，也帶來了幾個缺點，例如時間延遲(delay time)、資料遺失（data dropout）、封包碰撞、
取樣週期降低…等問題，這些問題沒有處理好，輕則降低系統效能，重則使整個系統產生
不穩定或是無法控制的情形，這些問題都是網路控制上的重要課題。因此，在網路控制系
統中所產生的時間延遲問題是施行遠端監控時所必須克服的一個難題。除了因為取樣週期
的選擇造成網路控制效能不好以外，網路控制還有其他因素也會造成控制效能不佳，先前
所提的缺點，目前都有許多研究成果，並且提出解決方法來改善。資料封包的遺失，會造
成控制系統的命令遺失，有人提出使用泰勒展開法來估測遺失的命令，使得系統不會因為
命令遺失而造成系統控制效果不佳；至於時間延遲(Time Delay)對於網路控制系統的性能有
嚴重的影響。有幾種情形，可能會引起時間延遲。第一，通訊通道的有限制的鮑率會造成
傳輸延遲(Transmission Delay)”。第二，網路控制系統的通訊通道常被多的資料來源一起分
享使用，而常使用的方法，則是將通道(Channel)以分時(Time-Division)多工(Multiplexed)的
方法來使用，因此，當通道是忙碌佔線時便會引起存取延遲(Access Delay)，而這是網路控
制系統主要的時間延遲來源。第三，對於網路控制系統而言，有些處理延遲(Processing Delay)
和傳輸延遲(Propagation Delay)有時被忽略。在先前研究中所量測網路之時間延遲發現長距
離控制的平均延遲時間是有較大變異性的，亦即多人存取網路資源，使延遲時間急速增加，
而使整個性統的控制性能發生劣化。因此本計畫，將使用即時量測時間延遲導入Smith
predictor，同時使用PI或QFT控制器的設計來探討並克服網路時間造成系統的性能劣化，達
成控制的目標。
三、研究方法及進行步驟：
網路控制系統的架構如圖(一) 所示，然而控制導入了網路後，有通道干擾、線路有限
的頻寬與封包碰撞…等等的問題，其衍生的問題，最明顯的就是延遲時間(time delay)，不
確定的時間延遲的會存在於感測器，致動器和控制器之間。時間延遲的特性可能是固定的
常數，或是在有界間地變化與隨機的，取決於採用的網路協定和選擇的硬體。因此，時間
延遲的發生是不可避免的。
在網路中傳輸訊息主要的時間延遲可分為硬體設備延遲以及網路時間延遲。設備時間
延遲包括操作端與受控端，是由操作端的前處理的時間和等待時間
5接到封包後記錄到達時間，並且根據封包上面的 Index 找出發送時的起始時間，將到達時
間跟起始時間相減即可求得延遲時間。有關 Ethernet 與 CAN 的封包轉換過程如圖(三)所
示，從 DSP 送出之 CAN 的封包，經由圖(三)中(1)(2)(3)的順序即可將訊息完整的傳送
到Client控制端。若從Client控制端傳送訊息到DSP經由反向的順序如圖(三)中(4)(5)(6)
的步驟即可完成訊息的傳遞。
圖(二) 網路控制系統時間延遲示意圖
圖(三) Ethernet 與 CAN 的封包轉換
實際測試 Client 與 Server 間的網路時間延遲，首先測試 NCTU Lab<->NCTU Lab, 接
著再測試 Client 與 Server 間隔約 15km，Client 端使用 Cable Modem 8Mbps 的網路。考慮
網路控制系統與架構，這裡我們的延遲時間是從應用層到應用層（application layer），亦
即如研究方法中所述 T1+T2 的總和，其中 T1 和 T2 延遲時間為每個端點的應用層到另外一
邊應用層加起來的總和。實驗中皆使用華碩筆記型電腦中的內建網路卡 (Realtek
RTL8139/810x Family Fast Ethernet NIC)，使用有線網路 Ethernet 加上 CAN 網路，先針對
了不同的距離但取樣時間固定為 20ms 作測試，其測試結果說明如圖(四)所示 ，其為不同
距離的網路時間延遲分布，由圖中可以發現網路時間延遲是隨使用情形而變化，其變動之
邊界值與隨機特性，比較校園網路與 Cable Modem 網路，Cable Modem 有較大的時間延遲
變異量，且因為距離較遠會經過 router 與 Switch…等等網路設備而使網路時間延遲增加;
同時多人存取網路資源也會使網路時間延遲增加。
7圖(七) 結合Adaptive Smith Predictor+ PI 控制器之控制方塊圖
傳統 Smith predictor 在具有在固定的時間延遲或時間延遲變異量不大時，補償延遲時
間的影響有不錯的效果[9]。由前小節網路時間延遲分析中，實際上在長距離控制時，平均
延遲時間是有較大變化性的，在多人存取網路資源，但網路頻寬有限的條件下，而使延遲
時間急速增加，讓整個性統的控制性能發生劣化。Ethernet 網路中時間延遲隨使用情形而
變化，為建立 NCS 不可避免之問題。結合前一小節網路時間延遲的量測技術，達成網路時
間延遲的估測，再將 Smith Predictor 的時間延遲項，變更為 adaptive 的補償方法，改進了
以固定延遲時間補償之 Smith Predictor 之網路控制性能[10]，同時結合 PI 控制器，其控制
方塊圖如下圖(七) 所示。
(一) 網路時間延遲估測器之設計:
主要是利用先前所介紹之量測延遲時間的方法，是由DSP端固定一段時間傳送帶有
Index的資料封包來求得延遲時間，由於融合CAN與Ethernet兩種異質性網路，主要的設計
規劃被限制於CAN網路，因為CAN網路強調即時性，其訊框的資料欄位長度只有8 bytes，
但我們所需資料最小需求為9 bytes，下圖(八) 所示。
圖(八) 訊框資料的規劃
9一個具有時間延遲的系統，經由 Smith Predictor 控制器的補償後，在 )()(ˆ sGsG pp  與 Pm tt 
條件下，整個閉迴路控制系統之轉移函數如下
tpS
CP
CP e
sGsG
sGsG
sR
sY 


)()(1
)()(
)(
)( (3)
圖(十一) 等效控制系統方塊圖
而此時間延遲項( Pt )，已經從閉迴路控制方塊圖中獨立出來，變成單純的時間延遲項，
由圖(十一)的等效系統方塊圖可知在設計控制器 Gc(s)時，不須再考慮到時間延遲的影饗，
這 是 Smith Predictor 的 一 個 大 特 色 ， 本 文 所 設 計 Gc(s) 為 PI 控 制 器
00000001.0,0001.0  ip KK 。另外，由先前的分析資料可以發現網路的時間延遲 tp 於實際上
並非固定不變，會隨網路使用情形而變化，因此 tm 網路時間延遲的補償也應該跟著變化，
否則無法將時間延遲項獨立等效出來，而影響控制性能，所以將 Smith Predictor 的時間延
遲項，變更為 adaptive 的補償方法，運用上小節之網路延遲估測技術，來改進固定延遲時
間補償之 Smith Predictor 之網路控制性能。
(三) QFT 控制器設計:
由於實際實驗環境不可能得到精確的系統模型與即時而正確的時間延遲估測，依據先
前實驗分析 Ethernet 時間延遲特性，得到其變動為有界的隨機特性，量化迴授理論
(Quantitative Feedback Theory , QFT)是較適合於已知參數變動範圍的設計方法[11,12]，將此
方法應用於網路控制系統上，先將有界的時間延遲變化則找出上界與下界，使用一階 pade
近似法則，將網路時間延遲視為此系統的不確定參數變化，利用此不確定性與受控體參數
變化結合並給予之系統輸出性能規範，在尼可士圖上設定穩定及追蹤邊界後，再利用迴路
整形來求得控制器；最後再都加上一前置濾波器，來達成整體系統的設計要求，其控制方
塊圖如下圖(十二)所示。
)(SGP
)(SD
tpSe Y(s)
R(s)
)(SGC+
-
+
11
圖(十五) 穩定及追蹤邊界 圖(十六) 整體系統之頻率響應
四、結果與討論：
將上述方法實際應用於一 AC 伺服馬達之位置迴路控制器驗證其控制效能，分別實際
測試 PI 控制器、傳統 Smith Predictor 加 PI 控制器(傳統 Smith Predictor 係指先量測網路時
間延遲，將此時間延遲固定補償於 Smith Predictor 時間延遲項)與適應性 Smith Predictor 加
PI 控制器對於實際較小時間延遲(NCTU Lab <-> NCTU Lab)和較大時間延遲(NCTU Lab
<-> Hukuo)的控制性能做比較，其實驗結果如下：
首先對於三者控制器於交通大學實驗室內的測試紅色為控制命令訊號，黑色為位置實
際輸出訊號，三者控制性能接近如圖(十七) (a)~(c)所示，主要的原因為網路時間延遲很小，
幾乎都小於取樣週期(20ms)如圖(十七) (d)所示，接著實驗較遠距離，Client 端與 Server 端
約相距十五公里，可以發現 PI 控制器與傳統 Smith Predictor 加 PI 控制器，當網路因多人
存取造成時間延遲增加時，會發生控制性能劣化，造成系統變成不穩定，如圖(十八) (a)與
(b)所示。而適應性 Smith Predictor 加 PI 控制器對於時間延遲的變化有較強健的控制性能，
其結果分別如圖(十九)。
0 2 4 6 8 10 12 14 16 18 20
0
0.5
1
1.5
2
2.5
3
3.5
4
x 10
4
Sec.
P
os
iti
on
(p
lu
se
)
PI Controller (NCTU Lab<=>NCTU Lab)
0 2 4 6 8 10 12 14 16 18 20
0
0.5
1
1.5
2
2.5
3
3.5
4
x 10
4
Sec.
P
os
iti
on
(p
lu
se
)
Classical Smith Predictor+PI Controller (NCTU Lab<=>NCTU Lab)
圖(十七) (a) PI 控制器之控制性能(短距離) 圖(十七) (b) 傳統 Smith Predictor 加 PI 控制器
之控制性能(短距離)
13
圖(二十) 修正型 Smith Predictor +PI 帶有實際漂
移隨機時間延遲
圖(二十一) 修正型 Smith Predictor +QFT 帶有
實際漂移隨機時間延遲
最後，將所得之系統模型與所設計之 QFT 控制器，進行分析與模擬，分別模擬適應性
Smith Predictor 加 PI、 QFT 控制器對於實際量測之時間延遲的控制性能做比較;其模擬結
果若使用適應型 Smith Predictor+ PI 或 QFT 發現其具有不錯的控制性能，但是當系統模型
或網路時間延遲估測不精準時，適應性 Smith Predictor+ PI 特性會變差如圖(二十)，而適應
性 Smith Predictor + QFT 仍能維持不錯的性能如圖(二十一)，本計畫所提之適應性 Smith
Predictor + QFT 對於不同時間延遲特性與不精確系統模型誤差和非即時補償 Smith
Predictor 的時間延遲項，具有較佳的控制性能。
五、成果自評：
 請就研究內容與原計畫相符程度：
本研究計畫已完成分析網路時間延遲對控制性能的影響與即時量測網路時間，並導入
傳統Smith Predictor 的時間延遲項，將此時間延遲項變更為適應性的補償方法，此適
應性Smith predictor再結合PI或QFT控制器，可克服實際NCS因不同之隨機與漂移時間
延遲所造成的控制性能劣化，達到可靠的NCS控制性能，與原訂之目標相符程度達95%。
 研究成果之學術或應用價值：
本研究先將時間延遲作測試與分析，做為未來控制器設計的參考，可應用網路控制系
統，確具有學術與實用之價值。
 是否適合在學術期刊發表或申請專利：
本研究部分成果先投稿至”SICE Annual Conference 2008”，待未完成部分完成後將投稿
至其他期刊。
0 0.5 1 1.5 2 2.5 3
0
0.2
0.4
0.6
0.8
1
1.2
1.4
1.6
1.8
2
Sec.
P
os
ito
n
MSP+QFT Controller with actual uncertain model and inaccurate time-delay estimator
0 0.5 1 1.5 2 2.5 3
0
0.2
0.4
0.6
0.8
1
1.2
1.4
1.6
1.8
2
Sec.
P
os
ito
n
MSP+PI Controller with uncertain model and inaccurate time-delay estimator
0 0.5 1 1.5 2 2.5 3
0
0.5
1
1.5
Sec.
D
el
ay
T
im
e
Delay Time
