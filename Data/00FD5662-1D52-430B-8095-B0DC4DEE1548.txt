 摘要 
 
隨著多媒體需求的日益增加，多核心系統架構常用以並行處理大量資料運算的進行，
以往大量資料傳遞是靠著獨立的 DMA 控制來完成，常會有以下的缺點(1)由於資料傳遞必
須透過一讀一寫的方式來完成，造成記憶體訊號取存時脈的負擔，(2)大量的佔用頻寬，造
成與處理器在使用 Bus 上的碰撞。根據以上缺點，本計劃整合具 DMA 功能之記憶體控制
器，提出了一個透過 AMBA 指令的內部快速資料交換機制，藉由 DDR2 的高時脈傳遞，來
實現(1)以記憶體的原有取存時脈進行記憶體之間的傳輸，(2)記憶體對裝置之間的傳輸，可
於控制器內部橋接達成。不但可以大幅的降低在 System Bus 上的工作負擔，並且提供大量
資料搬運的目的，縮減傳遞資料所耗費的時間，釋放 Bus 的使用權給其他周邊裝置，提升
整體系統的使用效率，同時也於控制器內實現 SATA 介面的橋接器，透過 DDR2 當作資料
緩衝的記憶體，增進資料取存的效率並提供強固型資料緩衝機制，可以有效降低固態硬碟
的存取次數，延長其工作的壽命。根據模擬結果顯示，傳統 DMA 傳輸與使用快速資料交
換機制相比較，在 DDR2 最小提供頻寬下，可以節省約 51%的傳輸時間，在 DDR2 可提供
之最大頻寬下，可以節省 87%的傳輸時間。 
 
第一章 緒論 
1.1  研究動機 
隨著多媒體需求的日益增加，多核心系統架構常用以並行處理大量資料運算的進行，
以往大量資料傳遞是靠著獨立的 DMA 控制來完成，常會有以下的缺點(1)由於資料傳遞必
須透過一讀一寫的方式來完成，造成記憶體訊號取存時脈的負擔(2)大量的佔用頻寬，造成
與處理器在使用 Bus 上的碰撞。思考如何提供記憶體間大量的資料傳遞，又可以縮減透過
傳統 DMA 來傳遞資料所耗費的時間，降低 Bus 的碰撞發生機率，就變的非常重要。 
記憶體控制器與 DMA 控制器的整合可用以實現(1)以記憶體的原有取存時脈進行記憶
體之間的傳輸，(2)記憶體對裝置之間的傳輸，可於控制器內部橋接達成。本計畫將以 DDR2
記憶體控制器計畫的延伸，設計內部資料交換機制取代傳統 DMA 傳輸的缺點，提供記憶
體間大量的資料傳遞，並有效降低 Bus 的工作負擔，並設計整合 SATA 介面的橋接器，透
過 DDR2 記憶體當作資料緩衝區，增進資料存取的效率，提供固態硬碟強固型資料緩衝機
制。 
1.2  研究目的 
本計畫將設計一標準 AHB[2](Advanced High-Performance Bus)介面的記憶體控制器
IP，整合 DDR2 記憶體的時脈傳輸，在控制器內實現快速資料交換及從新組態功能並結合
具 SATA 介面的橋接器，不僅改善傳統 DMA 架構的傳輸時間與 Bus 碰撞的問題，又可提
供快速資料交換功能，透過 DDR2 記憶體與 SATA 介面的橋接，建構一個硬碟的資料緩衝
區，提供強固型資料緩衝機制。總結來說，此記憶體控制器可改進傳統 DMA 控制器的缺
點，提供資料快速交換機制，大幅的降低在 Bus 上的工作負擔，又能提供大量資料搬運的
目的，縮減傳遞資料所耗費的時間，藉由釋放 Bus 的頻寬，提升整體系統的使用效率，並
且透過記憶體對裝置的傳輸與整合 SATA 介面的橋接，利用 DDR2 當作資料緩衝的記憶體，
提供強固型資料緩衝機制，不但可以增進資料取存的效率，並可以有效降低固態硬碟的存
取次數，延長其工作的壽命。 
 
 
體顆粒，與 128Meg x 8bits 不同的地方有，row aDDRess 變成 13bits A0-A12 用來選擇 bank
中的 8192 個 rows。而且每一個 column 的寬度變為 64bits，column Address 的低位 2 位元
A0-A1 選擇 64bits 中的哪 16bits 要送出或寫入記憶體。在這邊每根 DQS 會支配 8 根 DQ 訊
號線。 
 
圖 2-1-6 64Meg x 16bits(總容量也是 1Gbits)DDR2 記憶體顆粒 
(來源:Micron,[4]) 
圖2-1-7為創見現在市面上的256M x 64bits (2GB) 240PIN DDR2-800 Unbuffered DIMM
記憶體模組[5]，他使用了 16顆 128Mx8bits的記憶體顆粒與一個 2048 bits的 serial EEPROM
在一個 240-pin 的電路板上。16 顆記憶體的連接線路如圖 2-1-7 所示，記憶體模組每面有八
顆記憶體，前面由 U1,U2,U3,U4,U5,U6,U7,U8 組成一資料寬度為 64bits 的記憶體，後面由
U17,U16,U15,U14,U13,U12,U11,U10 所組成。在此模組中正對面的兩顆記憶體模組（如 U1
與 U17）所接的 DQ,DQS,與 DM 是相同的訊號輸入，但 CS 是不同的（U1 為 S0,U17 為 S1）。
透過 CS 的選擇可以用來決定此次的資料是要寫那記憶體的那一面。 
 總結來說，DDR2 的 A,BA,DQ,DQS,DM,CS＃等控制訊號的腳位數會根據使用者選擇
的顆粒或模組不同而有所變動，因此在設計控制器方面，就必須要有一些參數化的設定，
讓控制器的使用者可以根據他們所選用的 DDR2 模組不同來修改控制器的參數以符合使用
上的需求，在時序的要求上面也互根據所使用的模組不同而有所不同。 
 
圖 2-1-7 256M x 64bits (2GB) 240PIN DDR2-800 Unbuffered DIMM 記憶體模組(來源: 創
見,[5]) 
 
 
圖 2-2-2 Altera FPGA 中所提供之 DDR2 控制器 
表 2-2-1 為整理市面上幾家有生產 DDR2 控制器的製造廠商與其控制器的特性比較。
TI[12],Lattice[13]與 Prime Cell ARM[14]這三家公司的 DDR2 控制器可以透過寫入暫存器來
對記憶體參數作調整。而 Beyound 公司出的控制器[15]也是可以動態調整記憶體參數。
DDC[16]與 microtronix 公司[17]所出控制器主要是以 IP 為主因此記憶體參數可以在產生控
制器 IP 時設定即可，不用在多花額外的暫存器空間給使用者作參數的設定。綜合上述廠商
的控制器優點，我們的控制器採用了 auto initialization, compile time configurable 與 AHB 使
用者介面。我們還發現目前市面上的廠商對於大量的記憶體間的資料搬運並沒有作有效的
最佳化動作，我們提出了 internal fast memory transfer 的記憶體傳送方式，使用者只要設定
好要搬運的起始位址，目的位址，與搬運數量，控制器集會自動的做大量的記憶體間資料
搬運。此種作法不僅可以提昇記憶體搬運效率外亦可以減少使用者介面匯流排的傳輸量。 
 
表 2-2-1 各廠商比較 
 
必須先對記憶體作初始化動作，透過此模式可以修改欲存取的記憶體時序延遲，來滿足時
序的正確性，以確保之後的讀寫動作都可以正常將資料寫入及讀出。為了能達到快速資料
交換機制，於是在 Memory Manger 內部新設計了 Dma_saddr、Dma_daddr、Dma_start 暫存
器，使用者只需要設定好 Dma_saddr 暫存器傳送想要傳輸的起始位址與 Dma_daddr 暫存器
來設定目的端位址，接著設定 Dma_start 暫存器來起始開始訊號並在資料線上設定想要傳送
的筆數，在經由 RAHB 取得同步訊號後，即可同步對兩個 MCU 下達指令，透過兩控制器
所連接的 16 位元資料線，配合 DDR2 的時脈，以及設定的資料筆數，於兩控制器內部做快
速資料搬運動作。Mul_num 與 Mul_start 是傳送連續多筆資料的暫存器，使用者於 Mul_num
暫存器中設定好想要連續傳送的筆數之後，利用 Mul_start 暫存器的設定發出多筆傳輸的開
始訊號，控制器會針對欲傳送之筆數自動產生相對應的讀取或寫入指令。Sata_hlba 與
Sata_llba 是設定 LBA 48bits 的暫存器，再透過 Sata_rfis 暫存器的設定，即可傳送 Register FIS
訊框，緊接著就可以設定Sata_dfis暫存器，根據讀取或寫入的指令，位址線為欲傳送的DDR2
位址資料，資料線固定為傳輸 128 筆資料，便可開始傳送具有資料訊息的 Data FIS 訊框。 
Sata_dfis
Sata_rfis
Sata_llba
Sata_hlba
Mul_start
Mul_num
Dma_start
Dma_daddr
Dma_saddr
Initial
Single_rw
Name
傳送SATA Data FISR/W01011
傳送SATA Register FISW01010
設定SATA 低24bitLBAW01001
設定SATA 高24bitLBAW01000
多筆讀寫起始訊號R/W00111
多筆讀寫之筆數W00110
DMA起始訊號W00101
DMA目的位址W00100
DMA開始位址W00011
初始化W00010
單筆讀寫R/W00001
DescriptionRead or Writeoffset
 
表 3-2-1 暫存器設計 
 
3-2 Tunnel Mechanism 
在多核心系統架構下，如何能夠降低 AHB 的工作負擔，又能提供快速的資料交換變的
非常重要，於是我們設計了以下三種 Tunnel Mechanism，提供不同儲存位址間的資料交換，
(1)快速內部資料交換機制、(2)資料轉傳機制、(3)強固型資料緩衝機制，以下各小節將分別
介紹此三項機制的傳輸動作。 
3-3-1 快速內部資料交換機制 
為了實現相鄰控制器內部間的資料傳輸，我們在此 DDR2 記憶體控制器上設計一快速
內部資料交換機制，只要使用者透過指令下達欲傳送記憶體的起始位址與目的位址，並透
過 RAHB 來取得兩 MCU 的同步訊號，使兩控制器同步運作讀寫指令，便能在不利用資料
暫存的方法下，快速的透過兩控制器所建立的資料線，搬運所要傳送之資料，節省下透過
AHB 與 RAHB 傳輸佔據的 Bus 使用時間，將 Bus 釋放給個別 MCU 的其它週邊來應用，不
但可以提升 AHB 的使用效率，又可以節省設計緩衝區所需要佔的面積，縮小晶片製作的邏
輯閘數。為了達到此一目的，在控制器的硬體架構上，新增了一條本地控制器的 Read Queue
連結到其他控制器內部 Write Queue 的通道，以及其他控制器的 Write Queue 連結到本地控
制器的 Read Queue 的資料通道，透過此一硬體架構的增加，將所要傳輸的資料透過此通道
傳送到另一個控制器內部，節省透過 AHB 的傳輸時間，並利用如下圖 3-3-1 所示之資料同
步讀寫時序圖的讀取資料部份，根據規格書上所規定，RL(read latency)等於 AL(additive 
Latency)加上 CL(CAS latency)，而 WL(write latency)等於 AL+CL-1。所以讀取延遲時間會
較寫入延遲多一個 clock 時間，於是同步讀寫訊號必須提早一個週期時間下達讀取指令，再
寫入資料部分，配合上目的位址的 MCU 下達同步寫入指令，透過兩控制器連接的資料傳
輸線，以及下達指令所設定的傳輸筆數，即可將資料在不透過 AHB 的方式下，快速的多筆
傳遞，如此既可以減少資料的傳遞時間，又可以釋放 AHB 的使用權給各自 MCU 周邊連接
的設備來使用，提升 AHB 的效率。 
 
第四章 模擬與分析 
本章主要針對設計之記憶體控制器做指令的測試與模擬，測試指令格式是否能正常讀
取 DDR2 記憶體資料，以及轉存 SATA 的指令是否能正常傳輸，接著再分析透過 AHB 傳輸
DDR2 記憶體資料與透過快速內部記憶體資料交換機制來讀取資料之時間上的差異，以及
此記憶體控制器架構可適用於多種應用環境之介紹，並介紹記憶體控制器晶片製作之數據
與模擬分析。 
本計畫之記憶體控制器利用 QuartusII 在功能上做模擬，下載至 Cyclone™II FPGA 上，
型號為 EP2C70F672-C6[23]做 RTL 層級的讀取寫入測試，接著將 RTL 層級的 Verilog code
利用 Synopsys 公司所開發的 design compiler，合成在 RTL 層驗證過的 Verilog code 到
gate-level，得到面積、速度與功率的報告。當這三項結果符合規格要求後，再將所產生的
標準延遲格式 (Standard Delay Format) 檔與 gate-level模擬模組掛載美光所提供DDR2記憶
體模組 MT4HTF3264A[24][25]一併交由 ModelSim 作 Pre-simulation 執行此層級的時間驗證
(Timing Verification)，確認模擬結果與合成結果在速度上能符合規格規範，此記憶體模組內
會將時序做初步驗證，並將錯誤顯示在 ModelSim 資訊列上。 
最後再利用 Cadence 公司所開發的 SoC Encounter 軟體產生 RTL-to-GDSII 程式碼，再
同樣將 Encounter 軟體所產生的標準延遲格式(SDF)檔與 GDSII 檔掛載美光所提供 DDR2 記
憶體模組 MT4HTF3264A 一併交由 ModelSim 執行 Post-simulation，驗證時序及資料無誤
後，即可交由 CIC 晶片中心製作晶片。 
 
本小節將模擬如圖 4-2-1 之架構，模擬傳統 DMA 的動作，透過 CPU 透過 AHB 對 DMA
下指令，將 DDR2 內的資料搬運到 DMA 方塊內的 Buffer 中，再傳輸到目的端的 DDR2 記
憶體，模擬 DMA Buffer 大小為 2Byte、4Byte、8Byte、16Byte，並測試傳輸的資料從 1K byte
到 10K Byte，如圖 4-2-2 所示，在傳輸資料為 1K Byte，Buffer 大小為 2Byte 情況下如果利
用本設計之資料交換機制，每 Cycle 數可傳送資料為 16bits，總共所需要的執行 Cycle 數可
以減少 76%，如果將 DMA Buffer 大小提升到 16Byte，所需要的 Cycle 數同樣可以減少 51%。
如果將傳輸資料放大到 10K Byte，Buffer 大小為 2Byte 情況下，利用本設計之資料交換機
制，所需要的 Cycle 數可以減少 77.6%，再將 DMA Buffer 大小提升到 16Byte，所需要的
Cycle 數同樣可以減少 52.7%。 
 
圖 4-2-1 單一核心架構模擬環境 
合成，等到驗證時序及資料無誤後，即可交由 CIC 晶片中心製作晶片。 
 
圖 4-3-1 晶片驗證流程圖 
 
4-3-1 Layout 圖 
下圖 4-3-14 為經過整個流程驗證無誤後，透過 Encounter 所製作出來的繞線圖，軟體
計算出來的合成面積為 214076.107039 um2，晶片的封裝面積為 2.04 x 2.035mm2，Gate Count
數為 21.4K gate counts，所消耗的功率為 3.82mW，以能夠正常讀寫資料為前提下，在 Gate 
Level 最快可操作之頻率為 208Mhz，在 Post-Simulation 時最快可操作頻率為 192Mhz。 
 
圖 4-3-14 Layout 圖 
 
第五章 結論 
在本計畫中，為了提供大量的資料傳輸並且降低 Local Bus 的工作負擔，整合了 DDR2
記憶體的傳輸指令與傳輸時序，透過記憶體控制器內部設計之具快速資料交換的機制，提
供了在不利用 Local Bus 的情況下又能快速搬運資料的解決方案，不僅提升了 Bus 的使用效
率，又可以快速的交換所需要的資料，而且此一控制器也提供了資料緩衝功能，提供了結
合 SATA 介面之強固型資料緩衝機制，透過 DDR2 記憶體當作硬碟的緩衝記憶體，減少回
寫硬碟的次數，增加其工作壽命。 
在測試與效能評估上，採用市面上 Micron 提供的記憶體模組，掛載在所設計的記憶體
 可供推廣之研發成果資料表 
ˇ 可申請專利  ˇ 可技術移轉                                      日期：97 年 9 月 22 日 
國科會補助計畫 
計畫名稱：實現具快速內部記憶體資料傳輸之可參數化 DDR2 記憶
體控制器設計 
計畫主持人： 邱日清  
計畫編號：NSC 97-2622-E-110 -006 -CC2           
學門領域：資訊 
技術/創作名稱 可參數化 DDR2 記憶體控制器 
發明人/創作人 邱日清、沈政穎、曾華逸、蘇鼎翔 
技術說明 
中文： 
 隨著多媒體需求的日益增加，多核心系統架構常
用以並行處理大量資料運算的進行，以往大量資料傳遞是
靠著獨立的 DMA 控制來完成，常會有以下的缺點(1)由於
資料傳遞必須透過一讀一寫的方式來完成，造成記憶體訊
號取存時脈的負擔，(2)大量的佔用頻寬，造成與處理器
在使用 Bus 上的碰撞。根據以上缺點，本計劃整合具 DMA
功能之記憶體控制器，提出了一個透過 AMBA 指令的內
部快速資料交換機制，藉由 DDR2 的高時脈傳遞，來實
現(1)以記憶體的原有取存時脈進行記憶體之間的傳輸，
(2)記憶體對裝置之間的傳輸，可於控制器內部橋接達
成。不但可以大幅的降低在 System Bus 上的工作負擔，
並且提供大量資料搬運的目的，縮減傳遞資料所耗費的時
間，釋放 Bus 的使用權給其他周邊裝置，提升整體系統的
使用效率，同時也於控制器內實現 SATA 介面的橋接器，
透過 DDR2 當作資料緩衝的記憶體，增進資料取存的效
率並提供強固型資料緩衝機制，可以有效降低固態硬碟的
存取次數，延長其工作的壽命。根據模擬結果顯示，傳統
DMA 傳輸與使用快速資料交換機制相比較，在 DDR2 最
小提供頻寬下，可以節省約 51%的傳輸時間，在 DDR2
可提供之最大頻寬下，可以節省 87%的傳輸時間。 
 
附件二 
