interferometer or Shack-Hartmann 
wavefront sensor, and a FPGA controller will be 
attempted to implement multichannel 
adaptive optics control in real time. 
英文關鍵詞： adaptive optics, FPGA, multichannel controller, laser 
system. 
 
3 
 
表目錄………………………………………………………………-3- 
表 2-1 Zernike多項式…………………………………………………-8- 
參考文獻…………………………………………………………-26- 
Appendix(計畫成果自評)………………………………….………………-27- 
 
5 
 
 
圖 2-1 適應性光學系統架構圖。 
 
2-2 Shack-Hartmann 波前感測器 
2-2-1 波前重建原理  
Shack-Hartmann 波前感測器主要是以幾何的關係去求得波前相位的資訊，不同於移
相干涉術，基本上在量測時不需要參考光且沒有同調性的問題，可直接量得相位的空間
梯度大小，將波前導數經由相位重建方式運算可得到波前相位，並進一步利用擬合而得
到 Zernike 多項式以提供像差分析使用。Shack-Hartmann 波前感測器主要是由一個微透
鏡陣列(microlens array)和一個光偵測器結合而成，實體圖如圖 2-2。 
 
 
圖 2-2 Shack-Hartmann 波前感測器實體圖。 
 
當所要量測的光源進入 Shack-Hartmann 波前感測器後，微透鏡陣列會將入射光聚焦
於後方的 CCD，其中假設每個微透鏡前的波前為一平面，當一平面波入射後所有的光
會聚焦於 CCD 相對於每個微透鏡的中心光軸上，倘若今天所量測的光為非平面波，則
會使聚焦光產生 x-y 軸的偏移，利用此偏移量就可以推算出波前相位的資訊，表示式如 
7 
 
將其波前轉換至直角坐標後，即可將波前表示成(6)式： 
將各點的方向斜率為波前對方向偏微分，並代入波前表示式，可得(7)式： 
由此可知 Zernike 各項係數與聚焦點位移的關係，利用最小平方法去求解，將 Zernike
係數和各項模型的波前相位結合並疊加起來就可以還原出波前。 
 
J N M ܼ௡௠ሺߩ, ߠሻ Aberration 
0 0 0  1 Piston
1 1 െ1 2ρ sinሺߠሻ Distortion
2 1 1 2ρ cosሺߠሻ Distortion
3 2 െ2 √6ߩଶ sinሺ2ߠሻ Astigmatism 
4 2 0 √3ሺ2ߩଶ െ 1ሻ Field curvature, 
Defocus 
5 2 2 √6ߩଶ cosሺ2ߠሻ Astigmatism 
6 3 െ3 √8ߩଷ sinሺ3ߠሻ  
7 3 െ1 √8ߩଷ ሺ3ߩଷ െ 2ߩሻsinሺߠሻ Coma
8 3 1 √8ߩଷ ሺ3ߩଷ െ 2ߩሻcosሺߠሻ Coma
9 3 3 √8ߩଷ cosሺ3ߠሻ  
10 4 െ4 √10ߩସ sinሺ4ߠሻ  
11 4 െ2 √10ሺ4ߩସ െ 3ߩଶሻ sinሺ4ߠሻ Secondary astigmatism 
12 4 0 √5ሺ6ߩସ െ 6ߩଶ ൅ 1ሻ Spherical aberration 
13 4 2 √10ሺ4ߩସ െ 3ߩଶሻ cosሺ4ߠሻ Secondary astigmatism 
14 4 4 √10ߩସ cosሺ4ߠሻ  
15 5 െ5 2√3ߩହ sinሺ5ߠሻ  
16 5 െ3 2√3ሺ5ߩହ െ 4ߩଷሻ sinሺ3ߠሻ  
( 2)
2
3 9 8
2
2 ( 2)
n n m
j
n roundup
m j n n
j  
       
  

 
 
 
 
 
(5) 
( , ) ( , )j j
j
ZW x y W x y   
(6) 
( , )
( , )
( , ) ( , )
( , ) ( , )
j
j
j
j
j
j
x
y
Z x y
W
x
Z x y
W
x
x x y W x yS
f x
y x y W x yS
f y
 
 
   
   


 
 
 
 
(7) 
9 
 
Square Pixel Mode 可以選擇比起原先只有 Non-square Pixel Mode 更多方便性，有了另一
種模式，像素的比例也會是正確的即使是對不同的顯示器和感測器，不需要再透過演算
法換算像素比例，在輸出訊號方面也有新功能，可以把彩度訊號和亮度訊號用不同的腳
位輸出，所以在使用黑白 CCD 能直接只接收亮度訊號，程式裡不必多一個判斷把彩度
訊號特別的分離出來，而設定方面一樣是透過 I2C (Inter-Integrated Circuit)傳輸協定來進
行硬體間的溝通。ADV7180 的設計圖與實體圖如圖 2-4。 
 
 
圖 2-4 ADV7180 的設計圖與實體圖。 
 
Video decoder 由 TVP5150PBS 換成 ADV7180 以及新的電路設計，實際影像的品質
提升了許多，與 NI 的影像擷取卡已經十分接近，而自製的影像擷取卡需要自行透過 I2C
傳輸協定，依所需的情況來調整 Video decoder 的設定例如對比度。 
 
2-2-3 Shack-Hartmann 波前感測器整合至 FPGA 
自製的即時 Shack-Hartmann 波前感測器的感測流程如圖 2-5，光波前進入
Shack-Hartmann 波前感測器中的微透鏡陣列後聚焦，CCD 影像尺寸 640×480 像素時影
像上有 17×13 個聚焦點，CCD 上聚焦點影像經過實驗室自製影像擷取裝置將 CCD 的類
比影像訊號轉換成數位影像訊號，接著數位影像訊號進入 FPGA 中。由於 FPGA 本身的
記憶體容量無法儲存下一整張影像的資訊，我們的解決方法是區域性的去讀取資訊並區
域性的計算，一次就讀取整張影像所需的部分區塊存入 FIFO，我們 FIFO 的大小設定比
一個小區塊的所需記憶體大些，當 FIFO 每存完一個區塊的完整資訊後，便會利用重心
演算法求出聚焦點中心，此時下一個區塊的資訊也會不間斷的繼續送入 FIFO，此方法
就類似平行處理的概念，傳輸與計算同時在進行，如此就可以解決 FPGA 記憶體不足的
問題。並與平面波聚焦點中心比較得到偏移量並得知各個微透鏡波前的斜率。通常可調
變聚焦鏡的使用會刻意避開最外圈的通道不用，是因為周圍邊界會對最外圈的薄膜產生
很大的拉力而較不好控制，目前所使用的可調變聚焦鏡中心的通道尺寸換算後對應到
Shack-Hartmann 波前感測器共 73 個聚焦點，所以利用軟體的光圈濾掉不要的光點，接
11 
 
 
圖 2-6 可調變式聚焦鏡實體圖與示意圖。 
 
控制器為實驗室自行發展的多通道可調變聚焦鏡驅動器。設計過程中由於可調變式
聚焦鏡可以看成是多通道的電容，當這電容值越高的話，驅動器之反應的頻寬越是有限，
因此我們要針對所得到的電容值去做設計。利用 PICO 公司的直流-直流轉換器(DC-DC 
converter) LPA175S，原理如圖 2-7，只須從左輸入直流電源，內部有振盪電路使直流變
交流，再經由變壓器轉成高壓後，透過整流電路與電容將輸出的漣波拿掉，完成直流-
直流的轉換。此輸入 18~36V(24V) DC 可產生出 175V±0.5%的 DC 電源、50W 的功率，
將此 DC 電源供給整個電路做穩定的電壓源，用來驅動後面多通道的電路。如圖 2-8 所
示，利用 LITE-ON 的光耦合器，型號為 H11D1M，做此高電壓電源的隔離，此光耦合
器熱功率消散(power dissipation)為 150mW，CTR(current transfer ratio)為 80~300%，VCE
可耐到 300V。再去設計 R5 和 R4 值，使負載線落在理想的範圍內。 
 
 
圖 2-7 直流-直流轉換器工作示意圖。 
 
圖 2-8 開迴路驅動電路。 
13 
 
其 OP 正端輸入電流相當小，且輸入電阻相當大，為 10 的 12 次方歐姆，所以其放電降
到本來強度的 95%，須時 0.0513×RC=5130 s，理想上是相當久的放電時間，實際上測試
亦是在觀測一段時間仍看不出其強度有下降的動作。所以當我們利用控制器做多通道的
驅動電壓時，只須注意到充電時間要大過其充電的上升時間，至於下降時間則保值相當
長的時間而不須擔心。 
驅動結果如圖 2-11 上圖為輸入電壓 0 到 2.5V、87 Hz 的正弦波，圖 2-11 下圖為輸
出電壓約 0 到 90V。當上升其頻率可量測其頻寬，配置 R5 和 C4 使其截止頻率落在 2.2 
kHz，因為後級的反應速度不會大過這個速度，可順代將高頻雜訊去掉。圖 2-12 為測試
不同通道在同樣輸入 2 V 時的放大倍率圖，可能因電阻電容與光耦合器特性上使每個通
道輸出不皆相同，造成通道間放大倍率有些微差異。量測直流輸入的輸出電壓 90 V 時，
大約在 130 kHz 有一 2.6V 峰對峰值，其餘峰對峰值最大為 200 mV，相對此 2.6 V 較小，
此為回饋造成的雜訊，輸出電壓越高此雜訊越高，原因來自於主流電流的下降，當負載
吃較多電容會使輸出變動較大。因為後級反射鏡元件反應速度只有 1 kHz 的頻寬，對於
此變動量會被拿掉，因此我們可以不考慮此雜訊。 
 
 
圖 2-11 多通道控制器輸入電壓(上)與輸出電壓(下)結果。 
 
圖 2-12 不同通道的電壓放大倍率。 
0 5 10 15 20 25 30 35
0
5
10
15
20
25
30
35
40
O
ut
pu
t/I
np
ut
Channel 1-37
15 
 
持在 30 Hz 的迴圈速度，之後將輸入與輸出訊號序列做離線分析得到整體系統模型，控
制系統流程圖如圖 3-1。 
由於所使用的可調變式聚焦鏡上所有的通道是互相耦合的，因此我們需要 MIMO
的系統鑑別才能鑑別出整個控制系統，我們利用 n4sid (subspace state space system 
identification)的方式進行系統鑑別[10]。 
 
 
圖 3-1 系統鑑別流程圖。 
 
3-2 基於觀測系統狀態之回饋控制系統 
我們先使用可調變式聚焦鏡八個通道做為輸入，然後取用 Shack-Hartmann 波前感測
器所量測到的 14 項 Zernike 多項式係數當作輸出。選擇可調變式聚焦鏡主要中間部分和
四個角落的第 6、9、13、14、18、20、24、27 等共八個通道為主要輸入端，如圖 2-6
的示意圖，將八組不同的白雜訊隨機訊號先存入 FPGA 本身，由 30 Hz 的速度別分輸入
至可調變式聚焦鏡的八個通道中，並由 Shack-Hartmann 波前感測器接受資訊計算輸出的
14 項 Zernike 多項式係數並儲存，最後再由這些輸出和輸出的資料進行系統鑑別。 
初步測試結果，在 30 Hz 的系統迴圈速度，8 輸入 14 輸出時鑑別出來的結果 60 %~80 
%吻合度，鑑別結果如圖 3-2，未來要增加系統穩定度來提升系統鑑別的吻合度，需要
盡可能在系統鑑別的時候減少外在光源及其他外在干擾。 
系統控制架構主要是藉由系統識別出來的結果，搭配現代控制理論中狀態回授(state 
feedback)的機制[11]，來建立一個具有漸近式穩定的閉迴路控制系統，使得光學系統在
有外加干擾的情況下，能夠藉由此控制系統控制可調變式聚焦鏡，讓 Shack-Hartmann
波前感測器所偵測地的 Zernike 多項式係數輸出能夠維持在零，以達到即時修正受干擾
波前的目的。控制系統的架構如圖 3-3 所示[12]。 
17 
 
 
圖 3-3 基於觀測系統狀態之回饋控制系統流程圖。 
 
在控制系統上主要包含三個部分：受控體(plant)、狀態觀測器(state estimator)以及狀
態回授(state feedback)。受控體部分即為可調變式聚焦鏡以及 Shack-Hartmann 波前感測
器所組成的感測補償系統，藉由系統識別結果的 A、B、C、D 矩陣[13,14]，我們可以用
離散的狀態空間模型(state space model)來表示受控體，如式(6)： 
其中 x 為狀態變數，u 為輸入，y 為輸出。 
  狀態觀測器的部分則是利用輸入和輸出的資料來預測受控體真實的狀態，根據現代
控制的理論，若要將狀態變數用來實現回授控制的話，則狀態變數必須為真實的狀態，
即必須要有足夠的量測器去量測各個狀態，但現實情況中很難去實現，因此就必須使用
狀態觀測器來預測真實的狀態，然後藉由狀態回授來作控制，而狀態觀測器也可以用狀
態空間模型來表示，如式(7)： 
其中 x為預測狀態變數，u 為輸入， y 為預測輸出，L 為觀測器增益矩陣(observer gain 
matrix)，若受控體具有可觀測性(observerbility)的話，則我們可以藉由設計矩陣 L 來使預
測狀態變數 收斂到真實的狀態。 
[ 1] [ ] [ ]
[ ] [ ] [ ]
x k Ax k Bu k
y k Cx k Du k
  
   
 
 
(6) 
  
 
[ 1] [ ] [ ] ( [ ] [ ])
[ ] [ ] [ ]
x k Ax k Bu k L y k y k
y k Cx k Du k
    
   
 
 
(7) 
19 
 
故在系統識別取得狀態模型時，分別用二十階係數來模擬實際受控體，再用同樣的鑑別
資料採用六階係數來設計控制器，再加上適當觀測器和控制器增益矩陣 L 和 K，使之模
擬構成一個閉迴路系統。 
  一開始先假設 u[1] = 0， x [1]=0， x[1]=x0，x0 為受控體的初始狀態，接著令 y 等
於一組 Zernike 係數當作受到干擾後的波前，然後將這些條件代入演算法，經過 20 個迴
圈之後，可以發現 14 項的 Zernike 多項式係數都有收斂的趨勢。圖 3-4 為 Matlab 所模擬
的結果，y01~y14 分別代表 14 項的 Zernike 多項式係數。 
 
 
21 
 
 
圖 3-5 基於觀測系統狀態之伺服控制系統控制流程圖 
 
 
 
23 
 
由式(12)可得： 
由式(12)、式(13)可得： 
由定義可得： 
最後，由式(15)、式(16)、式(17)可得到整個伺服控制系統的動態特性為： 
因此，若要使系統穩定收斂，則必須使系統矩陣的特徵值強度大小小於 1， 
系統矩陣的特徵值可由式(18)中的式子得到，即為矩陣 A-L*C 的特徵值以及矩陣
AA-BB*KK 的特徵值之聯集，所以矩陣 L 和矩陣 K、G 是可以分開設計的。 
設計時一樣是利用極點配置法，來將所要的極點位置放置到系統內，而在設計過程
中，為了方便更改極點位置來作觀察，因此在模擬時加入一些變數，並且利用 for 迴圈
來選定所要佈置的極點位置，如此一來只要改變變數的值，即可得到不同的極點位置。 
 此外，在佈置極點時，有一點須注意的是觀測器的收斂速度必須比控制器的收斂速
度還要快，因此在佈置時，觀測器的極點必須比控制器的極點還要更遠離原點，目前在
設計上觀測器極點離原點的距離大約比控制器極點離原點的距離還要遠 10 倍，控制器
的極點為: {-19,-19±10i,-20,-20±10i,-21,-21±10i,-22,-22±10i,-23,-23±10i,-24,-24±10i,-25,-25
±10i,-26,-26±10i}，而觀測器的極點為: {-181±i, -182±i, -183±i, -184±i, -185±i, -186±i}。 
 


[ 1] [ ] [ ] [ ]
           { } [ ] [ ] [ ] 
x k Ax k BGe k BK x k
A BK x k BGe k BK x k
   
     
(15)


[ 1] [ ] [ ] [ ]
           [ ] [ ] [ ] { [ ] [ ]}
           { } [ ] { } [ ] [ ] [ ]  
e k e k r k y k
e k r k Cx k D Ge k K x k
C DK x k I DG e k DK x k r k
   
    
      
 
 
 
 
(16)
 [ 1] [ 1] [ 1]
[ ] [ ]
x k x k x k
Ax k Bu k
    
  [ ] [ ]Ax k Bu k  

{ [ ] [ ]}
{ } [ ]  
L y k y k
A LC x k
 
 
 
 
 
 
(17)
 
 0    
( )
                                     
                                     *
A BK BG A B
K G
C DK I DG C I D
AA BB KK
                     
 
 
 
 
 
 
 
 
(18)
25 
 
 
 
圖 4-1 模擬系統在外在干擾下穩定收斂。 
 
伍、 結論： 
本文主題是發展即時多通道適應性光學系統，採用 FPGA 模組為主要控制器以確定
整體系統穩定時脈，自製的 Shack-Hartmann 波前感測器搭配影像解碼電路使之有即時
30 Hz 的偵測波前能力，再由 MIMO 系統鑑別得到整體系統的狀態模型，並設計一於觀
測系統狀態之伺服控制系統器使可調變聚焦鏡能即時動態修正干擾。實驗上先由 Matlab
模擬驗證其控制器是否能使系統的輸出收斂且確保系統的穩定性，之後將把控制器整合
至 FPGA 模組裡以完成整體適應性光學系統即時的 30 Hz 多通道閉迴路控制。 
 
 
 
27 
 
計畫成果自評： 
與本計畫完全相關成果: 
3篇SCI論文 
 C.-Y. Chang, B.-T. Ke, S.-Y. Lin, S.-Y. Chen, H.-W. Su, W.-C. Yen, and S.-J. Chen*, 
“Real-time FPGA-based adaptive optics system with state-space model multichannel 
control,” was submitted to Optics Express 2012. 
 C.-Y. Chang, L.-C. Cheng, H.-W. Su, K.-C. Cho, W.-C. Yen, C. Xu, C. Y. Dong, and S.-J. 
Chen*, “Widefield multiphoton microscopy with image-based adaptive optics system,” 
Optics Express, vol. 20, no. 12, pp. - , June 2012. (Impact Factor: 3.880) 
 L.-C. Cheng, C.-Y. Chang, C.-Y. Lin, K.-C. Cho, W.-C. Yen, N.-S. Chang, C. Xu, C. Y. 
Dong, and S.-J. Chen*, “Spatiotemporal focusing-based widefield multiphoton 
microscopy for fast optical sectioning,” Optics Express, vol. 20, no. 8, pp. 8939-8948, 
April 2012. (Impact Factor: 3.880) 
與本計畫部分相關成果: 
1篇SCI論文 
 Y.-C. Li, L.-C. Cheng, C.-H. Lien, C.-Y. Chang, P. J. Campagnola, and S.-J. Chen*, “Fast 
multiphoton microfabrication of freeform polymer microstructures by spatiotemporal 
focusing and patterned generation,” was submitted to Optics Express 2012. 
 
100 年度專題研究計畫研究成果彙整表 
計畫主持人：陳顯禎 計畫編號：100-2623-E-006-016-D 
計畫名稱：即時多通道適應性光學系統之研製 
量化 
成果項目 實際已達成
數（被接受
或已發表）
預期總達成
數(含實際已
達成數) 
本計畫實
際貢獻百
分比 
單位 
備 註 （ 質 化 說
明：如數個計畫
共同成果、成果
列 為 該 期 刊 之
封 面 故 事 ...
等） 
期刊論文 0 0 100%  
研究報告/技術報告 0 0 100%  
研討會論文 3 3 100% 
篇 
 
論文著作 
專書 0 0 100%   
申請中件數 0 0 100%  專利 已獲得件數 0 0 100% 件  
件數 0 0 100% 件  
技術移轉 
權利金 0 0 100% 千元  
碩士生 2 2 100%  
博士生 1 1 100%  
博士後研究員 0 0 100%  
國內 
參與計畫人力 
（本國籍） 
專任助理 0 0 100% 
人次 
 
期刊論文 4 4 100%  
研究報告/技術報告 0 0 100%  
研討會論文 2 2 100% 
篇 
 
論文著作 
專書 0 0 100% 章/本  
申請中件數 0 0 100%  專利 已獲得件數 0 0 100% 件  
件數 0 0 100% 件  
技術移轉 
權利金 0 0 100% 千元  
碩士生 0 0 100%  
博士生 0 0 100%  
博士後研究員 0 0 100%  
國外 
參與計畫人力 
（外國籍） 
專任助理 0 0 100% 
人次 
 
