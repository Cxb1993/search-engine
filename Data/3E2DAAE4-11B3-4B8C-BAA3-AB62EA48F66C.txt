 2
行政院國家科學委員會專題研究計畫年度報告 
以對焦尋形為基礎之三次元量測系統 
(A 3-d measurement system basing on shape from focus technique) 
計畫編號：NSC  94-2212-E-007-063 
執行期限： 94 年 8 月 1 日至 95 年 8 月 31 日 
主持人：林士傑 清華大學動力機械工程學系 
Email: sclin@pme.nthu.edu.tw 
研究人員：李權 呂信億 余准琳 陳治廷 
 
一、中文摘要 
本研究係藉由原有的一套以一般光源
之非接觸式三次元量測系統進行小物件的
三維輪廓的重建。由於量測資料點中含有許
多環境所產生的雜訊干擾，故分析雜訊特徵
並設法消除雜訊，並找尋最佳參數設定，以
得到更佳的三維輪廓重建結果。 
利用對焦尋形法來求得待測物之三維
輪 廓 資 訊 ， 以 重 建 其 原 貌 。 透 過
Modified-Lapacian (ML) 以 及 Sum- 
Modified-Laplacian ( SML )運算子可計算出
待測物影像在對焦與失焦間的差異，進而得
到待測物輪廓之深度變化資訊。而 ML 運算
後加入高斯平滑濾波可以消除影像中不必
要之背景雜訊。經由轉換矩陣得到實際三維
立體座標資訊，再透過逆向工程軟體重建待
測物輪廓及尺寸加以驗證。吾人提出於運算
之最後加入中間值法，以得到更平整之輪廓
點。藉由部分區域測試與全域影像測試之結
果相互驗證，找到最佳之運算法。 
 
關鍵字：對焦尋形法、最佳化 
 
Abstract 
The shape-from-focus is an economic 
approach for 3-D measurement.  However, 
the 3-D image reconstructed using this 
approach generally suffered by relatively high 
level of noise.  In this study, it is of interest 
to optimize this technique to reach a better 
result.   Modified-Laplacian (ML) operator 
and Sum-Modified-Laplacian (SML) operator 
are generally used in this approach to identify 
object in focus.  The study confirmed that 
the use of SML after ML operator provide a 
more accurate result.  However, using 
Gaussian filter between ML and SML 
operator is helpful in removing background 
noise. Adopting the median method can 
smooth the contour points and provide a more 
accurate result. 
Key word：Shape-from-focus, Optimization 
 
二、計畫緣由及目的 
目前運用在非接觸式量測的技術，可歸
類為下列幾種：X 光量測[1]、超音波量測
[2]、雷射量測[3][4]、一般光源量測[5][6][7]
等。其中雷射量測和一般光源量測屬於成本
較低之非接觸量測方式，而且不需專業之技
術，可降低操作人員培訓成本。 
 Nayar and Nakagawa [8]提出對焦
尋形法( Shape-from-Focus )，以不同對焦層
( Focus Level )來獲得一系列的物體輪廓，
圖 1 為示意圖。作者利用 Sum-Modified- 
Laplacian 運算子( SML Operator )來計算影
像各個位置聚焦情形，藉以判別物體的輪
廓。結果顯示 Shape-from-Focus 法可以適用
於多種工業視覺問題上。 
Noguchi and Nayar [9]提出，利用主動
式光源照射在工件表面形成明顯的表面紋
理。作者對所有與對焦相關的光學效應做詳
細的傅立葉分析來決定投射照明使用的紋
理。實驗樣品採用缺少表面紋理的工件，像
是矽基板上的三維結構，和電路板上的錫接
點。 
馮 信 榮  [6] 利 用
Sum-Modified-Laplacian ( SML )運算子計
算影像各點位置之聚焦度測量值，並搭配離
散式高斯平滑化濾波與灰階亮度等化運
算，建構出一套線上非接觸式影像量測系
 4
的總和[10]。其運算式可表示如下： 
 
( ) ( ) ( )∑ ∑+
−=
+
−=
≥=
Ni
Nik
Nj
Njl
TjiMLforlkMLjiF ,,,
              (4) 
 
N 是表示計算聚焦度測量值 F( i , j )的視窗
大小；T 為系統聚焦閥值。 
 
二次函數內插 
    由於鏡頭景深範圍關係，以聚焦度之最
大值之深度位置為最佳聚焦位置並不能確
定是否為真正聚焦位置。故聚焦度測量值之
最大值計算出來後，可以藉由二次函數內插
法來找尋最佳的聚焦位置，故在此介紹此方
法。假設二次函數為下式 
 
  cbxaxy ++= 2        (5) 
 
假設聚焦度量測值最大值為 Zm，其深度位
置為 dm，其前後深度之聚焦值分別為
Zm-1，Zm+1，將三點之聚焦值與位置代入
(式 3.9)，可以求得 a、b、c，由此二次函數
可以求得最佳聚焦位置 a
bZ
2
' −=
，如下面
3.10 式所示 
 
)2(2
]4)12()12[(
11
11'
mmm
mmmmmm
ZZZ
ZdZdZd
Z +−−
+−−++−−=
−+
−+
                 
(6) 
 
尺寸校正 
數位影像中，像素與像素間的距離，與
CCD 攝影機的感光元件尺寸大小相關，而
透過鏡頭倍率的調整，會成等比例放大或縮
小。由於本系統所使用的 KCM-Z 鏡頭，為
可變倍率之鏡頭，其可變範圍為 0.8X~4X。
因此在量測前，應以校正片做尺寸之校正，
才可求得工件之實際尺寸大小。本系統所使
用的尺寸校正比例尺之計算式如下式： 
 
⎟⎠
⎞⎜⎝
⎛= pixelm尺寸校正比例尺相對影像空間座標
實際尺寸 µ
        
(7) 
 
本研究所使用之鏡頭放大倍率為 0.8X，由
3.11 式可以推算出 0.8X 時之校正比例尺為
8.545 μm/pixel。 
 
3.2 實驗流程 
實驗量測流程圖，如圖 2 所示。首先吾
人依照待測工件之尺寸大小來選擇適當之
鏡頭放大倍率，再以校正片取得校正參數。
接著設定移動平台之位移步進量，完成後開
始以固定位移量移動工件位置，擷取一系列
影像。判別工件是否需要旋轉，需要則先旋
轉工件，再反覆前面步驟，否則便進行下一
步驟。上述步驟即完成了取像動作。接著將
同系列影像進行高斯平滑濾波、ML 及 SML
聚焦值運算，求得最佳聚焦位置，即為深度
資訊。再將前述之深度位置，藉座標轉換方
式將影像座標轉換為世界座標，以求得工件
三維輪廓點資料。透過逆向工程軟體
Imageware Version 11 將三維輪廓點資料重
建出工件之三維輪廓。最後，將重建之三維
輪廓進行尺寸量測或驗證，才算完成所有步
驟。 
 
部分區域影像測試分析 
前面介紹了整個實驗流程，但若取用整
張影像進行運算，其花費之時間太多，故吾
人先以局部區域進行不同參數以及濾波方
式測試，觀察其趨勢，進而推測全域影像之
結果。 
測試設定方面，主要為有無高斯濾波、
高斯濾波大小、濾波器放置之順序，透過小
區域影像不同參數設定之結果，吾人藉此作
為全域影像處理參數設定之參考。部分區域
影像測試所使用之運算法可分為三階段。第
一階段先就ML運算子作探討並且測試ML
運算之結果；第二階段在 ML 運算之後加入
SML 運算，測試對於結果之影響；第三階
段改為先經 ML 運算再加入高斯濾波最後
作 SML 運算，與第二階段作比較。最後找
出最佳之運算法進行全域影像之測試。 
 
全域影像測試 
經過前面部分區域影像之結果，吾人採
用最佳之演算法並且加入中間值運算，即在
整張影像作完 SML 運算之後，接著利用二
 6
而效果更差。由表 2 可以發現當僅作到 ML
運算時，其輪廓點到擬合線之距離平方合值
相當大，其值達到兩萬多，表示其輪廓點與
擬合線之差距非常大；而僅作 ML 及 SML
運算時，其距離平方合約為一萬多，大約為
僅作 ML 運算得到數值的一半，故吾人認為
使用 SML 運算是必要的。而在加入 SML
運算之運算法中，吾人可以發現若先作高斯
濾波後，再加入不論是高斯濾波 3×3 或者
是高斯濾波 5×5，其結果反而比不加高斯濾
波來的差，這是因為先加高斯濾波會造成原
始影像灰階值變得模糊化，進而影響到後續
之 ML 運算以及 SML 運算，故高斯濾波應
該考慮在 ML 運算之後再加入之。由表 3
則可以發現若先作 ML 運算再作高斯濾波
最後作 SML 運算，其結果反而比不加高斯
濾波來的好，其值分別為兩千多、七千多。
而僅作 ML 運算加上高斯濾波的話，其距離
平方合值分別約為兩萬四、一萬六左右，結
果比僅作 ML 運算再作 SML 運算之值來的
大，效果反而不好。 
綜合表 1-3 比較來看，結果最佳之前三
種運算法排序為：先 ML 運算再作高斯 3×3
濾波最後作 SML 運算、先 ML 運算再作高
斯 5×5 濾波最後作 SML 運算、僅 ML 運算
再作 SML 運算。亦可以得知二次函數內插
法對於運算結果是有改善效果的，故採用
之。選擇此三種運算法進行全域影像之測
試。 
4.2 全部區域測試結果 
吾人將部分區域測試之結果推廣至全
域影像上。全域影像透過運算後得到三維輪
廓之點資料，可稱之為雲點圖。但是僅由雲
點圖觀察並無法看出定量之判斷標準，故吾
人將所有雲點圖輸入至逆向工程軟體
Imageware Version 11，透過雲點圖之點資料
可以擬合出適合的錐面來重建樣本之外型
輪廓，並藉由外型幾何關係以及量測資料來
建立運算法優劣之判斷依據。 
以圓錐體來說，其最重要的幾何特徵為
圓錐角，故吾人可以圓錐角以及角度誤差%
作為判斷影像處理結果優劣之參考。藉由
Imageware Version 11 內建之量測功能，吾
人可計算出擬合錐面之圓錐角度、擬合錐面
所使用之點數、每個雲點與重建之擬合錐面
之距離，進而可以得知擬合錐面之圓錐角與
量測之圓錐角之角度誤差%、重建錐面之有
效點數%以及雲點與重建錐面的標準差。有
效點數%之計算係將所有點資料輸入
Imageware 軟體後，於重建曲面時設定
tolerance 為 50µm，經由軟體反覆計算
tolerance 超過 50µm 之點資料視為非有效
點，tolerance 小於 50µm 的點資料則視為有
效點，而有效點為重建曲面之依據。吾人可
以建立判斷重建之圓錐曲面之優劣，作為判
斷之標準。理論上可知，角度誤差%越小，
則重建之曲面越接近真實樣本；有效點數%
越大，可以顯示程式運算後的三維輪廓點資
料越接近擬合之錐面；標準差越小，則表示
吾人得到之點資料越接近擬合之錐面。當擬
合之圓錐角度越接近量測值，且雲點圖之有
效點數越多、標準差越小，則代表該運算法
得到之擬合錐面越符合真實樣本之外型輪
廓。 
經由部分區域影像討論之三種最佳運
算法後得到之雲點圖來看，表面之輪廓點顯
得不太平滑，吾人提出一中間值法，將某一
影像座標( i , j )之聚焦深度位置與其周圍八
個座標之聚焦深度位置作比較並排序，將排
序後之中間值取代該影像位置( i , j )之聚焦
深度位置。吾人預期採用此法後可以改善雲
點圖，使雲點圖之表面平整些。經多次測試
後發現，果真符合吾人所預期，故吾人將中
間值法加入後面兩種運算法中並比較其效
果。 
圖 4-11(a)為五種運算法得到之擬合圓
錐角度與實際量測之樣本圓錐角度之比較
圖。圖中五個點分別代表五種運算法計算得
到之角度值。其中以ML-高斯濾波5×5-SML
運算得到之角度值最接近實際量測值，其次
是 ML-高斯濾波 3×3-SML 運算-中間值法，
再其次為ML-高斯濾波5×5-SML運算-中間
值法，而僅作 ML-SML 運算得到之角度與
量測值相差最大。僅作 ML-SML 運算得到
之擬合角度偏差值較大，係由於背景雜訊過
多，造成雲點圖中點資料過多且分散，故吾
人可以推得在 ML 運算後加入高斯濾波之
必要，以消除背景雜訊之影響。此外，吾人
 8
該考慮在 ML 運算之後再加入之。 
 
透過全域影像測試結果證實： 
(1) 在 ML 與 SML 運算中間加入高斯濾波
運算確實可以改善結果；而在 SML 運
算最後再加入中間值法也確實可以改善
結果，可使雲點圖之表面部分更加平
順，於擬合錐面時有更佳之結果。 
(2) 待測物的材質色澤以及粗糙度皆可能
影響表面光學特性。不同材質之樣本測
試結果發現，鋁之測試結果稍優於不鏽
鋼，且前兩者皆優於黃銅，顯示不同材
質色澤對於實驗結果確實有影響。但由
於每一種材質對於不同光譜照射之接收
度不同，故造成本研究所使用之 LED 白
光對於不同材質之差異。因此建議於採
取樣本表面噴上相同之噴漆，即可避免
不同色澤材質之樣本於量測時造成之差
異。 
 
參考文獻 
[1] 廖克東, “應用機器視覺於低對比動態
X-Ray 影 像 強 化 及 瑕 疵 偵 測
Classification for Real-Time Dynamic 
System ),” 私立元智大學工業工程與管
理學系碩士論文, 2001. 
[2] 田亦凡 , “高速超音波影像檢測系統
( High Speed Ultrasonic Image Inspection 
System ),” 國立成功大學機械工程學系
碩士論文, 2001. 
[3] 劉寶信, “電子構裝三維尺寸之雷射量測
( Laser Measure on The Three 
Dimensional Size of The IC Package ),” 
國立成功大學工程科學系專班碩士論文, 
2003. 
[4] 張振龍, “360 度立體快速量測系統與寬
頻之應用( 360 Degrees Rapid Measuring 
System of 3-D Profilometry and 
Application in Wideband Network 
Collaboration ),” 國立台灣大學機械工
程研究所碩士論文, 2000. 
[5] 王彰群, “自製影像式量測儀之自動化研
究( The Study of Automation in CCD 
Camera Measurement Device ),” 國立交
通大學機械工程系碩士論文, 2001. 
[6] 馮信榮,“二維影像於三維輪廓重建之研
究,” 國立台灣大學機械工程研究所碩
士論文, 2001. 
[7] 周佳彥,”運用雙影像對應求取 3D 座標
資訊-模擬退火法之應用” 朝陽科技大
學工業工程與管理所碩士論文, 2003. 
[8] Nayar, S. K. and Nakagawa, Y., “Shape 
from Focus : An Effective Approach for 
Rough Surfaces,” Proceedings of 1990 
IEEE International Conference on 
Robotics and Automation, vol. 2, May 
1990, pp.218-225, Cincinnati, USA. 
[9] Noguchi, M. and Nayar, S.K., 
“Microscopic Shape from Focus Using 
Active Illumination,” Proceedings of the 
12th IAPR International Conference on 
Pattern Recognition, Vol. 1, Oct. 1994, 
pp.147-152, Jerusalem, Israel. 
[10] 蘇俊欽, “以 Shape-from-Focus(SFF)和 
Depth-from-Focus(DFF)為基礎之三次
元量測系統( Development of 3-D 
Measurement System by SFF(Shape- 
from-Focus) and DFF (Depth-from- 
Focus),” 國立清華大學動力機械工程
學系碩士論文, 2004. 
[11] 莊峻超, “逆向工程 Imageware 功能剖 
 析 ,” 全 華 科 技 圖 書 股 份 有 限 公
司,2003. 
[12] 林瑞璋, 王萬強, 陳文賢, “逆向工程軟 
體 Surfacer 使用手冊,” 全華科技圖書 
股份有限公司, 2002. 
 
 
 
 
 
表 4-1 部分區域 ML 運算之距離平方合 
運算法 ML 高斯 3 -ML 
高斯 5 
-ML 
取最大值 21338.81 26435.46 101918.46
取二次內
插 25253.6 26098.24 101386.6 
 
 
 
