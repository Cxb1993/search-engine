2行政院國家科學委員會專題研究計畫成果報告
基於管制圖概念之網路流量安全系統設計
A network traffic analysis system based on the control chart
mechanism
中文摘要
近年來網際網路服務漸趨盛行，應用層面亦日益廣大，網路提供使用者享用許多便利並
創造許多商機。為了提供各類網路服務，系統業者須架設網路伺服器提供客戶端透過網路連
線取得服務；但伺服器的作業系統多少都存在一些漏洞，而鬼客可以利用這些漏洞設計攻擊
的惡意程式，使得個人或單位的資訊安全遭受威脅。為了防止鬼客攻擊或商業機密遭竊，許
多網路安全公司與系統開發機構，發展了各類網路流量偵測系統。不過，當網路流量過大時，
除了造成網管人員分析封包及日誌紀錄沉重的負擔之外，更嚴重的是偵測系統經常會因為運
算資源不足導致網路封包延遲甚至遺失，進而影響偵測的準確率。本研究應用統計製程管制
的概念，並參照網路流量資料的特性，提出監控網路流量之 X 與自調式EWMA管制圖，用以
偵測網路異常使用行為，另一方面透過NS2網路模擬器模擬正常與異常流量資料，在誤報率
及漏報率的權衡取捨下，分析管制圖參數合理的範圍，並驗證管制圖的偵測能力。根據NS2
模擬分析的結果可得，網路流量異常偵測之 X 管制圖管制界限寬度(L)設為12~13有較好的偵
測能力，而EWMA管制圖則在 6.04.0 ≤≤  與L=1.5或 7.0≥ 與L=2有較好的偵測表現。最後，
本研究進一步以PHP撰寫流量分析系統，將銘傳大學桃園校區資訊學院所蒐集得真實網路流
量資料存置資料庫，開發「即時網路流量分析系統」，提供網管人員透過網頁以視覺化的方
式即時監控流量，所得之管制圖可輔助網管人員監控網路流量是否發生異常的參考依據。
關鍵詞：網路流量、自調式 EWMA管制圖、NS2模擬器、誤報率、漏報率
41. 前言
1.1. 研究背景與動機
網際網路(Internet)最初是在 1960年代美國國防部鑒於當時各單位所使用的電腦硬體與通
訊網路設備屬於不同的廠牌，為了將資料在不同廠商的電腦設備進行傳送資訊，而開始發展
網路通訊技術與通訊協議(Communications Protocol)。隨著網路技術的蓬勃發展，網路逐漸朝
向資訊整合與傳遞並擴及商業服務等領域；自 1989年 Tim Berners-Lee提出World Wide Web
架構後，至今已經有許多著名的入口網站與企業網站，例如 Yahoo、Google、Amazon等大型
網站。
由於近年來網站的普及與網際網路的快速發展，網路使用人口呈幾何速率成長。據
Internet World Stats統計全球上網人口從 2000年 3.6億到 2011年成長率超過 450％，截至 2011
年 3月全球上網人口達 20.9億，使用網路人數佔全球總人口 69.3億約 30.2%，最新全球網路
使用人口如表錯誤! 所指定的樣式的文字不存在文件中。-1。根據表錯誤! 所指定的樣式的文
字不存在文件中。-1可以發現亞洲國家使用網路人數佔了全球 20.9億網路人口約 44%，由此
可知亞洲國家的網路普及率是非常高的，而在國內網路普及率 2011年網路人口已達 1,614萬
人，佔全國人口數 2,301萬約 70.0%，如表錯誤! 所指定的樣式的文字不存在文件中。-2。
表錯誤! 所指定的樣式的文字不存在文件中。-1 2011年 3月全球網路使用人口
資料來源：Internet World Stats
表錯誤! 所指定的樣式的文字不存在文件中。-2 2011年 3月亞洲國家網路普及率
Population Internet Users, Penetration Internet Users, Users (%)
ASIA ( 2011 Est.) Latest Data (% Population) (Year 2000) in Asia
Korea, South 48,754,657 39,440,000 80.9 % 19,040,000 4.2 %
Japan 126,475,664 99,182,000 78.4 % 47,080,000 10.6 %
Singapore 4,740,737 3,658,400 77.2 % 1,200,000 0.4 %
Hong Kong 7,122,508 4,878,713 68.5 % 2,283,000 0.5 %
Taiwan 23,071,779 16,147,000 70.0 % 6,260,000 1.7 %
Malaysia 28,728,607 16,902,600 58.8 % 3,700,000 1.8 %
Macao 573,003 280,900 49.0 % 60,000 0.0 %
Azerbaijan 8,372,373 3,689,000 44.1 % 12,000 0.4 %
China 1,336,718,015 485,000,000 36.3 % 22,500,000 52.0 %
6目標主機耗盡頻寬資源以至於無法提供服務給使用者，根據中華電信資安辦公室的統計，2009
年中華電信每天平均發生大約 3.7 次的分散式阻斷服務攻擊(Distributed Denial of Service,
DDoS)，其中較大規模的攻擊是以每秒流量 8GB進行攻擊，嚴重影響網路所提供的服務品質。
Sophos 資深安全顧問 Carole Theriault 表示，目前有愈來愈多的企業員工瀏覽未受規範的網
站、下載具有風險的應用程式或觀看網路影音視訊等行為，此行為容易成為提供鬼客入侵企
業網路的管道。此外，網路異常的使用行為亦會使服務的品質降低，像是突發重大的國際、
政治及社會事件等，大量的使用者同時間造訪網站請求服務，導致流量突然劇增，使得網路
的服務品質降低，如麥可傑克森突然逝世，google 搜尋服務流量突然增加，造成各地網路的
延遲問題增加。因此，現今網路的安全機制已成為網路系統及其應用的重要議題。
為了防止鬼客阻斷線上服務、商業機密遭竊或異常的使用行為，坊間許多網路安全公司
與系統開發機構開發了眾多形式的網路安全偵測系統。目前網路型安全防護系統依據運行模
式大致可分為兩類，分別是線上型(In Line)分析及離線型(Off Line)分析[22][24]。線上型網路
流量偵測系統主要是藉由解析網路封包表頭(Packet Header)內容，可即時分析封包判斷是否異
常，若有異常可立即通知網管人員，有效達到異常偵測及防止攻擊[10][37]。線上型雖然可以
精確地偵測出異常封包，但因為封包的解析與特徵比對需要耗用不少時間，且解析過程會耗
用偵測系統大量的運算資源。當網路封包傳輸數量超出系統最大解析的負荷，系統常因為資
源不足負荷分析大量的網路封包，增加封包延遲(Packet Delay)時間而讓網路傳輸品質下降，
甚至造成封包遺失(Packet Loss)的問題影響偵測的準確率[33]。此外，線上型網路偵測的特性，
容易造成系統本身成為攻擊的目標，使得偵測系統無法運作而造成網路中斷。因此，許多學
者進而發展離線型網路偵測系統，如網路流量分析、日誌紀錄檔等[12][24][28][31][62]。離線
型分析系統不需線上解析網路封包，而是藉由分析網路流量或日誌紀錄檔進行異常偵測，如
此可避免因分析大量封包造成網路服務不穩的情形發生。再者，由於離線型流量偵測系統是
將區域網路內所產生的封包資訊擷取至分析主機，故可以降低直接解析封包所產生的封包延
遲與封包遺失，以維持網路封包的傳輸效率，但離線型分析因為資訊量的不足，相較於線上
型有較高的誤判率。
無論哪種形式的偵測系統，網路安全終究需要專業人員進行必要的管理。網管人員為了
維持良好的網路傳輸品質，必須經常透過修補主機漏洞、建構防火牆規則、設置入侵偵測系
統、分析日誌紀錄檔等，判斷目前網路是否屬於正常的使用行為。另一方面，也需處理更新
入侵特徵值、系統當機處理、網路效率降低等維護工作。因此，網管人員需要高度的專業知
識才能維護上述防護活動。
從許多網路的實證研究中發現，當網路的使用人口、習性、環境及系統架構沒有重大改
變的情況下，網路流量會出現特定的週期模式，例如學校機構，學期內學生每周上課時間及
課後的生活起居大致相同，網路的使用人數及習性會依照上下課時間出現類似的行為，如此
同一時段網路流量則會具有某種程度的相似性，推廣至企業組織，在上下班時間固定及工作
內容沒有太大差異的情況下，公司人員使用網路的習性每周應該相差不大，每天的網路流量
應該也會與之前的流量具有相關性。
考量現有網路安全偵測系統的問題及減輕網管人員工作負擔與壓力，本研究基於統計製
程管制(Statistical Process Control, SPC)的概念及手法，並參照上述流量資料的特性，建構以平
均數管制圖( X Control Chart)及指數加權移動平均(Exponentially Weighted Moving Average,
EWMA)管制圖為基礎的離線型網路安全偵測系統。透過本研究所建構偵測流量異常之 X 與
82. 文獻探討
本研究應用統計製程管制手法，建構離線型網路偵測異常之統計模式。故本章節將針對
網路異常使用行為、網路防護機制、離線型分析系統、管制圖、流量監控系統以及流量分析
系統等六方面，分別進行相關文獻回顧。
2.1. 網路異常使用行為
現今網路使用者急速成長與多媒體服務的流行，客戶端(Client)或服務提供者(Servers)經
常遇到頻寬不足的困擾，例如在頻寬接近滿載時，影音通訊可能會有嚴重的影音不同步。為
了提高網路服務品質，可藉由 QoS(Quality of Service)機制，其主要的作用為針對不同的客戶
端或依據應用程式的需求，提供相對應的優先順序及穩定的網路流量來滿足程式或客戶端所
需之標準，使網路管理員有效的控制方式來管理網路資源使用。透過網路品質機制的最終目
的是希望能夠提供最大的效能和高品質服務。
為了滿足不斷增長的需求，網路管理員需不斷改善伺服器服務能力，但網路用戶端還是
經常對網路的性能不滿。隨著新一代多媒體應用程式及雲端技術的普及，這種狀況更加惡化，
以 P2P Stream為例，透過點對點傳輸影音串流可以降低影音服務端的主機負荷，但缺點是會
占用大量連線數與網路頻寬，造成封包容易遺失或延遲的問題。另一方面，造成網路服務品
質低落的原因來自於網路攻擊者，又稱鬼客；利用主機安全漏洞或植入病毒進行竊取資料、
系統破壞等行為。除了入侵與竊取資料等資訊安全問題之外，藉由大量的網路封包或通訊協
定漏洞的阻斷服務(Denial of Service, DoS)來攻擊特定目標之服務系統[37][44][54]；攻擊行為
通常為長時間大量封包傳輸來耗盡目標網路頻寬、消耗系統之可用資源，使目標主機無多餘
資源服務正常使用者，如圖 2-1。
圖 2-1 DoS攻擊原理
過去著名商業網站如 Yahoo、Amazon.com、CNN.com、ZDNet、Buy.com 等都曾遭到分
散式阻斷服務攻擊(Distributed Denial of Service, DDoS)[41][44]，而分散式阻斷服務攻擊為阻
斷服務攻擊的一種變形，利用網路分枝的原理，進行多方面的攻擊，其攻擊行為以網路上多
台電腦主機同時發送大量封包，阻斷目標的電腦主機，使其耗盡頻寬及系統可用資源，使其
無法繼續服務正常的使用者。攻擊的組成有四個部分：真實的攻擊者(Real Attack)、發動攻擊
的主機(Master)、攻擊伺服端(Deamon)及受害的目標主機(Victim) [44][44]。由真實的攻擊者發
送執行(Execute)的指令至發動攻擊的主機，發動攻擊主機接收其指令傳至多台的攻擊伺服
端，而多台攻擊伺服端開始以大量的封包阻斷受害的目標主機，如圖 2-2。最近 09年微網誌
10
表 2-1網路安全防護機制說明
防護機制 安全防護對象 說明
網路入侵偵
測系統 防護區域性多主機
解析進出的流量封包內容，與
特徵資料庫比對分析判斷，藉
以偵測及阻止異常封包。
流量分析系
統 防護區域性多主機
藉由過去所蒐集的網路封包
流量，建構正常網路使用的流
量模式，藉以偵測異常流量。
網路防火牆
系統
軟體形式：大多為防護單一主機
硬體形式：大多為防護區域性多
主機
使用軟體或硬體防火牆設定
進出規則(Rules)或權限表
(AccessList)，用以控管網路封
包(Packets)的進出權限，可防
止大多數非法入侵行為。
日誌分析系
統 防護單一主機
藉由過去所搜集的系統服務
日誌，建構正常網路使用的行
為模式，藉以分析及偵測主機
是否有異常行為。
電腦主機系
統 防護單一主機
利用系統工具、網管軟體或修
補漏洞等。達到防止鬼客入侵
主機、偵測系統異常與入侵行
為。
網路頻寬管
理系統 防護區域性多主機
分配網路服務的執行優先順
序與頻寬大小，管控封包進出
區域網路的流量控制，以達到
最好的網路服務品質(Quality
of Service)及防止網路頻寬資
源的濫用及破壞。
上述的防護機制功能各有所司，其中電腦主機系統的安全防護對象為單一主機，無法監
控整體網路服務品質，而且不同的作業系統版本之安全漏洞修護方法相異，造成網管人員維
護主機漏洞成本過大。另一方面，電腦主機系統的安全防護主要適用於防止入侵，然而對於
阻斷服務攻擊、病毒散布等攻擊行為的偵測效果不佳，對於鬼客攻擊行為造成整體網路服務
品質降低的偵測。網路入侵偵測系統(Intrusion Detection System, IDS)具備較全面性防護機
制，能夠提供準確偵測網路鬼客攻擊事件，如偵測通訊埠掃瞄攻擊、緩衝區溢位攻擊、阻斷
服務攻擊、蠕蟲攻擊、TCP堆疊掃描、作業系統弱點攻擊等。
IDS 的防護機制可以即時偵測出網路上的異常行為，或是找出違反網管人員自訂的網路
安全規則的使用行為。藉由即時分析網路封包或系統日誌，進行比對入侵特徵資料庫，藉以
判斷是否違反安全規則或符合特徵資料庫的攻擊行為，可即時回報給網路管理人員。一般而
言，IDS依部署方式的不同主要可以分成兩類[20][22]：
(1) 網路型入侵偵測系統(Network-Based Intrusion Detection System，NIDS)
NIDS防護機制是擷取每一個經過路由器的網路封包，擷取封包後進行分析與比對；通常
將網路卡設定為雜亂模式(Promiscuous Mode)，來偵測分析流經網路層(Network Layer)的封包
資訊[9][19]。若取得封包的特徵資料與安全系統內置攻擊規則吻合，入侵偵測系統就會發出
警報(Alert)通知管理者。由於偵測系統設置在路由器節點，可以保護區域網段內的所有主機，
12
表 2-3所示：
14
定為可能入侵攻擊。因此，建構異常偵測系統通常藉由統計方法、預測模型、類神經網路或
資料採礦等技術，將正常使用的電腦負載率、記憶體利用率、歷史活動資料、訪問時間和次
數等行為記錄進行分析，建構出正常行為模組，以提供比較未來的活動行為。異常偵測系統
可改善誤用入侵偵測對於未知攻擊特徵無法準確偵測的缺點，或是較複雜的入侵行為，但誤
報率(False Alert Rate)也較高[5][10]，例如使用者在某一期間使用特定指令頻率過低、訪問次
數遽增等，則偵測系統極有可能判定成異常行為。
綜合誤用偵測系統與異常偵測系統兩者的優缺點，其分析如表 2-4 所示[4][56]；根據
[8][21][26]可將過去主要的網路安全偵測系統以偵測模式與分析技術分類，如
16
表 2-5 偵測模式與分析技術
不當行為偵測
(MisuseDetection)
將過去已知的攻擊事件，建立其異常特徵資料庫，透過比
對來判斷是否為異常。此方法的優點是不易誤判，但是受
限於已知的攻擊模式，所以偵測率不高。
異常偵測
(Anomaly
Detection)
應用統計的方法，在系統建立正常行為的資料庫，若目前
行為與資料庫中的"正常行為模式"差異過大，則視為異
常，此方法的優點是可偵測未知的攻擊行為且偵測率較
高，但誤判率也相對增加。
模
式
分
類
混合模式偵測
(Mixed And
Hybrid Mode
Detection)
將上述兩種方法綜合使用以彌補缺陷。
統計分析
(Statistic
Analysis)
收集過去的歷史資料建立正常模式，運用統計學中的分類
(Classification)方法將原始資料進行分類。透過比較"正常
模式"與目前行為決定是否為異常行為。此技術具代表性
的有 ARGUS、SPAD、W&S和 NIDAS
類神經網路技術
(Neural Network
Techniques)
利用類神經學習方式，使用正常行為的操作行為資料來訓
練，建立一個正常行為的模型。以提供未來比對不正常行
為。此技術具代表性的有 HyperView和 ACME
貝氏網路技術
(Bayesian
Network
Techniques)
運用貝氏定理的條件機率分析原理，建立各個特徵值發生
的機率。最後依據特徵之間屬性的關係計算出條件機率關
係，建立完整的貝氏網路架構圖。此技術具代表性的有
ICE
分
析
技
術
分
類
資料挖掘技術
(Data Mining
Techniques)
運用資料庫儲存大量數據以資料挖掘的方法，找出整體趨
勢或規則。使用挖掘出的規則監控異常使用行為，可用來
偵測未知的攻擊模式。此技術具代表性的有 FIRE
網路安全偵測系統，已經發展許多年，但偵測系統還存在一些需解決的問題，根據論文
[23]指出過去安全偵測系統有以下幾點問題需要克服：
1. 高誤判率：存在過多的警報資訊，即使在沒有直接針對入侵偵測系統本身的惡意攻擊時，
入侵偵測系統也會發出大量警報。
2. 產品適應能力低：傳統的 IDS產品在開發時沒有考慮特定網路環境的實際狀況；且網路
技術的快速發展，使得網路設備變得複雜化、多樣化。因此入侵偵測產品必須具備能動
態調整，以適應不同環境的需求。
3. 大型網路的管理問題：很多企業規模在不斷擴大，對 IDS產品的部署從單點發展到跨區
域全球部署，這就將公司對產品管理的問題提上日程。首先，要確保新的產品體系結構
能夠支援數以百計的 IDS感測器；其次，要能夠處理感測器產生的警告事件；此外，還
要解決攻擊特徵庫的建立，配置以及更新問題。
4. 可擴展性差：目前很多的入侵偵測方法是使用一個偵測方法應用於一種特定的資料來
源。對於處理多方來源的資料需額外增加新的演算法，無疑會增加系統負擔，降低入侵
偵測的實用性。
18
路安全系統。
2.4. 管制圖
在工業製造過程中經常使用管制圖監控產品品質隨時間變動的狀態，管制圖是由
Shewhart[55]於 1924 年提出，主要是運用統計方法來監控製程是否發生異常，藉由收集製品
品質特性的測量數據，計算平均數(Mean)、中位數(Median)、全距(Range)、標準差(Standard
Deviation)等樣本統計量。在資料服從常態分配的假設條件下，得到管制圖的中心線(Center
Line)與管制上、下限(Upper and Lower Control Limits)。再將由製程抽樣之各組數據繪製於管
制圖中，根據樣本點的分布判斷製程處於在控(In-Control)或是失控(Out-of-Control)狀態，如圖
錯誤! 所指定的樣式的文字不存在文件中。-所示[6]。若出現非隨機散布情形，例如逸出管制
界限、連串上升或下降、週期或特殊形式等，就必須依照失控行動計劃(Out of Control Action
Plan, OCAP)追查製程是否發生異常，並針對可歸屬原因(Assignable Cause)進行改善行動。
在工廠的製造過程中，一連串的生產流程會受到許多不可控制的因素干擾而產生品質的
變異，且這些造成品質變異的原因通常發生機率很小，在統計品管將這些因素歸類為機遇原
因(Chance Cause)或共同原因(Common Cause)；除了不可控制的因素外，製程也有發生某些特
殊因素而造成品質變異，例如：機械故障、刀具磨損、人員操作錯誤或不良原料等，這些因
素對品質特性有非常大的影響，造成品質不穩定或是產出不良品(No Good, NG)，這些因素被
歸類為可歸屬原因或特殊原因(Special Cause)。而管制圖的主要目的是希望透過線上即時抽樣
所得到的在製品的品質特性，迅速地偵測出製程中可歸屬原因的發生，以防止在更多不良品
被製造出來之前，就能針對製程進行診斷並進行發生變異的應對行動以及改善計劃。
圖錯誤! 所指定的樣式的文字不存在文件中。-7 平均數管制圖
在管制圖監控品質特性的運作流程，首先管理者必需每間隔一段時間，例如每隔半小時
或一小時，從生產線中抽取一組產品樣本，並計算樣本的統計量，最後將樣本統計量繪製於
先前建立的管制圖中，透過樣本點的分布與管制界限來判斷製程是否仍在管制狀態。管制圖
的主要功用有下列幾點：
1. 可以有效防止產出過多不良品。
2. 可以輔助改善製程最常發生的變異因素。
3. 可以作為製程參數調整的參考依據。
4. 可以提供製造品質的訊息。
20
(1) MRTG
MRTG(Multi Router Traffic Grapher)[46][47]與 PRTG非常相似，都需要透過 SNMP的方
式來接收流量資訊，一般大多是設 5分鐘為間格時間來收集資料並繪製流量圖。MRTG 最大
的優點就是耗用的系統資源很小，且所收集的流量資料會進行壓縮，所以資料量所占的硬碟
空間是固定的，因此不會有硬碟儲存空間不足的問題；但相對而言，歷史資料壓縮成一星期
或一個月的流量資訊，只保留當天的資料量，這樣就無法查閱歷史流量進行比較與分析，且
MRTG的功能只能提供繪製圖表(如圖錯誤! 所指定的樣式的文字不存在文件中。-7)，不具有
分析流量是否發生異常或是偵測入侵攻擊的功能，而 PRTG所具備的功能與MRTG相似。
圖錯誤! 所指定的樣式的文字不存在文件中。-7 MRTG流量圖
(2) PRTG
PRTG[50]可以透過路由器的 SNMP(Simple Network Management Protocol)協議取得流量
資訊，產生即時網路流量圖形。流量資料的來源可從內部網路的伺服器、路由器以及交換器
(Switch)等多種設備製作流量圖與報表，主要的功能有下列 4點：
1. 監控 Ping值，瞭解封包傳遞狀態。
2. 以不同的時間單位繪製流量圖，例如一天與一個月的流量圖。
3. 能監控記憶體和 CPU的使用率。
4. 可依據不同資料來源分別繪製流量圖。
不論是MRTG或是 PRTG都只能產生流量圖，無法針對已收集到的流量進行分析，甚至
發出警告。對於網管人員監控流量狀態是否發生異常，必須藉由過去流量的趨勢來推估目前
網路是否正常。因此，網管人員需要高度專業與經驗，才能夠勝任判斷流量是否發生異常。
2.6. 流量分析系統
論文[11]所提出的研究方法是長時間蒐集網路流量，並觀察流量變化，透過統計方法達到
網路異常偵測的目的。其所收集的網路流量是藉由路由器中的網路管理功能，以 SNMP的方
式傳送路由器所收到的網路資料到觀測主機。再利用統計的常態分配，以長期收集到的流量
數據來計算平均數與標準差(Standard Deviation)，最後給於一個適當的容忍誤差值或信賴區間
(Confidence interval)，得到流量警界的門檻與流量異常的界線，如圖 2-8所示。若流量資料的
分配是對稱鐘形曲線服從常態分配，則可以得知大約有 68％的觀測值，落在距平均數 1個標
準差的範圍內；95％的觀測值，落在距平均數 2 個標準差的範圍內；99.7％的觀測值，落在
距平均數 3個標準差的範圍內，如圖 2-9。基於給予信賴水準便可以推論抽樣資料有多少百分
比落在母體平均數加減 k 個標準差的範圍內，由此可以得到流量警戒值與異常的界線，做為
網路攻擊偵測的參考依據。
22
3. 研究方法
當網路系統架構、使用人數及習性沒有重大改變的情形下，網路流量會依照使用者的上
網習性，同一時段內會出現相似特性及特定的週期，例如學校機構，學期內學生上課時間及
生活起居大致相同，網路使用人數及習性會依一天作息出現類似的行為，而網路流量則是這
些使用者傳輸資料量的總和，如此長期以來同時段網路流量會具有某種程度的規律性。若透
過統計製程管制的方法，則可利用歷史正常流量資料建立管制圖之異常偵測模型。故本研究
採用統計製程管制的手法，建構離線型偵測網路流量異常之 X 管制圖與 EWMA 管制圖，以
自調式的方法重新計算管制界限，所以每 1 周的管制界限都不同，透過此方法可將最新流量
資料不斷的訓練管制界限。另外，因為 X 管制圖與 EWMA管制圖對於平均數(μ)偏移量的大
小有不同偵測能力；一般在工業管制圖中當製程平均數偏移大於 1.5倍標準差(σ)時， X 管制
圖有較佳的偵測能力；而 EWMA管制圖一般用來偵測 1.5倍標準差之內的製程偏移，對於微
小的平均數偏移有較佳的偵測能力。因為兩種管制圖對於平均數的偏移幅度有不同偵測能
力，所以本研究將分別建構 X 管制圖與 EWMA 管制圖，而欲建構異常偵測模型須先蒐集並
辨別正常流量資料，但實際的網路流量中不容易界定正常或異常流量。因此，本研究以網路
模擬器 NS2模擬流量資料，以此建構離線型網路異常偵測模型。另一方面，本研究針對 EWMA
管制圖偵測模型以 F測度、控制誤報率極小化漏報率及第一點異常偵測三種評估準則，分析
其合適的參數組合，並以不同的抽樣時間探討參數組合之穩健性。
3.1. 流量模組
許多實證的網路流量資料顯示，在單位內部的網路系統架構和網路服務等條件沒有太大
改變的情況下，網路流量會因為使用者上網的習性，在同一時段出現相似性及特定形式的模
式，例如監控網某個段內使用者在上網、收信、網路遊戲等使用習慣，使用者的群體行為可
能蘊含某些類似且規律的表現，圖 3-2 即為銘傳大學資訊學院 2008 年 11 月 10 日至 12 月 1
日四個星期一網路流量(每 5分鐘平均封包數)的折線圖，圖 3-3則為四周星期二網路流量，透
過圖 3-4可以發現在不同的星期(Weekday)有相異的使用行為。若長期收集單位內的網路流量
數據，透過統計分析方法推論使用者的特定行為，進而建立適當的流量統計模型，如此便可
利用此模型偵測網路流量是否發生異常的參考依據。
0
1 0 0 0
2 0 0 0
3 0 0 0
4 0 0 0
5 0 0 0
6 0 0 0
7 0 0 0
8 0 0 0
9 0 0 0
1 0 0 0 0
1 7 13 19 25 31 37 43 49 55 61 67 73 79 85 91 97 10
3
10
9
11
5
12
1
12
7
13
3
13
9
14
5
15
1
15
7
16
3
16
9
17
5
18
1
18
7
19
3
19
9
20
5
21
1
21
7
22
3
22
9
23
5
24
1
24
7
25
3
25
9
26
5
27
1
27
7
28
3
P a c k e tsO u t： 2 0 0 8
11 /1 0 - 1 2 /0 1
2 0 0 8 /1 1 /1 0 2 0 0 8 /1 1 /1 7 2 0 0 8 /1 1 /2 4 2 0 0 8 /1 2 /1
圖 3-2 銘傳大學星期一網路流量折線圖
24
圖錯誤! 所指定的樣式的文字不存在文件中。-5 網路流量管制圖呈現
因為網路流量在同一Weekday中相同時點具有相似性，所以本研究首先依Weekday將所
收集的流量進行分組，1周有 7個Weekday共分成 7個模組(Module)，如表 3-7。不同模組下
使用者與網路使用習性不盡相同，因此流量資料所具備的規律性亦相異。另外考量到寒暑假
的使用者與學期當中上課日有極大的不同，在學期中因為學生與教師大多都在校園內或宿舍
使用網路，而到了寒暑假多數的學生離開校園，所以 7 個模組在計算管制界限時不會納入寒
暑假的資料，以免不同的流量行為造成計算誤差。
表 3-7 模組的分類
Weekday 模組(Module)意涵
1 星期一的流量模組
2 星期二的流量模組
3 星期三的流量模組
4 星期四的流量模組
5 星期五的流量模組
6 星期六的流量模組
7 星期日的流量模組
訓練資料
時
點
1
時
點
2
時
點
288
Control Chart
UCL
CL
1         2 ‧‧‧                 288
第 1周
第 2周
‧
‧
‧
第 m周
LCL
μ1 μ2 ‧‧‧ μ288
26







−=
=
+=
mc
S
LFLCL
FCL
mc
S
LFUCL
j
jj
jj
j
jj
4
4
 , j=1,…,T ( 3 )
傳統工業上平均數管制圖選定 L=3是合理的管制界限寬度，但 L=3是 Shewhart基於常態
分配與型 I、型 II誤差得到的結果，對於網路流量資料而言，適當的參數 L值範圍應是多少？
本研究後續採用 NS2 模擬正常與異常流量資料，以本研究建構的 X 流量管制界限來測試 n
組異常與正常資料得到管制模型的誤報率與漏報率，透過兩種評估值來探討適合的 L值。
由於平均數管制圖是利用個別樣本觀測值，藉以判斷製程是否在管制的狀態內，因為管
制模型只採用個別觀測值來偵測製程是否發生變動，故適用於製程平均數有較大偏移，對於
偵測製程平均微幅變動不易偵測出。對於平均數管制圖不易偵測出些微變異的問題，有學者
根據製程資料是一連串時間序列的特性，提出管制圖不應該只考慮最新的抽樣資料來判斷是
否發生異常的看法，應將現在和過去的抽樣資料一併納入考量，以增加管制圖的偵測能力。
因此，論文[49]]提出累積和管制圖(Cumulative Sum Control Chart, CUSUM)，其利用累加樣本
觀測值的觀念將過去的歷史訊息納入判斷製程是否發生異常；另外論文[51]也提出指數加權
移動平均管制圖(EWMA)求取移動平均的樣本統計量，其統計量是根據越久的歷史資料給予
越低的權重值。這兩種特殊管制圖被廣泛運用在偵測製程微幅偏移，且已證明 CUSUM 管制
圖與 EWMA管制圖比傳統 Shewhart 管制圖能夠更靈敏偵測製程平均是否失控。除此之外，
特殊管制圖的適用範圍更廣泛，可用於自我相關及非常態的抽樣資料。因為過去並沒有學者
以縱向的網路流量來建構 X 與 EWMA管制圖，所以本研究除了以 X 管制圖來建構異常流量
偵測模型，也加入 EWMA管制圖來探討兩者的偵測靈敏度。
3.3. 指數加權移動平均(EWMA)管制圖模型
3.3.1. 符號定義
j : 網路封包抽樣時點，j = 1,...,T。
m : 正常流量下，建立管制圖之訓練資料集 I的周數。
n : 正常流量下，建立並評估管制圖之訓練資料集 II的周數。
λ : EWMA管制圖平滑指數。
L : EWMA管制界限寬度。
0
, jiF :
訓練資料集 I中，第 i筆(周)資料於時點 j之流量資料，
i = 1,...,m，j = 1,...,T。
0
jF :
訓練資料集 I於時點 j之平均數，即 ∑
=
=
m
i
jij F
m
F
1
0
,
0 1 ，
j = 1,...,T。
jiF , :
訓練資料集 II中，第 i筆(周)資料於時點 j之流量，
28
.
.
.
j
i
j
i
jijiji MFFFF ,0,1
1
,2
2
,1, )1()1(...)1()1(  −+−++−+−+= −−−
niMλ)(Fλ)(λ jijki
i
k
k
,...,1,11
,0,
1
0
=−+−=
−
−
=
∑ 　　　　
故得證。
由引理 1 可發現 EWMA 統計量 jiM , 為歷史流量資料的加權平均，權重值 λ(1-λ)k隨歷史
資料延遲周數 k呈幾何數列遞減，如圖錯誤! 所指定的樣式的文字不存在文件中。-6所示。
0
0.05
0.1
0.15
0.2
0.25
0.3
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
權
重
資料延遲週數k
λ= 0.5
λ= 0.1
圖錯誤! 所指定的樣式的文字不存在文件中。-6 EWMA權重依據抽樣時間之遞減圖
本研究進一步假設在正常流量下，第 i 筆(周)資料於時點 j 之封包大小 jiF , 服從某特定分
配且 jiF , 與 jiF ,′ 彼此獨立，其中 ii ′≠ ，則有以下定理 1。
定理 1：若 niF jj
indep
ji ,...,1,)( 2, =～ ，則 EWMA統計量 jiM , 的期望值與變異數分別為：
jjiME =][ , ( 5 )
與 [ ] )1()1(1
2
][
2
22
, 


 −
+−−
−
=
m
MVar
i
i
jji

 。 ( 6 )
證明：由引理 1可得
30
( )[ ] ( )
( )[ ] ( )111
2
111
2
2
2
2
2







−
+−−


−
⋅⋅−=
=
−
+−−


−
⋅⋅+=
m
SLFLCL
FCL
m
SLFUCL
i
ii
j
i
j
i
j
i
j
i
j
i
ii
j
i
j
i
j




Tjni ,...,1,,...,1, ==　
( 9 )
備註：當 i變大時，因為(1-λ)2i趨近到 0，再根據大數法則(Law of Large Numbers)， ijF 與
( )2ijS 分別趨近 j 與 2j ，故 EWMA管制中心、上下界限趨近於：
Tjni
LLCL
CL
LUCL
jj
i
j
j
i
j
jj
i
j
,...,1,,...,1,
2
2
==







−
⋅⋅−=
=
−
⋅⋅+=
　





( 10 )
EWMA管制圖偵測表現主要是由 L和 λ參數來決定，一般而言工業製程 EWMA管制圖
λ值的範圍建議是 0.05≦λ≦0.25，L則建議使用 2.6與 2.8之間的數值。過去學者所提出的建
議參數是依據工業製程的數據特性，但對於網路流量資料而言，前述建議的λ與 L值是否仍
然適用？這點值得商確。關於管制界線寬度 L與平滑指數λ值的選擇，本研究將繼續以 NS2
模擬異常流量資料，以本研究建構的 EWMA 流量管制界限來測試多組異常資料得到誤報率
與漏報率，透過兩種績效值來探討適合的 EWMA管制圖參數組合。
3.4. 網路模擬器 NS2
因為建構正常流量之管制上下界限須先蒐集正常的網路流量，而真實生活中網路流量較
難取得，且所蒐集到的流量數據難以界定是否屬於正常流量。所以本研究以學術界廣泛採用
的 NS2網路模擬器，用以產生 HTTP網路流量，以下將介紹 NS2軟體、模擬環境以及資料蒐
集。
NS2是一種以 C++與 TCL兩種程式語言所組合而成，屬於引發非連續事件(Discrete-Event
Driven)及物件導向(Object Oriented)的網路模擬器。透過結合兩種不同的程式語言可兼具彈性
與執行速度；藉由 TCL 撰寫引發事件的腳本達到因應各種模擬環境，再以 TCL驅動 C++物
件來產生網路行為，可以模擬路由器(Router)、鏈路(Link)、網路的節點(End Point)、封包的延
遲(Packet Delay)或封包的丟棄(Packet Drop)等網路性質[17]。所以一般而言，模擬網路環境較
常變動部分大多以 TCL語言來編寫離散事件，例如網路連線速率、封包大小、模擬時間以及
開始與結束時間等，不常更動的網路底層物件以 C++語言來撰寫，執行編譯後的物件運算速
度較快，再以 TCL來驅動網路通訊協定、封包傳送等 C++物件。以下面簡單的範例來說明非
連續事件引發：
32
表錯誤! 所指定的樣式的文字不存在文件中。-3 TCL腳本範例
#===================================
#        Initialization
#===================================
# 產生模擬物件
set ns [new Simulator]
#定義不同的資料流顏色，給 NAM用
$ns color 1 Blue
$ns color 2 Red
#開啟流量記錄檔
set tracefile [open out.tr w]
$ns trace-all $tracefile #記錄所有網路傳送資訊
#開啟 NAM紀錄檔
set namfile [open out.nam w]
$ns namtrace-all $namfile
#===================================
#        Nodes Definition
#===================================
#產生四個網路節點
set n0 [$ns node]
set n1 [$ns node]
set n2 [$ns node]
set n3 [$ns node]
#===================================
#        Links Definition
#===================================
#把節點連接起來
$ns duplex-link $n0 $n2 2Mb 10ms DropTail
$ns duplex-link $n1 $n2 2Mb 10ms DropTail
$ns duplex-link $n2 $n3 1.7Mb 20ms DropTail
#===================================
#        Agents Definition
#===================================
#建立一條 TCP的連線
set tcp [new Agent/TCP]
$tcp set class_ 2
$ns attach-agent $n0 $tcp #將 TCP 掛載至 n0節點
34
表錯誤! 所指定的樣式的文字不存在文件中。-3 TCL腳本範例(續)
proc finish {} {
    global ns tracefile namfile
    $ns flush-trace
    close $tracefile
    close $namfile
    exec nam out.nam &
    exit 0
}
#設定 FTP和 CBR資料傳送開始和結束時間
$ns at 0.1 "$cbr start"
$ns at 1.0 "$ftp start"
$ns at 4.0 "$ftp stop"
$ns at 4.5 "$cbr stop"
#5秒後呼叫 finish來結束模擬
$ns at 5.0 "finish"
#執行模擬
$ns run
圖錯誤! 所指定的樣式的文字不存在文件中。-8 NAM顯示畫面
3.4.1. 建構運行 NS2 環境
NS2 最早期版本必須建構在 Linux 核心的作業系統中，到後期可以使用 Cygwin 軟體在
Windows系統模擬 Linux系統的作業環境，便可以安裝與執行 NS2網路模擬器。使用 Cygwin
的好處是不用重新安裝與學習 Linux 作業系統的操作方式，對於 Linux 作業系統不熟悉者較
容易安裝 NS2；但是使用 Cygwin在執行 NS2時模擬執行速度較差。因此本研究決定採用具
有 Linux核心與圖形化界面的 Ubuntu作業系統，以減少執行模擬所需耗用時間。
36
圖錯誤! 所指定的樣式的文字不存在文件中。-9 TCP建立連線步驟
本研究行採用 NS2內建之 HTTP通訊協定模擬網路流量數據，用來驗證網路安全系統有
效性，並且探討網路流量管制圖的合適參數。此 HTTP流量模組是由論文[32]所提出，其發
展 HTTP流量產生器是參照兩個真實網路資料集 BELL Database和 UNC(University of North
Carolina) Database，探討網頁流量具有哪些變數特徵，例如 Per Second Connection Number、
Round-Trip Time、Request Size、Response Size和 Server delays等，再個別分析變數屬於何種
統計分配，建構出模擬 HTTP流量之數學模型。最後將建構出的 HTTP數學模型以 NS2模擬
器為平台，提供使用者模擬 HTTP網路流量。論文[32]進一步使用 NS2產生多組 HTTP流量
來驗證仿真效果，實驗結果發現產生的模擬數據非常接近真實流量，且此流量模組廣泛的被
運用在學術研究。
使用 NS2之 HTTP模組產生網頁流量需要設定 2個網路節點(Node)客戶端(Client Node)
與伺服端(Server Node)來建立 TCP連線。TCP連線建立完成後，客戶端會送出請求(Request)
到伺服器，伺服器接收 Request等待處理完成將資料回傳(Response)到客戶端，如圖錯誤! 所
指定的樣式的文字不存在文件中。-10所示。
圖錯誤! 所指定的樣式的文字不存在文件中。-10 NS2-HTTP連線架構(資料來源：[32])
38
表錯誤! 所指定的樣式的文字不存在文件中。-，其 HTTP模組詳細的相關參數，如以下 9點
[59]：
1. New PackMimeHTTP：建立新的 PackMimeHTTP物件。
2. $packmime set-client <node>：將 PackMimeHTTP物件的客戶端指定在某一節點上，
例如 N1節點。
3. $packmime set-server <node>：將 PackMimeHTTP 物件的伺服端指定在某一節點
上，例如 N2節點。
4. $packmime set-rate：設定平均每秒鐘開始新的連線數量。
5. $packmime set-req_size <RandomVariable>：設定 HTTP Request大小。
6. $packmime set-rsp_size <RandomVariable>：設定 HTTP Response大小。
7. $packmime set-flow_arrive <RandomVariable>：設定 HTTP兩個連線的間隔開始時
間。
8. $packmime start：PackMimeHTTP物件開始產生流量時間。
9. $packmime stop：PackMimeHTTP物件結束產生流量時間。
40
3.4.3. 模擬環境
NS2所產生的流量數據是依照使用者撰寫 TCL腳本中的事件來控制，使用者可以決定
HTTP的 Client端與 Server端之節點個數、網路架構、模擬時間、應用層開始產生網路流量
與結束時間等。以下為本研究建構之網路模擬架構：
1. 建構 250個內部與 250個外部客戶端網路節點。兩者差異性在於網路連線延遲時間。
2. 建構 2個Web伺服端節點。
3. 客戶端網路節點連接到 1 個匯整路由器節點，再由路由器節點連線到各伺服端節
點。
4. 每一個客戶端節點都產生 PackMimeHTTP 模組之網路流量，並且依照均等分配指
定到伺服端 1或伺服端 2。模擬時間長度為 120秒。
5. 將模擬器的網路架構與模組參數 TCL 腳本撰寫完成後，透過圖錯誤! 所指定的樣
式的文字不存在文件中。-12說明有關於模擬器在本研究使用的流程。
產
生
正
常
流
量
管
制
圖
建
模
產
生
正
常
流
量
與
異
常
流
量
調整管制圖
參數
計算
誤判率、漏報率
合
適
的
管
制
圖
參
數
圖錯誤! 所指定的樣式的文字不存在文件中。-12 模擬與建立管制圖之流程圖
3.4.4. 資料蒐集
為建立管制界線須蒐集多筆正常行為下的網路流量，建構管制界線後因為需要透過正常
流量的誤報率與異常流量之漏報率來評估合適的管制圖參數(L)，所以需要再個別模擬正常與
異常的網路流量。
因本研究所建立的 NS2模擬環境產生流量紀錄非常龐大(單一紀錄檔大小平均 8 GB)，且
模擬器運算過程以及整理數據需耗用許多時間，所以在建構 X 偵測模型先模擬 m = 15組(周)
正常資料集，作為建構管制圖中心線以及上下界線之用；後續再個別模擬正常流量n = 47組(周)
網路流量微量增加情況下的異常流量數據 n = 47組(周)，最後以誤報率與漏報率來探討合適
的管制圖參數。
至於建構 EWMA偵測模型同樣先使用 m = 15組(周)正常流量資料，計算 EWMA統計量
的初始值 jM 0 ，後續再產生 n = 47組(周)正常流量資料用來訓練管制圖之平均數、管制上下界
限。並再次進行模擬網路封包微量增加情況下的異常流量數據(47組)，以正常流量所訓練的
管制界限進行測試異常流量監控狀況，最後進一步評估在正常網路流量及異常狀態下偵測模
型之誤報率與漏報率。在第一點異常偵測之評估準則方面，產生 47組正常流量結合異常流
量，當作入侵的攻擊行為，藉以找尋及評估 EWMA偵測模型的參數組合。另外，為了探討
42
表錯誤! 所指定的樣式的文字不存在文件中。-。
44
4. 模擬結果與討論
網路模擬器產生正常與異常的資料，可以提供分析網路異常偵測模型的參數建議範圍，
解決不易取得真實網路流量的困難。另外模擬器也可避免在真實網路環境中進行異常流量行
為所造成的問題，例如伺服器當機、佔去可用網路頻寬或是影響使用者的服務品質等因素。
最後藉由模擬數據來進行探討與分析，給予本研究所提出的偵測模型參數之建議值範圍，以
下將針對 X 與 EWMA管制圖分別探討合適的參數建議值。
4.1. X 管制圖之模擬分析
將模擬結果整理為
46
表錯誤! 所指定的樣式的文字不存在文件中。-8 X 平均誤報率與漏報率
管制界限寬度(L) 平均誤報率(47組)(False Positive Rate)
平均漏報率(47組)
(False NegativeRate)
3 98.16% 0.83%
3.5 97.83% 0.83%
4 97.32% 0.83%
4.5 96.79% 0.83%
5 96.00% 0.84%
5.5 95.12% 0.84%
6 93.89% 0.85%
6.5 91.85% 0.86%
7 89.05% 0.87%
7.5 86.51% 0.88%
8 82.28% 0.90%
8.5 79.16% 0.93%
9 74.63% 0.95%
9.5 68.54% 0.99%
10 64.82% 1.04%
10.5 59.08% 1.09%
11 55.13% 1.15%
11.5 49.68% 1.22%
12 45.46% 1.29%
12.5 47.54% 1.39%
13 37.61% 1.51%
13.5 39.86% 1.63%
14 38.82% 1.77%
48
為了驗證上述所建構的管制圖表現，本研究進一步模擬一組正常與一組異常資料分別繪
製 X 管制圖，以視覺化圖形呈現，如圖錯誤! 所指定的樣式的文字不存在文件中。-16 與圖
錯誤! 所指定的樣式的文字不存在文件中。-17所示。
0
2
4
6
8
10
12
14
16
18
1 4 7 10 13 16 19 22 25 28 31 34 37 40 43 46 49 52 55 58 61 64 67 70 73 76 79 82 85 88 91 94 97 100103106109112115118
流
量
時間區間 T=120
正常狀態下之平均數管制模型
管制下限 管制中心 管制上限 正常流量
(Mbit)
圖錯誤! 所指定的樣式的文字不存在文件中。-16 正常流量下 L=13之 X 管制圖
0
2
4
6
8
10
12
14
16
18
1 4 7 10 13 16 19 22 25 28 31 34 37 40 43 46 49 52 55 58 61 64 67 70 73 76 79 82 85 88 91 94 97 100103106109112115118
流
量
時間區間 T=120
異常狀態下之平均數管制模型
管制下限 管制中心 管制上限 異常流量
(Mbit)
圖錯誤! 所指定的樣式的文字不存在文件中。-17 異常流量下 L=13之 X 管制圖
50
表錯誤! 所指定的樣式的文字不存在文件中。-9 與圖錯誤! 所指定的樣式的文字不存在文件
中。-18。因為 λ與 L的組合非常多，由於
52
表錯誤! 所指定的樣式的文字不存在文件中。-9可以發現 λ≦0.3時，異常流量的漏報率非常
大。若 0.4≦λ≦0.6，L=1.5，誤報率與漏報率都有比較好的表現，而 0.7≦λ≦0.9，1.5≦L≦2，
誤報率與漏報率也有不錯的表現。因此，本研究所提出之 EWMA偵測模型，建議 λ在 0.4到
0.6之間時，L取 1.5。若 λ取 0.7以上時，L取 1.5或 2。
本研究進一步驗證上述所建構的管制圖表現，其平滑指數 λ取為 0.8、管制界限寬度 L設
為 2，並模擬一組正常與一組異常資料分別繪製 EWMA管制圖，以視覺化圖形呈現，如圖錯
誤! 所指定的樣式的文字不存在文件中。-20、圖錯誤! 所指定的樣式的文字不存在文件中。-21
所示。
54
表錯誤! 所指定的樣式的文字不存在文件中。-2 EWMA偵測模型平均誤報率與漏報率(續)
1 24.91% 0.53%
1.5 8.03% 4.54%
2 2.22% 15.98%
2.5 0.78% 35.04%
3 0.23% 55.27%
3.5 0.05% 74.01%
0.5
4 0.00% 86.01%
1 27.00% 0.28%
1.5 9.63% 2.84%
2 2.91% 11.52%
2.5 0.98% 27.96%
3 0.41% 48.14%
3.5 0.11% 67.11%
0.6
4 0.00% 81.56%
1 28.51% 0.16%
1.5 10.55% 1.95%
2 3.63% 9.20%
2.5 1.17% 23.88%
3 0.55% 43.01%
3.5 0.18% 61.76%
0.7
4 0.04% 77.52%
1 29.79% 0.12%
1.5 11.49% 1.49%
2 3.99% 7.68%
2.5 1.37% 20.74%
3 0.62% 39.54%
3.5 0.23% 57.73%
0.8
4 0.04% 74.36%
1 30.59% 0.11%
1.5 12.18% 1.29%
2 4.29% 6.91%
2.5 1.58% 19.34%
3 0.69% 37.38%
3.5 0.27% 55.64%
0.9
4 0.05% 72.34%
56
1 1
1.5 1.5 1.5 1.5 1.5
2 2
0%
10%
20%
30%
40%
50%
60%
70%
80%
90%
100%
110%
120%
130%
140%
150%
160%
170%
180%
190%
200%
210%
0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9
百
分
比
平均誤判率+漏報率 平均誤判率 平均漏報率 管制界限寬度(L) ?
圖錯誤! 所指定的樣式的文字不存在文件中。-19 EWMA平均誤報率與漏報率分析圖
7
8
9
10
11
12
13
1 4 7 10 13 16 19 22 25 28 31 34 37 40 43 46 49 52 55 58 61 64 67 70 73 76 79 82 85 88 91 94 97 100103106109112115118
流
量
時間區間 T=120
正常狀態下之EWMA管制模型
EWMA統計量 中心線 管制上限 管制下限
(Mbit)
圖錯誤! 所指定的樣式的文字不存在文件中。-20 正常流量下 λ=0.7、L=1.5之 EWMA管制圖
58
表錯誤! 所指定的樣式的文字不存在文件中。-8 與表錯誤! 所指定的樣式的文字不存在文件
中。-10可以發現，EWMA偵測模型整體的誤報率都比 X 偵測模型的表現更好，雖然漏報率
雖然比 X 還要高一些，但考慮到 EWMA誤報率的表現與 X 有非常大的差距。因此，整體而
言 EWMA偵測模型有比較好的表現。但對於真實網路流量資料而言，以 X 與 EWMA管制圖
偵測流量變化的實際偵測能力表現如何？為了驗證本研究所提出之偵測模型，後續將以動態
網頁語言 PHP 結合 PostgreSQL 資料庫來開發網路流量異常偵測系統，此偵測系統運用非同
步處理 AJAX(Asynchronous JavaScript and XML)的技術來減少使用的頻寬。過去傳統的Web
送出或更新資料的方法是，當使用者送出表單時就向Web伺服器發送一個請求(Request)。伺
服器會進行接收與處理使用者傳來的表單資料，然後回傳(Response)一個新的網頁。由於傳統
Web 處理使用者資料的做法浪費了許多網路頻寬，因為大多在前後兩個頁面中只有少部分需
要更新，而其他的 HTML(HyperText Markup Language)碼多數是相同的。而使用 AJAX的優
點是能在不更新整個頁面的前提下，以非同步的方式處理或更新部分數據，使得Web應用程
序更為迅捷地回應使用者的操作，並避免不需要更新的資料重複請求，大幅度降低伺服器和
瀏覽器之間交換的資料，大約可將低 95%的資料傳遞。
5. 網路流量異常偵測系統
本章節將介紹網路流量安全分析系統的系統架構，以動態網頁語言 PHP結合 PostgreSQL
資料庫來開發網路流量異常偵測系統，此偵測系統運用非同步處理 AJAX(Asynchronous
JavaScript and XML)的技術來減少使用的頻寬。
過去傳統的Web送出或更新資料的方法是，當使用者送出表單時就向Web伺服器發送一
個請求(Request)。伺服器會進行接收與處理使用者傳來的表單資料，然後回傳(Response)一個
新的網頁。由於傳統Web處理使用者資料的做法浪費了許多網路頻寬，因為大多在前後兩個
頁面中只有少部分需要更新，而其他的 HTML(HyperText Markup Language)碼多數是相同的。
而使用 AJAX 的優點是能在不更新整個頁面的前提下，以非同步的方式處理或更新部分數
據，使得Web應用程序更為迅捷地回應使用者的操作，並避免不需要更新的資料重複請求，
大幅度降低伺服器和瀏覽器之間交換的資料，大約可將低 95%的資料傳遞。
5.1. 系統架構
實驗環境是採用 Fedora作業系統，用來架設 Web Server與 PostgreSQL資料庫作為網路
流量異常偵測系統的平台。主要是將每 5 分鐘所取得 Netflow 資料寫入資料庫，資料表
netflow_metric(如表錯誤! 所指定的樣式的文字不存在文件中。-11)是流量模組(Weekday)的主
要資料來源，目的是用來訓練正常流量下的管制界限與監控未來流量是否發生異常。再以 PHP
結合 AJAX技術進行開發，以提供反應迅速的網路安全偵測系統，使得網管人員可以透過網
頁達到即時監測網路流量是否發生異常。除了蒐集 5分鐘的 NetFlow之外，也會進行記錄 IP、
來源與目標、Port以及即時流量等資訊(如表錯誤! 所指定的樣式的文字不存在文件中。-12)，
60
圖錯誤! 所指定的樣式的文字不存在文件中。-22 系統流程圖
5.2. 資料蒐集
藉由已經收集銘傳大學資訊學院 2008/09/01至 2009/09/01一年，以每 5分鐘取得 Netflow
一天共有 288 筆資料的歷史流量。透過網管專家利用視覺對歷史流量進行篩選，過濾掉明顯
異常或是有缺陷的資料，例如網路連線中斷、停電造成歷史流量有斷層等。篩選後的資料再
依照Weekday進行模組分類，總共 7個模組資料。因為考慮到寒暑假會造成使用環境的改變，
所以依據Weekday分組後，再進行剃除在寒暑假範圍中的資料，最後分別計算 Bytes IN/OUT
與 Packets IN/OUT之 EWMA模型的管制界限，並將訓練資料集 I(m筆)、訓練資料集 II(n筆)
與計算出的平均和、標準差、中心線以及 EWMA統計量儲存至 netflow_model資料表，以提
供網頁繪製管制圖與未來加入新資料進行自調式計算平均數與標準差，達到動態調整管制界
限。
5.3. 偵測系統介面
透過撰寫 PHP程式對資料庫進行資料查詢，然後使用 JpGraph製作圖表，例如管制圖、
圓餅圖、長條圖以及表格等功能，以 HTML結合 CSS(Cascading Style Sheets)進行網頁的美化
與排版。最後再透過 AJAX來達到動態更新資料以呈現最新資訊，便能在不更新整個頁面的
前提下更新部分畫面，讓網頁更為迅捷地回應用戶動作，例如切換BYTEs IN/OUT與PACKETs
IN/OUT只會更新管制圖區域(Div Tag)，不會整個網頁重新載入，其系統畫面如圖錯誤! 所指
定的樣式的文字不存在文件中。-23 與圖錯誤! 所指定的樣式的文字不存在文件中。-24 所呈
現。AJAX 並非開發網頁的創新技術，而是综合了 JavaScript、DHTML(Dynamic HTML)、
DOM(Document Object Model)、CSS、XMLHttp以及 XML(eXtensible Markup Language)等多
種網頁開發技術，藉由 JavaScript 發出非同步請求(XMLHttpRequest)與 Web 服務器進行溝通
取得資料，在客戶端亦用 JavaScript處理來自伺服器的回應。
62
更新。亦即當更新某一部分資訊時，不需要整個網頁重新載入，這是使用 AJAX的好處，讓
網頁更新部份資訊時使用者可以持續關心其他部份的資訊。
5.4.1. EWMA管制圖
呈現今天的 NetFlow 偵測資訊(如圖錯誤! 所指定的樣式的文字不存在文件中。-25)，除
了顯示管制中心(CL)、EWMA(EPI、EPO等)統計量以及管制上下界線(UCL/LCL)等，也加入
當天實際 NetFlow(PI、PO等)，讓管理者可以很快的瞭解目前流量是否有發生異常。若 EWMA
統計量有超出管制界限就將異常數(Anomaly)加 1，讓管理者不需要仔細比對是否有溢出管制
界限。為了可以更加瞭解異常資訊，管理者可以點選圖片就可顯示目前哪幾筆資料超出管制
界限、實際流量、EWMA統計量以及管制界限等資訊，如圖錯誤! 所指定的樣式的文字不存
在文件中。-26。
圖錯誤! 所指定的樣式的文字不存在文件中。-25 當日 NetFlow管制狀態
packetin Out of Control
第 22筆 實際封包數 : 361 ， PI_EWMA統計量 : 484.82622465134
管制上限 : 2614.7249970231
管制下限 : 540.88790620267
第 23筆 實際封包數 : 346 ， PI_EWMA統計量 : 469.25413497925
管制上限 : 2512.8276326905
管制下限 : 570.78527053528
圖錯誤! 所指定的樣式的文字不存在文件中。-26 Out of Control資訊
5.4.2. 單位時間流量圖
單位時間流量(圖錯誤! 所指定的樣式的文字不存在文件中。-27)可即時動態顯示目前進
出的封包數以及流量大小。藉由查詢資料庫中的 netflow_realtime資料表，來顯示紀錄每十秒
的流量資訊。透過此資訊讓管理者了解網路目前即時的流量與封包進出的數量。
64
圖錯誤! 所指定的樣式的文字不存在文件中。-29 當天 Application 排行榜
圖錯誤! 所指定的樣式的文字不存在文件中。-30 當天 IP圓餅圖
66
6. 結論
本研究結合了資訊管理和統計製程管制的概念與手法，建構監控網路流量之 X 與 EWMA
管制圖。過去鮮少有學者將網路流量與管制圖進行探討，也未曾將流量分為不同的模組，依
據每周的同一天同個取樣時間點具有相似性來建構管制界限。因此，本研究根據了 7 個流量
模組再分為不同的時間點來建構管制界限，所以一個模組就有不同抽樣時點的管制界限，最
後所顯示的管制圖是不同時點最新的抽樣觀測值與管制界限，以銘傳大學實際流量為例，以
每 5分鐘抽樣一天共有 288個時點，一周有 7個流量模組，所以一天有 288個管制界限。除
了理論模型的建構外，本研究也採用 NS2模擬器來排除實際流量無法確定是否為異常流量的
問題，摒除網路流量是否屬於正常或異常之不確定性因素，影響分析合適的管制圖參數。最
後也實際開發了網路安全偵測系統，透過自調式 EWMA 模型會將正常的流量每天的累加到
模型中，不需要儲存大量的歷史流量資料。系統除了顯示目前網路流量，透過管制界限可以
很輕易的瞭解目前網路流量是否發生異常，達到即時偵測的效果，並且改善線上型偵測系統
封包分析延遲的瓶頸問題，提供一個有效迅速的異常分析機制。
歸納本研究主要貢獻臚列如下：
1. 過去入侵偵測系統的研究多數是採取時間橫斷面的方式建立時間序列模型，而本研究則
考量縱斷面的網路流量資料具有相似行為且相關性較低，如此便能依據統計製程管制的
原理，建立監控網路流量之 X 與 EWMA管制圖。
2. 使用 NS2模擬軟體模擬各種情境下的網路流量數據，在誤報率與漏報率的權衡下得到 X
與 EWMA管制圖中管制界限寬度 L與平滑指數的合理範圍。
3. 實際開發一套基於管制圖概念之網路流量安全系統，系統具備 X 與 EWMA 管制圖、即
時流量圖、IP使用比率、Application使用比率等四大功能。
4. 本研究是以動態網頁語言 PHP 結合 PostgreSQL 資料庫來開發網路流量異常偵測系統，
此偵測系統運用非同步處理 AJAX(Asynchronous JavaScript and XML)的技術改善了傳統
Web處理使用者資料的做法減少使用頻寬，使得Web應用程序更為迅捷地回應使用者的
操作，避免不需要更新的資料重複請求，大幅度降低伺服器和瀏覽器之間交換的資料，
大約可將低 95%的資料傳遞。
68
[27] Anderson, D., T. Frivold, and A. Valdes, Next-generation intrusion-detection expert system
(NIDES). Technical Report SRI-CSL-95-07, Computer Science Laboratory, SRI International,
1995.
[28] Bin, L., L. Chuang, et al., Netflow Based Flow Analysis and Monitor. Communication
Technology, 2006. ICCT '06, pp. 1-4, 2006.
[29] Bin,L., Chuang,L., Donghua,R., Xuehai,P., Netflow Based Flow Analysis and Monitor.
International Conference on Publication Date: Nov. 2006 On page(s): 1-4, 2006.
[30] Bjurling, B., L. Rasmusson, et al., Qualitative policies for bandwidth priorities in ad-hoc
networks. INFOCOM Workshops 2008, IEEE, 2008.
[31] Caberera, J.B.D., B. Ravichandran, et al., Statistical traffic modeling for network intrusion
detection. Proceedings of the 8th International Symposium on Modeling, Analysis and
Simulation of Computer and Telecommunication Systems, pp. 466-473, 2000.
[32] Cao, J., W.S. Cleveland, et al., Stochastic Models for Generating Synthetic HTTP Source
Traffic. INFOCOM 2004, 2004.
[33] Chan, E.Y.K., H.W. Chan, et al., IDR: An Intrusion Detection Router for Defending against
Distributed Denial-of-service (DDoS) Attacks. Algorithms and Networks, pp. 581 - 586, 2004.
[34] CHROOT.ORG, The Wargame 駭客訓練基地 - 決戰台灣版，台北市：旗標出版社，2008。
[35] Configuration Guide for the Cisco Secure PIX Firewall Version 5.2. Cisco System,Inc.
[36] Ghosh, A.K. and A. Sehwartzbard, A Study in Using Neural Network for Anomaly and Misuse
Detection. USENIX Security Symposium. vol.8, pp. 12-12, 1999.
[37] Gregg, D.M., W.J. Blackert, et al., Assessing And Quantifying Denial of Service Attacks.
Military Communications Conference, 2001. MILCOM 2001. Communications for
Network-Centric Operations: Creating the Information Force. IEEE. vol.1, pp. 76- 80, 2001.
[38] Hari, A., S. Suri, and G. Parulkar, Detecting and Resolving Packet Filter Conflicts. INFOCOM
2000. Nineteenth Annual Joint Conference of the IEEE Computer and Communications Societ.
vol.3, pp. 1203-1212, 2000.
[39] Hazelhurst, S., A. Attar, and R. Sinnappan, Algorithms for Improving the Dependability of
Firewall and Filter Rule Lists. Dependable Systems and Networks, pp. 576 - 585, 2000.
[40] Hunter, J. S., The  Exponentially  Weighted  Moving  Average, Journal of Quality
Technology, Vol. 18, 1986.
[41] Iguchi, M. and S. Goto, Network Surveillance for Detecting Intrusions. 1999 IEEE. This paper
appears in: Internet Workshop, pp. 99-106, 1999.
[42] Javitz, H.S. and A. Valdes, The NIDES Statistical Component： Description and Justification.
Technical Report SRI International., California, 1994.
[43] Jonsson, E. and T. Olovsson, A Quantitative Model of the Security Intrusion Process Based on
Attacker Behavior. Software Engineering, IEEE Transactions. vol.23, 4, pp. 235 - 245, 1997.
[44] Lau, F., S.H. Rubin, et al., Distributed Denial of Service Attacks. 2000 IEEE International
Conference, 2000.
[45] Ledoux, C., An urban traffic flow model integrating neural networks. Transportation Research
Part C. vol.5, pp. 287-300, 1997.
國科會補助計畫衍生研發成果推廣資料表
日期:2011/10/23
國科會補助計畫
計畫名稱: 基於管制圖概念之網路流量安全系統設計
計畫主持人: 吳繼澄
計畫編號: 99-2221-E-020-012- 學門領域: 資訊系統
無研發成果推廣資料
其他成果 
(無法以量化表達之成
果如辦理學術活動、獲
得獎項、重要國際合
作、研究成果國際影響
力及其他協助產業技
術發展之具體效益事
項等，請以文字敘述填
列。) 
無 
 成果項目 量化 名稱或內容性質簡述 
測驗工具(含質性與量性) 0  
課程/模組 0  
電腦及網路系統或工具 0  
教材 0  
舉辦之活動/競賽 0  
研討會/工作坊 0  
電子報、網站 0  
科 
教 
處 
計 
畫 
加 
填 
項 
目 計畫成果推廣之參與（閱聽）人數 0  
 
