 I 
目錄 
目錄 ………………………………………………………………. I 
報告內容 …………………………………………………………. 1 
一、 前言 ………………………………………………… 1 
二、 研究目的 …………………………………………… 1 
三、 文獻探討 …………………………………………… 3 
四、 研究方法 …………………………………………… 7 
五、 結果與討論 ………………………………………… 8 
  
參考文獻 ………………………………………………………… 9 
計畫成果自評 …………………………………………………… 13 
出席國際學術會議心得報告 …………………………………… 14 
附錄 ……………………………………………………………… 16 
 Lan-Rong Dung and Yin-Yi Wu, 2010, November, "A Wireless Narrow-Band 
Imaging Chip for Capsule Endoscope," Accepted by IEEE Transactions on 
Biomedical Circuits and Systems 
 Lan-Rong Dung, Yin-Yi Wu, Zen-Han Chang, and Hung-Cheng Wan, 
2009, August, “A Hybrid Iterative Demosaicking Method Using the 
Inter-plane Frequency Correlation for Bayer CFA,” VLSI/CAD 2009 
 Lan-Rong Dung, Yin-Yi Wu, and Ping-Kuo Weng, 2009, December, 
“A Wireless Narrow-Band Imaging Chip for Capsule Endoscope,” 
BioCAS 2009 
 Lan-Rong Dung and Jieh-Hwang Yen, 2010, August, “ILP-Based 
Algorithm for Lithium-Ion Battery Charging Profile,” ISIE 2010 
 
 2 
希望透過國科會計畫的執行進行前瞻的腸胃道內視鏡晶片研究與設計。經由前
瞻的電路與硬體設計技術實現在生醫應用電路系統領域貢獻出更具競爭力的研
究成果。 
 就目前存在的腸胃道內視鏡系統而言，還有很多的發展空間。其中有下列三
點有待改進： 
機械式的取像控制系統、人工拿捏窄波段影像擷取時機、有線的腸胃鏡臨床手
術。首先，目前的系統仰賴精密機械來控制濾光片以切換可見光與窄波段影像。
精密機械的控制往往因時間差與腸胃道的蠕動造成臨床醫師使用上的不便與取
像的不易。實務上，臨床醫師通常需分開擷取全可見光影像與窄波段影像。如
此一來，內視鏡需要較長時間的操作與反覆的抽動。這樣對病患會造成很大的
不適感，視內視鏡手術為畏途。其次，因為不允許冗長的手術時間，全程的窄
波段影像擷取是不允許的。如何拿捏窄波段影像切換時機，必須仰賴臨床醫師
的經驗累積。這樣使得內視鏡手術的醫師養成不易，病患仍需承擔錯失早期發
現早期治療的風險。最後，有線主動式內視鏡技術雖然可以有效並即時地診斷
或檢查腸胃道疾病，但是往往會因為醫生要調整內視角度及線的方向帶給患者
高度不適與痛苦。目前的無線膠囊內視鏡限於電力的續航力並無 NBI 取像機
制，病患並無法充分獲得膠囊內視鏡的好處。為求可靠的病灶診斷，有線檢驗
仍不可避免。 
 基於以上改進方向，本計畫的目標有三： 
1. 設計雙光譜影像擷取的電路：利用晶片實現電子式的影像合成與強化方式
取代傳統精密機械的控制方式。將全可見光影像與窄波段影像結合同時擷
取、各自成像。這樣將可使臨床醫師同時對照兩種影像資訊降低診斷的錯
誤率。兩種影像可視需求重疊或分開。 
2. 開發早期腸胃道癌症腺窩圖樣辨識演算法：藉由腺窩圖樣辨識分類癌症發
展程度，將可以自動化窄波段影像擷取時機，減少臨床經驗對診斷的影響，
 4 
圖一：圖左為兩塊豬肉的 WLI，圖右為各自的 IRI。 
 AFI是利用活體組織的蛋白質發出螢光反應的特性顯影早期胃癌病灶。增厚
的腫塊或是黏膜下微血管增生都會造成螢光反應的減弱。而兩者正是早期胃癌的
可能徵兆。為了顯現出兩種螢光減弱的影像，激光波長頻寬為 390-470nm，反射
螢光的中央波長訂在 550nm。圖二展示波長頻譜分佈。圖三為 WLI 與 AFI的臨床
影像對照。 
 
圖二:AFI成像之激光波長與反射螢光之頻譜分佈 
（資料來源:Xillix Technologies Corp., Richmond, BC, Canada） 
    
圖三:WLI與 AFI成像之比照 （圖左為 WLI;圖右為 AFI） 
（資料來源: Photos courtesy of Dr. Noriya Uedo） 
 以上 IRI與 AFI成像技術分別適用於病灶的手術深度判斷與病灶的簡易定
位。而幫助臨床醫師做出更可靠的診斷則有賴於 NBI的成像。NBI的成像原理是
基於特定的短波長光線被血紅素吸收後會造成反射光線的減弱。光線的減弱將促
 6 
 NBI影像採取兩種窄波長光線是用來顯影不同深淺的微血管影像。415nm波
長的光線因為可以充分被淺層微血管吸收，而使表層不當增生的微血管成像。
540nm波長的光線則因為多重散射效應可達到 415nm波長光線無法達到的深層微
血管，使得深層微血管可成像。但是，540nm波長光線卻因血紅素吸收率較 415nm
波長光線差，而無法使淺層微血管呈現出高對比影像。所以，NBI系統需同時具
備兩種窄波長光線來成像。圖六所示為兩種光線成像之比對。NBI的影像對早期
癌症的診斷非常有幫助。例如用來診斷結腸癌的異常腺窩組織(Aberrant Crypt 
Foci, ACF)等。圖七展示用來判斷早期癌症的三種不同腺窩發展程度圖樣。透過
NBI影像可以幫助醫師提高早期癌症的診斷。基於 NBI在臨床診斷上的關鍵角
色，本計畫將著眼于 NBI影像技術的發展。 
 
圖五: 兩種 NBI光線成像結果（圖左為 WLI影像;圖右棕色為 415nm光線成像, 靛
色為 540nm光線成像。） 
（資料來源: Dr. Sano, Sano Hospital, Japan） 
 8 
（Morphological image processing）技術，根據醫學文獻之分類規格
將臺北醫學大學提供之腸胃道臨床影像進行問題 NBI腺窩影像識別。 
（2） 有線腸胃道窄波段影像處理晶片實現： 
在不考慮功耗的情況下，設計主要影像處理電路。分別是解馬賽克處理
電路、血管密度計量電路、雙光譜影像重建電路。解馬賽克處理電路將
採遞迴式處理，因此將包括色差運算及累計更新、遞迴終止判斷電路、
統計濾波器電路。各運算單元將可由軟硬體彈性參數控制。血管密度計
量電路將運用邊緣偵測與型態影像處理技術，所以將包括影像強化電
路、梯度濾波電路、型態影像電路。血管密度計量電路的輸出將交由軟
體做早期癌症分類處理。最後，我們將實現ＷＬＩ與ＮＢＩ影像重疊合
成電路，以臨床醫師實務操作需求為主調配出適當的影像成像輸出。 
（3） 無線腸胃道窄波段影像處理晶片實現： 
最後一階段則進行電路的功率最佳化，以無線膠囊內視鏡為目標。我們
將根據功耗預算配置各單元電路功耗使用，同時考量功率隨手術狀況適
應性調整機制，設計以節省電池消耗為目標的功率意識電路。在此階段
更著重於無線內視鏡系統整合、軟硬體程式設計與模擬。最後的研究成
果將導入過去的研究成品，嵌入目前的膠囊內視鏡進行動物實驗。 
 
五、 結果與討論 
本年度之研究成果已發表一篇期刊論文與三篇國際會議論文，表列如下： 
[1] Lan-Rong Dung and Yin-Yi Wu, 2010, November, "A Wireless Narrow-Band 
Imaging Chip for Capsule Endoscope," Accepted by IEEE Transactions on 
Biomedical Circuits and Systems 
[2] Lan-Rong Dung, Yin-Yi Wu, Zen-Han Chang, and Hung-Cheng Wan, 
2009, August, “A Hybrid Iterative Demosaicking Method Using the 
Inter-plane Frequency Correlation for Bayer CFA,” VLSI/CAD 2009 
[3] Lan-Rong Dung, Yin-Yi Wu, and Ping-Kuo Weng, 2009, December, 
“A Wireless Narrow-Band Imaging Chip for Capsule Endoscope,” 
BioCAS 2009 
[4] Lan-Rong Dung and Jieh-Hwang Yen, 2010, August, “ILP-Based 
 10 
digital cameras,” Proc SPIE, vol. 3028, pp. 117-125, Feb. 1997 
[14] X. Li and M. T. Orchard, “New edge-directed interpolation,” IEEE Trans. Image 
Processing, vol. 10, no. 10, pp. 1521-1527, Oct. 2001 
[15] B. K. Gunturk, Y. Altunbasak, and R. M. Mersereau, “Color plane interpolation 
using alternating projections,” IEEE Trans. Image Processing, vol. 11, no. 9, pp. 
997-1013, Sep. 2002. 
[16] H. A. Chang and H. H. Chen, “Stochastic color interpolation for digital cameras,” 
IEEE Trans. Circuit and systems for video technology, vol. 17, no. 8, pp. 964-973, 
Aug. 2007. 
[17] H. J. Trussell and R. E. Hartwig, “Mathematics for demosaicking,” IEEE Trans. 
Image Processing, vol. 3, no. 4, pp. 485-492, Apr. 2002. 
[18] L. Zhang and X. Wu, “Color demosaicking via directional linear minimum mean 
square-error estimation,” IEEE Trans. Image Processing, vol. 14, no. 12, pp. 
2167-2178, Dec. 2005 
[19] D. D. Muresan and T. W. Parks, “Adaptively quadratic (AQua) image 
interpolation,” IEEE Trans. Image Processing, vol. 13, no. 5, pp. 690-698, May 
2004. 
[20] X. Li, “Demosaicing by successive approximation,” IEEE Trans. Image 
Processing, vol. 14, no. 3, pp. 370-379, Mar. 2005. 
[21] X. Wu and L. Zhang, “Temporal color video demosaicking via motion estimation 
and data fusion,” IEEE Trans. Circuit Syst Video Technl, vol. 16, no. 2, pp. 
231-240, Feb. 2006. 
[22] K. Hirakawa and T. W. Parks, “Adaptive homogeneity-directed demosaicking 
algorithm,” IEEE Trans. Image Processing, vol. 14, no. 3, pp. 360-369, Mar. 
2005. 
[23] D. Alleysson, S. Süsstrunk and J. Hérault, “Linear demosaicing inspired by the 
human visual system,” IEEE Trans. Image Processing, vol. 14, no. 4, pp. 
439-449, Apr. 2005. 
[24] “Recommendations of uniform color space, color difference equations, 
psychrometric color terms,” CIE, Supplement no. 2 to CIE publication no. 
15(E.-1 31) 1971/(TC-1.3), 1978. 
[25] M. Mahy, E. Van, and O. A., “Evaluation of uniform color spaces developed after 
the adoption of CIELAB and CIELUV,” Color Res. Application, vol. 19, no. 2, 
pp. 105-121, 1994. 
[26] [Online] Available: http://www.cs.technion.ac.il/~ron/Demosaic/  
[27] K. Gono, “Multifunctional endoscopic imaging system for support of early 
cancer diagnosis,” IEEE Journal of Selected Topics in Quantum Electronics, vol. 
14, no. 1, pp. 62-69, Jan.-Feb. 2008. 
 12 
10
th
 Color Imaging Conf. Proceedings, pp. 349-355, Scottsdale, AZ, USA, 2002. 
[45] [Online] Available: http://www.brucelindbloom.com/index.html?ColorCheckerC 
alculator.html 
[46] R. B. Merrill, “Color separation in an active pixel cell imaging array using a 
triple-well structure,” U.S. Patent 5 965 875, Oct. 1999. 
 
 14 
 
 
國科會補助專題研究計畫項下出席國際學術會議心得報告 
                                     日期：98年 12 月 1 日 
                                 
一、參加會議經過 
1. 十一月二十五日抵達中國北京。  
2. 十一月二十六日上午抵達會場註冊報到  
3. 十一月二十六日至十一月二十八日選擇性全天出席研究相關之會議 Sections 及
參與討論。  
4. 十一月二十八日下午發表論文” A Wireless Narrow-Band Imaging Chip for Capsule 
Endoscope”。  
5. 十一月二十九日上午至機場搭機前往台北。 
二、與會心得 
計畫編號 NSC 98－2221－E－009－138－ 
計畫名稱 腸胃道黏膜微血管透視內視鏡影像處理晶片設計之研究(I) 
出國人員
姓名 
董蘭榮 
服務機構
及職稱 
交通大學 副教授 
會議時間 
98 年 11 月 26 日
至 98 年 11 月 28
日 
會議地點 
中國北京 
會議名稱 
(中文)2009 年國際電子電機工程學會生醫電路與系統研討會 
(英文) 2009 IEEE Biomedical Circuits and Systems Conference 
(BioCAS 2009) 
發表論文
題目 
(中文)無線膠囊內視鏡之窄波段影像處理晶片 
(英文) A Wireless Narrow-Band Imaging Chip for Capsule Endoscope 
 16 
 
 
附錄 
 
 Lan-Rong Dung and Yin-Yi Wu, 2010, November, "A Wireless Narrow-Band 
Imaging Chip for Capsule Endoscope," Accepted by IEEE Transactions on 
Biomedical Circuits and Systems 
 Lan-Rong Dung, Yin-Yi Wu, Zen-Han Chang, and Hung-Cheng Wan, 
2009, August, “A Hybrid Iterative Demosaicking Method Using the 
Inter-plane Frequency Correlation for Bayer CFA,” VLSI/CAD 2009 
 Lan-Rong Dung, Yin-Yi Wu, and Ping-Kuo Weng, 2009, December, 
“A Wireless Narrow-Band Imaging Chip for Capsule Endoscope,” 
BioCAS 2009 
 Lan-Rong Dung and Jieh-Hwang Yen, 2010, August, “ILP-Based 
Algorithm for Lithium-Ion Battery Charging Profile,” ISIE 2010 
 
 
IEEE TRANSACTIONS ON BIOMEDICAL CIRCUITS AND SYSTEMS, VOL. , NO. , 2
B image G image R image
415nm 540nm 600nm
Fig. 1. Principle of NBI (from Olympus Corporation, Japan)
fps. The sensor consumes only 2 mA at 3V power supply.
Implementation results shows the NBI capsule endoscope can
work about 6∼8 hour at 2 fps with two button batteries.
The organization of this paper is as fellows. The Section II
introduces the narrow band image and the proposed architec-
ture. The Section III describes the design of NBI image sensor.
The Section IV shows the implementation and experimental
results. Finally, the Section V concludes the work of wireless
NBI capsule endoscope device.
II. NARROW BAND IMAGE AND SYSTEM ARCHITECTURE
According to basic physical principles, the penetra-
tion depth of light is dependent on its wavelength. The
longer the wavelength, the deeper the penetration depth
it can pierce as depicted in Fig. 1. Based on this, the
company Olympus lunched the first endoscope system ”EVIS
LUCERA SPECTRUM” that offers narrow band imaging [14].
As illustrated in Fig. 2, the system has a xenon lamp and a
rotation disk with three NBI filters, instead of RGB optical
filters, to allow only three wavelengths to pass through and
generate narrow-band images. The spectra of the three NBI
filters are 415±30nm, 445±30nm, and 500±30nm. A charged-
coupled device (CCD) is then used to capture images of
these three bands. After that, the NBI image is combined
by video processor using the three-band images. The choose
of NBI spectra is based on the light absorption property
of hemoglobin. Thus, the microvasculature of the mucosal
surface can be seen clearly as dark traces. The longer the
wavelength, the deeper the penetration depth. The narrower
the light bandwidth, the clearer the developed NBI can be.
For the capsule endoscope application, however, to put
a xenon lamp and a rotation disk with three NBI filters
into a capsule is hardly possible. Hence, we replaced the
xenon lamp and NBI filters with LEDs and color filter
array to acquire narrow band image. The proposed wireless
NBI capsule endoscope system is composed of a capsule, a
portable data recorder, a real-time monitor, an computer with
image viewer, and a DICOM Gateway, as shown in Fig. 3. The
portable data recorder receives image stream from RF receiver
and saves raw data into flash memory. When recording, the
real-time monitor can display the image of digestive tract for
routine examination. After inspection, the received image raw
Monochromic CCD 
Tissue 
NBI filter 
Xenon Lamp 
Fig. 2. Configuration of Olympus NBI endoscope system
Capsule
Endoscope
Data
Recorder
Real-Time
Monitor
Image
Viewer
DICOM
Gateway
Target
Keyboard
Keyboard
Keyboard
Mouse
LCD
Monitor
Mouse
Mouse
LCD
Monitor
LCD
Monitor
Ethernet
Contral
Message
Contral
Message
Contral
Message
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
Processing image
/ Information
Processing image
/ Information
Processing image
/ Information
Non-DICOM
Image
DICOM
Image
Light
Signal
RF
Signal
RF
Signal
Raw
Image
Fig. 3. The system description of wireless NBI capsule endoscope.
data can be uploaded to computer through a USB port. The
white-light image(WLI) and narrow-band image(NBI) image
are then combined and shown by video player software. The
DICOM gateway provides a standard for handling, storing,
printing, and transmitting information in medical imaging.
Inside the wireless NBI capsule, a narrow-band LED light
source, a 512-by-512 dual-mode CMOS image sensor, and a
RF transmitter are adopted as illustrated in Fig. 4. Two oxide
batteries and an antenna are also installed for power and RF
transmitter. The narrow band-LED light source comprises six
LEDs : three white LEDs for WLI and three 430nm(center
wavelength) blue LEDs for narrow NBI. The wireless RF
transmitter uses FSK modulation with 8 Mbps transmission
rate for image data transmitting which operates in the indus-
trial, scientific and medical (ISM) radio band, 416MHz.
III. DESIGN OF NARROW BAND CMOS IMAGE SENSOR
The acquisition of narrow-band image and reduction of
power dissipation are the main challenge of NBI capsule
endoscope. Fig. 5 shows the block diagram of the CMOS
sensor. Each pixel contains three transistors and a photo diode.
The charge pumping circuit produces high voltage for pixel
resetting to increase output signal swing. The correlated double
sampling circuit is used for low-power noise canceling at the
IEEE TRANSACTIONS ON BIOMEDICAL CIRCUITS AND SYSTEMS, VOL. , NO. , 4
Inter-illumination Mode                                                 White 
Intra-illumination Mode
white B1 G1
R1 Y
B2
N2
Narrow-BW NBI
Broad-BW NBI
G1 B2 N2  => NBI 
1 1 1 => WLI 
blue
G B Rframe n+1 
frame n
white
blue
B1 G1
R1 N1frame n 
G1 B1 N1 => NBI 
G1 N1 R1 => WLI 
WLIdemosaic
light
NB
light
Color 
NBI
combine
NBIdemosaic
WLI
White demosaic
light
NB
light
Color 
NBI
combine
NBI
Fig. 8. Sensor illumination modes
B. Pixel and Correlated Double Sampling Circuit
As shown in Fig. 9, each pixel consists of three transistors
and a photo diode. The transistor M1 is used to reset the
pixel, the transistor M2 acts as a source follower, and the
transistor M3 is a row-select transistor with an optical
fill factor of 47%. In order to increase the output voltage
swing under low power supply, a higher voltage pulse driven
by charge pumping circuit is used to reset the photo diode.
Because the responsivity of pixels varies with the variation
in manufacturing, the CMOS sensor will have spatial noise,
called Fixed Pattern Noise(FPN). The correlated double
sampling circuit in each column can efficiently diminish the
column fixed pattern noise , caused by Vt variation of the
source follower transistor, by two sample-hold capacitor C1
and C2. Fig. 9 also shows the timing diagram of pixel reset
and CDS. When the pass transistor M3 and M4 are ON, C1
and C2 are both charged to V1. As the pass transistor M5
is OFF and M1 is ON, C2 is charged to Vreset. When M3
and M4 are OFF, the output voltage will rise to (Vreset -V1).
Because each pixel at the same column passes through
identical CDS circuit and the output sensing voltage is
double sampled, the FPN caused in column direction will
be removed. The transistor M2 acts as a source follower.
C. A-to-D converter
Fig. 10 shows the equivalent block diagram of the 8-bit
flash A/D converter (ADC) used in the CMOS sensor. It
is composed of 127 comparators, a resistor network, and a
encoder. The resistor network methodizes the input between
two neighboring comparators equal to one LSB. In actual
circuits, the 8-bit ADC was build by cascading sixteen 4-bit
ADCs. The encoder converts thermal-code that is the output
of 127 comparators to binary code. Inside the comparator, the
L/W ratio of transistors should also be as large as possible
to avoid miss-matching problem of comparators under low
SH
CL
reset
Row_sel
R
D1
M1
M2
M3
C2
M4
C1
M5
V1
reset
Row_sel
SH
output
CL
VSS
VDD
Fig. 9. Timing diagram of pixel reset and CDS operations
reference voltage VR. Although the flash ADC is suitable for
high speed video application, the circuit consumes consider-
able power and suffers from babbling and metastable effects.
To overcome these drawbacks, it is necessary to decrease the
power consumption of comparators. Inside the comparator,
the power dissipation will be dramatically reduced by increas-
ing the active load of differential pairs at the expense of the
throughput rate of ADC. In the proposed NBI wireless capsule
endoscope, the CMOS sensor works at 2 fps. The requirement
of ADC throughput rate is as low as 1MHz. Thus, the expense
of throughput rate is affordable in our work.
D. Auto Expose Control Digital Circuit
The white and blue LEDs in the proposed NBI wireless
capsule endoscope behave as strobe light source for WLI and
NBI images capturing. During the routine capsule endoscope
examination, the appearances of gastrointestinal tract may be
changed dramatically. To acquire high-contrast images and
decrease power consumption of LEDs, an auto expose control
ASIC is implemented by adjusting the strobe pulse width of
IEEE TRANSACTIONS ON BIOMEDICAL CIRCUITS AND SYSTEMS, VOL. , NO. , 6
P
ix
el a
rra
y
 5
1
2
x
1
5
2
 
A
D
C
D
ig
ita
l co
re
Vertical Shift Register
Vertical Shift Register
C
o
lu
m
n
 C
D
S
 a
n
d
 H
o
rizo
n
ta
l S
h
ift
R
eg
ister
Fig. 12. Chip photomicrograph.
              (a)                               (b)                               (c) 
              (d)                               (e)                               (f) 
G B N 
WLI Color NBI 1 Color NBI 2
Fig. 13. (a)The demosaicked images of green pixel, (b)the demosaicked
images of blue pixel, (c)the demosaicked images of clear pixels, (d)the
WLI image, (e)the first-type color NBI, and (f)the second-type color NBI
of backside mucosa of human tongue.
WLI
WLI
Color NBI 1 
Color NBI 1 
Fig. 14. WLI and combined color NBI of live pig’s duodenum in inter-
illumination mode.
WLI Color NBI 
Fig. 15. WLI and combined color NBI images of backside mucosa of human
tongue in intra-illumination mode
Fig. 17. The NBI Capsule Endoscope (Top Left: NBI Capsule Endoscope;
Top Right: LED module; Bottom Left: Receiver and Data Recorder; Bottom
Right: Image Viewer )
B. NBI Capsule Endoscope Prototype
A wireless NBI capsule endoscope system that has been
described in section II is developed. Due to limited print circuit
board area, the sensor and RFIC are bound to PCB by chip on
board (COB) technology. Other on-board components such as
resistors and capacitors are used with SMD package. As shown
in Fig. 17, the narrow band LED module, wide FOV lens, dual
mode NBI CMOS sensor, batteries, RF transmitter, magnetic
switch and antenna are all capsuled into a pill. The RF receiver
dissipates less than 0.5A@5V while the sensitivity is lower
than -80 dBm. The data recorder can store more than 4 GB
and meantime the image viewer displays the received images
through USB port. The average current of the capsule is nearly
7∼8 mA when the RF transmitter works at 8Mbps and the
sensor works at 2fps. With two 1.5V 80mAh silver oxide
button batteries, experiments show that the capsule continuous
working for 6∼8 hours.
C. Experiment on Animal
As shown in Fig. 18, to demonstrate the proposed wireless
NBI capsule endoscope, we deposit the capsule into a pig’s
duodenum directly by a surgical operation since the digestive
time of pig is nearly 2 weeks. The CMOS sensor is setting to
inter-illumination mode. Fig. 16 provides the images of pig’s
small bowel in the experiment. As we can see in Fig. 16, the
pile of small bowel in the WLI images is revealed clearly, but
the gray narrow band images (N images, composed of clear
IEEE TRANSACTIONS ON BIOMEDICAL CIRCUITS AND SYSTEMS, VOL. , NO. , 8
[16] Bahadir K. Gunturk, John Glotzbach, Yucel Altunbasak, Ronald W.
Schafer, and Russel M. Mersereau, “Demosaicking: Color filter array
interpolation,” IEEE SIGNAL PROCESSING MAGAZINE, JANUARY
2005.
Lan-Rong Dung (SM’93-M’97) received a BSEE
and the Best Student Award from Feng Chia Univer-
sity, Taiwan, in 1988, an MS in electronics engineer-
ing from National Chiao Tung University, Taiwan, in
1990, and Ph.D. in electrical and computer engineer-
ing from Georgia Institute of Technology, in 1997.
From 1997 to 1999 he was with Rockwell Science
Center, Thousand Oaks, CA, as a Member of the
Technical Staff. He joined the faculty of National
Chiao Tung University, Taiwan in 1999 where he is
currently an associate professor in the Department
of Electrical and Control Engineering. He received the VHDL International
Outstanding Dissertation Award celebrating in Washington DC in October,
1997. His current research interests include VLSI design, digital signal
processing, hardware-software codesign, and System-on-Chip architecture. He
is a member of Circuits and Systems and Signal Processing societies of the
IEEE.
Yin-Yi Wu received the M.S. degree in electronic
and information from National Yunlin University of
Science and Technology, Taiwan, in 1999. Afterward
he joined the Materials and Electro-Optics Division,
Chung-Shan Institute of Science and Technology.
He is currently working toward the Ph.D. degree at
the Department of Electrical Engineering National
Chiao Tung University, Taiwan. His current interests
include IC design and image processing.
00 01 02 03 04 05 06 07 08
10 11 12 13 14 15 16 17 18
20 21 22 23 24 25 26 27 28
30 31 32 33 34 35 36 37 38
40 41 42 43 44 45 46 47 48
50 51 52 53 54 55 56 57 58
60 61 62 63 64 65 66 67 68
70 71 72 73 74 75 76 77 78
80 81 82 83 84 85 86 87 88
Fig. 1. One example of Bayer pattern
where
Ĝ43 = G43 +
R44−R42
2 ,
Ĝ45 = G45 +
R44−R46
2
α43 =
1
1+|G34−G322 |+|R44−R42|+|
G54−G52
2 |+|G45−G43|+|G43−G41|
,
α45 =
1
1+|G34−G362 |+|R44−R46|+|
G54−G56
2 |+|G43−G45|+|G45−G47|
G44V =
α34Gˆ34 + α54Gˆ54
α34 + α54
(2)
where
Ĝ34 = G34 +
R44−R24
2 ,
Ĝ54 = G54 +
R44−R64
2
α34 =
1
1+|G43−G232 |+|R44−R24|+|
G45−G25
2 |+|G54−G34|+|G34−G14|
,
α54 =
1
1+|G43−G632 |+|R44−R64|+|
G45−G65
2 |+|G34−G54|+|G54−G74|
Once the G plane is fully reconstructed, it can be used to
help the R and B plane interpolation. Before that, we upgrade
the G plane value in order to give more precise information
for the next interpolation.
Gunturk in [7] has proposed an algorithm which replaces
the detail subbands of G plane with R and B plane to upgrade
the G plane. It assumes that the inter detail subband corre-
lation coefficients calculated by (3) should be larger than 0.9
for R / G plane and B / G plane.
Cx,y =
∑
(i,j)
(x(i, j)− µx)(y(i, j)− µy)√∑
(i,j)
(x(i, j)− µx)2
√∑
(i,j)
(y(i, j)− µy)2
(3)
where (i, j) are the spatial coordinates in integers, x(i, j)
and y(i, j) are two different color plane or subbands and
µx and µy are the means of x(i, j) and y(i, j) respec-
tively.However, some images are failed to satisfy this as-
sumption and the substitution of subbands gets worse result.
Therefore, we need to set a judgment to classify the image
we interpolated. In our experiments, we find the conventional
interpolation method described in [10] and [11] can give
the approximations of inter-channel correlation coefficients
which is calculated by (3). We use it to classify the images
and the algorithm shown below :1) Use the observed samples
of R and downsample it. Note that all pixels of this down-
sampled version are observed data. 2) Use the interpolated
G plane at the corresponding R locations and downsample
it. 3) Decompose the downsampled version from above two
steps into four subbands (LL, LH, HL, HH). 4) Adaptively
choose the image that is suitable for upgrade the G plane. If
the image is fit, replace the detail subbands (LH, HL, HH) of
the G plane with R. If not, maintain the detail subbands. 5)
Reconstructed the downsampled G plane and then insert all
pixels to the place they located initially. 6) Repeat the step
above for the observed samples of B.
Since the G plane is fully populated, the R and B planes
can have the aid of the G plane no matter the observed sam-
ples or the interpolated ones. This step is achieved as follow:
interpolate the missing B values at observed R by using (4)
and vice versa, and then fill the rest of the missing R and B
values at observed G by using (5). There are estimated similar
to the G plane interpolation.
B˜44 =
α33B̂33 + α35B̂35 + α53B̂53 + α55B̂55
α33 + α35 + α53 + α55
(4)
where
α33 =
1
1+|G43−G322 |+|
G34−G23
2 |+|G44−G33|+|G33−G22|
α35 =
1
1+|G45−G362 |+|
G34−G25
2 |+|G44−G35|+|G35−G26|
α53 =
1
1+|G43−G522 |+|
G54−G63
2 |+|G44−G53|+|G53−G62|
α55 =
1
1+|G45−G562 |+|
G54−G65
2 |+|G44−G55|+|G55−G66|
R˜43 =
α33R̂33 + α42R̂42 + α44R̂44 + α53R̂53
α33 + α42 + α44 + α53
(5)
where
R̂33 = R33 + (G43 −G33), R̂42 = R42 + (G43 −G42),
R̂44 = R44 + (G43 −G44), R̂53 = R53 + (G43 −G53)
and
1
α33
= 1 +
∣∣G42−G32
2
∣∣+ ∣∣G32−G222 ∣∣+ ∣∣G44−G342 ∣∣+∣∣G34−G24
2
∣∣+ |G43 −G33|+ |G33 −G23|
1
α42
= 1 +
∣∣G33−G32
2
∣∣+ ∣∣G32−G312 ∣∣+ ∣∣G53−G522 ∣∣+∣∣G52−G51
2
∣∣+ |G43 −G42|+ |G42 −G41|
1
α44
= 1 +
∣∣G33−G34
2
∣∣+ ∣∣G34−G352 ∣∣+ ∣∣G53−G542 ∣∣+∣∣G54−G55
2
∣∣+ |G43 −G44|+ |G44 −G45|
1
α53
= 1 +
∣∣G42−G52
2
∣∣+ ∣∣G52−G622 ∣∣+ ∣∣G44−G542 ∣∣+∣∣G54−G64
2
∣∣+ |G43 −G53|+ |G53 −G63|
After the image sampled from CFA has been fully re-
constructed by applying all the interpolation steps described
above.As we will see next, the second stage can achieve sig-
nificant improvement by suppress the visible artifacts and re-
veals better performance on the measurement.
Table 1. CIELAB Color Difference Comparison of Different
Demosaicking Method.
No. Bilinear Method[7] Method[4] Method[14] Method[9] Method[8] Proposed
1 4.2846 1.4103 1.5438 1.5101 1.2475 1.2724 1.1188
2 2.0355 1.2207 1.1749 1.2637 0.9136 1.1096 1.0190
3 1.4323 0.8784 0.8791 0.7906 0.6054 0.7994 0.6610
4 1.9231 1.0482 1.0848 1.0179 0.9127 1.0138 0.9095
5 4.7072 1.9133 1.8027 1.9409 1.6661 1.9795 1.5489
6 2.9889 1.1171 1.2016 1.1533 0.8520 1.0258 0.8175
7 1.6837 0.9704 0.9344 0.9729 0.7751 0.8915 0.8062
8 5.2150 1.7296 1.7877 2.0732 1.4885 1.5906 1.3929
9 1.7740 0.8962 0.9209 0.8703 0.6992 0.8019 0.7262
10 1.7708 0.8738 0.9291 0.8504 0.7335 0.8070 0.7569
11 3.0311 1.2593 1.3561 1.3036 1.0395 1.1592 1.0031
12 1.4015 0.6884 0.7514 0.6893 0.5150 0.5907 0.5859
13 5.3043 1.9558 2.1473 1.7842 1.9213 1.8011 1.5853
14 3.3424 1.7545 1.4995 1.6623 1.2910 1.7535 1.2132
15 2.2616 1.2779 1.3258 1.2829 1.0737 1.2322 1.0824
16 2.6079 1.0608 1.1544 1.0790 0.7464 0.9660 0.7415
17 2.6012 1.3741 1.4479 1.2820 1.1383 1.2588 1.1336
18 3.7096 1.8634 1.8631 1.8436 1.8606 1.9673 1.6561
19 2.7994 1.1349 1.2013 1.1689 1.0126 1.0721 0.9319
20 1.9289 1.0323 1.0318 0.9411 0.8642 0.9821 0.8348
21 2.9844 1.2066 1.3068 1.2248 1.0943 1.0995 0.9965
22 2.2649 1.2774 1.2020 1.2122 1.1743 1.2075 1.0938
23 1.2018 0.8547 0.8531 0.8249 0.7071 0.8218 0.6912
24 2.9500 1.3158 1.2532 1.2681 1.2489 1.2458 1.1554
Table 2. Structural Similarity Comparison of Different De-
mosaicking Method.
No. Bilinear Method[7] Method[4] Method[14] Method[9] Method[8] Proposed
1 0.8081 0.9856 0.9822 0.9814 0.9730 0.9869 0.9891
2 0.8981 0.9679 0.9771 0.9509 0.9671 0.9718 0.9766
3 0.9325 0.9850 0.9869 0.9827 0.9844 0.9849 0.9890
4 0.9138 0.9783 0.9815 0.9745 0.9729 0.9785 0.9825
5 0.8782 0.9861 0.9883 0.9816 0.9811 0.9827 0.9884
6 0.8473 0.9851 0.9826 0.9822 0.9815 0.9850 0.9892
7 0.9533 0.9877 0.9903 0.9842 0.9859 0.9874 0.9890
8 0.8259 0.9846 0.9823 0.9790 0.9756 0.9855 0.9873
9 0.9208 0.9842 0.9834 0.9821 0.9777 0.9836 0.9842
10 0.9199 0.9852 0.9852 0.9836 0.9798 0.9852 0.9859
11 0.8694 0.9845 0.9839 0.9803 0.9799 0.9843 0.9879
12 0.9075 0.9852 0.9850 0.9825 0.9819 0.9851 0.9874
13 0.7728 0.9817 0.9750 0.9830 0.9597 0.9839 0.9858
14 0.8715 0.9791 0.9822 0.9724 0.9758 0.9753 0.9846
15 0.9144 0.9746 0.9762 0.9725 0.9683 0.9747 0.9780
16 0.8775 0.9876 0.9848 0.9844 0.9846 0.9869 0.9909
17 0.9254 0.9880 0.9870 0.9875 0.9819 0.9875 0.9887
18 0.8709 0.9797 0.9788 0.9777 0.9668 0.9783 0.9796
19 0.8753 0.9842 0.9821 0.9818 0.9744 0.9833 0.9862
20 0.9180 0.9713 0.9757 0.9751 0.9691 0.9759 0.9766
21 0.8886 0.9810 0.9805 0.9797 0.9731 0.9814 0.9823
22 0.8847 0.9716 0.9742 0.9719 0.9637 0.9739 0.9746
23 0.9561 0.9818 0.9854 0.9769 0.9793 0.9818 0.9846
24 0.8757 0.9829 0.9837 0.9822 0.9760 0.9838 0.9841
post-processing can provide satisfactory results in suppress-
ing those artifacts. Furthermore, to avoid the artifacts that is
caused by too much iteration, we judge the image whether
it is suitable to execute post-processing or not and set a stop
criterion . Experiment results show that the proposed scheme
provide better performance on quantitative measurements and
human perception.
5. REFERENCES
[1] B. K. Gunturk, J. Glotzbach, Y. Altunbasak, R. W.
Schafer, and R. M. Mersereas, “Demosaicking: color
filter array interpolation,” IEEE Signal Process, vol. 22,
no. 1, pp. 44–54, January 2005.
[2] C. Laroche and M. Prescott, “Apparatus and method
for adaptively interpolation a full color image utilizing
chrominance gradients,” U.S. Patent 5 373 322, Dec.
1994.
[3] J. Hamilton and J. Adams, “Adaptive color plane inter-
polation in single sensor color electronic camera,” U.S.
Patent 5 629 734, May 1997.
[4] W. Lu and Y. P. Tan, “Color filter array demosaicking:
new method and performance measures,” IEEE Trans.
Image Processing, vol. 12, no. 10, pp. 1194–1210, Oct.
2003.
[5] R. Kimmel, “Demosaicing: image reconstruction from
color ccd samples,” IEEE Trans. Image Processing, vol.
7, no. 3, pp. 1221–1228, Sep. 1999.
[6] D. Cok, “Signal processing method and apparatus for
producing interpolated chrominance values in a sampled
color image signal,” U.S. Patent 4 642 678, Feb. 1987.
[7] B. K. Gunturk, Y. Altunbasak, and R. M. Mersereau,
“Color plane interpolation using alternating projec-
tions,” IEEE Trans. Image Processing, vol. 11, no. 9,
pp. 997–1013, Sep. 2002.
[8] Xin Li, “Demosaicing by successive approximation,”
IEEE Trans. Image Processing, vol. 14, no. 3, pp. 370–
379, Mar. 2005.
[9] K. Hirakawa and T. W. Parks, “Adaptive homogeneity-
directed demosaicking algorithm,” IEEE Trans. Image
Processing, vol. 14, no. 3, pp. 360–369, Mar. 2005.
[10] T. Kuno, H. Sugiura, and N. Matoba, “New interpo-
lation method using discriminated color correlation for
digital still cameras,” ieee trans. consumer electron,”
IEEE Trans. Consumer Electron, vol. 45, no. 1, pp. 259–
267, Feb. 1999.
[11] T. Usui et al., “Studies on image coding using correla-
tion between lightness and chrominance,” Color forum
JAPAN ’98, vol. 10-3, pp. 133–136, 1998.
[12] “Recommendations of uniform color space, color dif-
ference equations, psychometric color terms,” CIE,
Supplement no. 2 to CIE publication no. 15(E.-1 31)
1971/(TC-1.3), 1978.
[13] M. Mahy, E. Van, and O. A., “Evaluation of uniform
color spaces developed after the adoption of cielab and
cieluv,” Color Res. Application, vol. 19, no. 2, pp. 105–
121, 1994.
[14] D. Alleysson, S. Susstrunk, and J. Herault, “Linear de-
mosaicing inspired by the human visual system,” IEEE
Trans. Image Processing, vol. 14, no. 4, pp. 439–449,
Apr. 2005.
B image G image R image
415nm 540nm 600nm
Fig. 1. NBI principle (Olympus Corporation, Japan)
Monochromic CCD 
Tissue 
NBI filter 
Xenon Lamp 
Fig. 2. Configuration of Olympus SPECTRUM
band images. Because the absorption band of hemoglobin is
415nm [1], the microvasculature of its mucosal surface can
be seen clearly. Another absorption band of hemoglobin is
540nm. The 415nm light can not reach the depth where the
vessels presented on the 500nm because of multiple scattering
effect in tissue. Therefore, in the synthesized image, we can
see vessels on both superficial and deeper tissue.
The proposed wireless NBI capsule endoscope system is
composed of a capsule, a portable data recorder, a real-time
monitor, an computer with image viewer, and a DICOM
Gateway which is given in Fig. 3. The portable data recorder
receives the image raw data via RF receiver and saves in
large volume flash memory. Meanwhile, real-time monitor can
display the image of digestive tract during routine examination.
After inspection, the received image raw data can be uploaded
to computer through a USB port. The white light image(NBI)
and narrow band image(WLI) image are then synthesized and
shown by software on the computer. The DICOM gateway
provides a standard for handling, storing, printing, and trans-
mitting information in medical imaging.
Inside the wireless NBI capsule, a narrow band LED light
source, a 512-by-512 dual-mode CMOS image sensor, and a
RF transmitter are adopted as illustrated in Fig. 4. Two oxide
batteries and an antenna are also installed for power and RF
transmitter. The narrow band LED light source comprises six
LEDs : three white LEDs for WLI and three 430nm blue LEDs
for narrow NBI. The wireless RF transmitter designed by our
RF team furnishes FSK modulation with 8 Mbps for image
data transmitting which operates in 416MHz ISM band.
Capsule
Endoscope
Data
Recorder
Real-Time
Monitor
Image
Viewer
DICOM
Gateway
Target
Keyboard
Keyboard
Keyboard
Mouse
LCD
Monitor
Mouse
Mouse
LCD
Monitor
LCD
Monitor
Ethernet
Contral
Message
Contral
Message
Contral
Message
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
Processing image
/ Information
Processing image
/ Information
Processing image
/ Information
Non-DICOM
Image
DICOM
Image
Light
Signal
RF
Signal
RF
Signal
Raw
Image
Fig. 3. The System description of NBI Capsule Endoscope.
3
2
14567
White Light LED 
Narrow Band LED 
Fig. 4. The structure of NBI Capsule Endoscope (1: Len; 2:LEDs; 3: LEDs;
4: CMOS sensor; 5: Battery; 6: RF transmitter; 7: Antenna)
III. DESIGN OF NARROW BAND CMOS IMAGE SENSOR
The design challenge of NBI capsule endoscope concen-
trates on the narrow band image acquisition and its power
consumption. Fig. 5 shows the block diagram of the CMOS
sensor. Each pixel contains three transistors and a photo diode.
Charge pumping produces higher voltage for pixel resetting
to increase output signal swing. Correlated double sampling
circuit is used for low-power noise canceling at the column.
The sampled charges are transferred to video amplifier by
horizontal shift register. The designed flash ADC generates
a 8-bit digital output with very low power consumption. To
acquire proper image intensity and decrease the power con-
sumption of LEDs, a auto expose control ASIC is integrated.
The PISO/Randomizer links the RFIC and image sensor. The
analog and digital circuits inside the chip are supplied by
bandgap reference and regulators.
Color filter array is one of the most singular hardware
elements in a single monochrome sensor to acquire color
CMOS APS
Imaging Area 
(512x512) 
Column CDS Circuits 
Horizontal Shift Register 
PISO
/Randomizer
Auto Expose Ctrl 
V
e
rt
ic
a
l 
S
h
if
t 
R
e
g
is
te
r 
T
im
in
g
 
G
e
n
.
A/D
Video Amp. 
BandGap
Reference 
Charge
Pumping
To RFIC
Regulator
Fig. 5. Block diagram of CMOS sensor
P
ix
el a
rra
y
 5
1
2
x
1
5
2
 
A
D
C
D
ig
ita
l co
re
Vertical Shift Register
Vertical Shift Register
C
o
lu
m
n
 C
D
S
 a
n
d
 H
o
rizo
n
ta
l S
h
ift
R
eg
ister
Fig. 7. Chip photomicrograph.
the sake of power, effective low power techniques need to
be utilized in the design to guarantee long working time.
With 3V power supply, implementation results show the sensor
consumes only 2mA at 2 frame/s and the entire wireless NBI
capsule that dissipates nearly 7∼8 mA can work for 6∼8
hours consecutively. Experiment results on backside mucosa
of a human tongue and pig’s small intestine demonstrate that
NBI capsule endoscope is a beneficial tools for discriminative
diagnosis by providing contrast-enhanced image of vascular
and white light image.
TABLE I
CHIP SPECIFICATIONS
Technology 0.25µm 1P4M CMOS
Chip Size 3.7mm x 3.95mm
Format 512x512
Pixel size 5.6µmx5.6µm
Fill Factor 47%
ADC resolution 8bit
Frame rate 2Hz
Power Consumption 2mW@3V
ACKNOWLEDGMENT
This work was supported by Chung-Shan Institute of Sci-
ence and Technology, Taiwan. The authors would like to thank
Dr. Shien-Ming Wu for his technical support and funds.
REFERENCES
[1] K. Gono, “Multifunctional endoscopic imaging system for support of
early cancer diagnosis,” IEEE Journal of Selected Topics in Quantum
Electronics, vol. 14, no. 1, pp. 62–69, Jan/Feb. 2008.
[2] K. Gono, T. Obi, M. Yamaguchi, N. Ohyama, H. Machida, Y. Sano,
S. Yoshida, Y. Hamamoto, and T. Endo, “Appearance of enhanced tissue
features in narrowband endoscopic imaging,” J. Biomed. Opt., vol. 9,
pp. 568V577, May/Jun. 2004.
[3] K. Gono, K. Yamazaki, N. Doguchi, T. Nonami, T. Obi, M. Yamagichi,
N. Ohyama, H.Machida, Y. Hamamoto Y. Saono S.Yoshida, and T. Endo,
“Endoscopic observation of tissue by narrowband illumination,” Opt.
Rev., vol. 10, pp. 211V215, 2003.
[4] Manabu Muto, Chikatoshi Katada, Yasushi Sano, and Shiegaki Yoshida,
“Narrow band imaging: A new diagnostic approach to visualize an-
giogenesis in superficial neoplasia,” Clinical Gastroenterology and
Hepatology, vol. 3, no. 7, pp. 3:S16–S20, 2005.
WLI
WLI
Color NBI 1 
Color NBI 1 
Fig. 8. WLI and synthesized NBI of live pig’s duodenum in inter-illumination
mode.
Fig. 9. The NBI Capsule Endoscope (Top Left: NBI Capsule Endoscope;
Top Right: LED module; Bottom Left: Receiver and Data Recorder; Bottom
Right: Image Viewer )
[5] Prateek Sharma, “Narrow band imaging in barrett’s esophagus,” Clinical
Gastroenterology and Hepatology, vol. 3, no. 7, pp. 3:S21–S22, 2005.
[6] G. Iddan, G. Meron, and A. Glukhovsky et al., “Wireless capsule
endoscopy,” Nature, vol. 405, pp. 417–418, May 25 2000.
[7] XinKai Chen, Xiaoyu Zhang, Linwei Zhang, Xiaowen Li, Nan Qi,
Hanjun Jiang, and Zhihua Wang, “A wireless capsule endoscope system
with low-power controlling and processing asic,” IEEE Trans. on
Biomedical and Systems, vol. 3, no. 1, pp. 11–22, Feb. 2009.
[8] Xiang Xie, Guolin Li, Xinkai Chen, Xiaowen Li, and Zhihua Wang,
“A low-power digital ic design inside the wireless endoscopic capsule,”
IEEE Journal of Solid-State Circuits, vol. 41, no. 11, pp. 2390–2400,
Nov. 2006.
[9] Jonathan Macdonald, Victoria Porter, and Deirdre McNamara, “Negative
capsule endoscopy in patients with obscure gi bleeding predicts low
rebleeding rates,” GASTROINTESTINAL ENDOSCOPY, vol. 68, no. 6,
pp. 1122–1127, 2008.
[10] Larry H. Lai, “Obscure gi bleeding: is capsule endoscopy sufficient?,”
GASTROINTESTINAL ENDOSCOPY, vol. 68, no. 6, pp. 1128–1130,
2008.
[11] OLYMPUS [Online], Available:http://www.olympus-europa.com.
[12] Rastislav Lukac and Konstantinos N. Plataniotis, “Color filter arrays
: Design and performance analysis,” IEEE Transactions on Consumer
Electronics, vol. 51, no. 4, Nov. 2005.
stage if higher current rates are applied to the battery [11]. So,
a medium charge current rate is often applied to the battery
instead of a higher current rate. This is to prevent overpotential
charging and overheating problems, but the charging time
is then compromised. A multi-step constant current charging
process can be regarded as a summation of several single-
step constant current processes as shown in Fig. 2. The
charge current rate at each stage is constrained to be lower
than previous stages for a better charging efficiency, which
is defined as the ratio of discharge capacity to the capacity
charged into the battery during the charging process. At the
same time, the temperature of the battery is confined in a safe
range which is similar to the thermostatic charging process
depicted in [11]. The capacity charged into the battery during
the charging process can be formulated as the product of the
charge current and the charging time. For the scheme of multi-
step constant current and constant voltage, the total charged
capacity Qtotal is calculated as the sum of charged capacities
for all constant current stages
∑
j Qj and the constant voltage
stage Qcv, as shown in Equation 1.
Qtotal =
∑
j
Qj +Qcv =
∑
j
Ijtj +
∫
Icvdt (1)
For a battery charging process, it is a trade-off among the
total charging time, the charging efficiency and the risk of
over-potential and over-heating of the battery. If a high current
rate (C-rate, in Ah or mAh) is adopted, the charging time is
reduced but the charging efficiency is decreased and the risk
of over-potential and over-heating is increased. On the other
hand, if a lower current rate is chosen, the charging efficiency
is increased but the total charging time is longer. Multi-step
constant current and constant voltage scheme falls in between
the two extreme case described above. In the beginning of
the charging process, a higher current rate is adopted. As the
capacity charged into the battery begins to build up, the lower
current rates are applied step by step. Then the constant voltage
is applied in the final stage until the end-of-charge condition
is triggered. This scheme acquires a good balance between
the total charging time and the charging efficiency, as well
as reducing the risk of damage the cycle life of the battery.
The studies in [6] [7] and [8] shows convinced results for
this scheme and proposed algorithms for searching the current
levels.
State-of-Charge (SoC) represents an estimated capacity
residual inside a rechargable battery at the current instant of
time. It is usually indicated in percentage % in comparison
to the maximal amount of capacity that can be charged into
the battery. The chemical dynamics inside the battery are
complicated and many research activities have been conducted
to obtain a good estimation of SoC [12]. For example, the
measured battery voltage can be used to estimate rough SoC
value for simplification. The charging efficiency of a battery,
η, is defined as the ratio of discharged capacity to the capacity
Fig. 2. Comparison of Single-Step Constant Current and Multi-Step Constant
Current
previously charged into the battery, as shown in the Equation 2.
η =
Edischarge
Echarge
=
∫
VdischargeIdischargedt∫
VchargeIchargedt
(2)
The battery charging efficiency at different stages of SoC is
an important a priori information for the proposed searching
algorithm. Battery charging and discharging tests at different
C-rates and SoC stages are conducted to acquire the necessary
data. In our experiment, the SoC is segmented evenly from
0% to 100% into equally segmented stages, e.g. M1, M2,
. . .M10, where M1 represents 0% − 10% SoC and M10
represents 90% − 100% SoC, etc. 1C-rate is chosen to
discharge the battery for all different charging C-rates to
simulate the worst case discharging condition. The battery
charging efficiency is computed based on this assumption.
The proposed algorithm to search the optimal charging
profile for Lithium-ion battery is to minimize the charging
time subject to a constrained battery charging efficiency.
This problem is then formulated as a branching problem
and solved by (0, 1)-integer linear programming in Section III.
III. INTEGER LINEAR PROGRAMMING FOR OPTIMAL
CHARGING PROFILE
Based on the analysis in Section II, the search for optimal
charging profile is equivalent to finding the best charging
current rate for each SoC segment. The search can then be
modeled as a branching problem depicted in Fig. 3. The
example in Fig. 3 demonstrates the space for all possible
branches in the search. Here we apply (0, 1)-integer linear
programming ((0, 1)-ILP or binary ILP) as a searching algo-
rithm for optimal charging profile. (0, 1)-ILP is a special topic
of linear programming which is applied broadly in branching
problem [9] [10]. In this example, 10 charge current levels
from 0.1C to 1C are assigned for multiple CC stages. For
every charging current rate in a single SoC segment, the
charge efficiency and charging time are acquired from charging
and discharging tests. Then the optimal branch for minimal
charging time subject to the constraint of charge efficiency is
obtained from (0, 1)-ILP, which is described in details in the
following sections.
A. Battery Charging and Discharging Tests
Battery charging and discharging tests are conducted by apply-
ing different constant charge rates for each SoC stage in order
TABLE III
OPTIMAL CHARGING PROFILE WITH SINGLE STAGE CV
M1 M2 M3 M4 M5 M6 M7 M8 M9
1C 0.9C 0.8C 0.8C 0.8C 0.7C 0.7C 0.7C 0.3C
SSoCj means the first SoC segment applied with current
rate Ij and it is shown in Equation 8.
SSoCj = 1 +
j−1∑
k=1
Sk, j = 2 . . .N (8)
subject to
Sj ≥ 0 (9)
Sj ≤M − 1, j = 1 . . .N (10)
N∑
j=1
Sj ≤M − 1 (11)
where SSoC1 = 1. SSoCcv represents the last SoC segment
for the CV stage. Equation 9 is a trivial constraint for the
optimization. Equation 10 and Equation 11 confine that at least
one CV stage is required to complete the charging process in
order to prevent overpotential charging.
Equation 12 and Equation 13 represent the overall discharg-
ing and charging capacities for CC mode, respectively.
Ecc,dis(SSoCcc) =
∑
j∈Sj 6=0
SSoCj+(Sj−1)∑
j=SSoCj
Edis(i, j) (12)
Ecc,ch(SSoCcc) =
∑
j∈Sj 6=0
SSoCj+(Sj−1)∑
j=SSoCj
Ech(i, j) (13)
The overall charging efficiency in Equation 14 is obtained by
the ratio of total discharging capacity to the total charging
capacity for both CC and CV modes. ηmin in Equation 15 is
a pre-defined constraint for the charging efficiency η during
the optimization process.
η =
Ecv,dis(SSoCcv) + Ecc,dis(SSoCcc)
Ecv,ch(SSoCcv) + Ecc,ch(SSoCcc)
(14)
η ≥ ηmin (15)
The purpose of the optimization is to minimize the total
charging time T , where
T = Tcv(SSoCcv) +
N∑
j=1
Tj (16)
Suppose a set of charging current level is chosen as
{1C, 0.9C, 0.8C, . . . , 0.1C} and SoC segments are {0% −
10%, 10% − 20%, . . . , 90% − 100%} (marked as M1,
M2,. . . ,M10), where 90% to 100% is applied with CV mode.
The experimental results for both CC-CV and proposed multi-
level CC and CV regimes are shown in TABLE. III, where
TABLE IV
BATTERY CHARGING SPECIFICATIONS
Capacity Charging Mode efficiency Time
1000 mAh CC-CV 88.04% 179.67 mins
M10 is the CV mode. The total charging time is 150
minutes and the overall charging efficiency is 88.051%. It
shows a better result in the total charging time than the
outcome of the battery applying CC-CV method in TABLE IV.
C. Modification for Multi-Step CC and CV Charging
In Section III, the last segment of charging is defined as
constant voltage (CV) phase. This raises another question: is
one single CV segment better than multiple CV segments?
Here we analyze the feasibility of multiple CV segments. For
this purpose, we modify the single CV stage into multiple-CV
stages of the proposed searching space shown in Fig. 3 and
run the (0, 1)-ILP to search the optimal profile. The SSoCCV
is modified as shown in Equation 17.
SSoCCV = 1 +
N∑
k=1
Sk (17)
The standard ILP formulation for a Lithium-ion battery charg-
ing profile is shown in TABLE. V and the algorithm flow chart
is described in Fig. 4. First, the number of charging current
rates and the number of SoC segments are chosen. Then a
branching space for (0, 1)-ILP is formed. Apply all feasible
current sequences in the calculation of charging efficiency
and charging time will end up with an optimal solution for
the charging profile. The charging efficiency and the charging
time for different numbers of CV stages are also calculated in
TABLE. VI. The charging profile is shown in Fig. 5, and the
charging efficiency and the total charging time are 88.046%
and 146.87 minutes, respectively, as shown in TABLE. VII.
The charging time is slightly shorter than the charging time
shown in Section III-B.
IV. EXPERIMENTAL RESULTS AND ANALYSIS
In this section, we apply the optimal charging profile
acquired from the search in Section III by ILP method to
a commercial Lithium-ion battery, and compare the result
with its specification using CC-CV scheme. The platform for
battery charging experiments conducted in this research is
assembled by a IBM compatible PC, NI Labview software,
TI gas gauge development suite and commercial off-the-shelf
Lithium-ion batteries.
A. Analysis On The Influence of Number of SoC Segments and
Current Levels
In this section, we analyze the effect of increasing numbers
of SoC segments and current levels on the optimal charging
time and charging efficiency. Four, five, ten, and twenty SoC
Fig. 5. Optimal Charging Profile with Multiple CV Stages
TABLE VIII
EXPERIMENTAL RESULTS OF DIFFERENT SOC SEGMENTS
Segments CC-CV 4 5 10 20
Charging Time 179.67 158.97 149.47 146.87 146.84
Improvement - 11.5% 17.3% 18.25% 18.27%
B. Fast and Slow charging
Both fast and slow charging regimes from a commercial
product specification are used to compare with the proposed
algorithm. Fast and slow charging are to charge the battery
with 1C-rate and 0.3C-rate till 80% SoC, respectively. By
applying ILP in searching the optimal charging profile, the ex-
perimental results show that the fast charging time is reduced
from 179.67 minutes to 146.87 minutes, and the slow charging
time is reduced from 275.83 minutes to 216.97 minutes as
shown in TABLE X. The improvement rates are 18.25% and
21.38%, respectively.
Fig. 6. Improvement of Charging time for different numbers of SoC segments
TABLE IX
COMPARISON RESULTS OF DIFFERENT CHARGING CURRENT LEVELS
Currents CC-CV 5 10
Charging Time 179.67 148.96 146.87
Improvement - 17.09% 18.25%
TABLE X
COMPARISON WITH DIFFERENT CHARGING SPEEDS
Charging Speed Fast Charging Slow Charing
CC-CV 179.67 mins 275.83 mins
Multi-Level CC-CV
with ILP Scheduling 146.87 mins 216.97 mins
Improvement 18.25% 21.38%
V. CONCLUSION
A novel algorithm applying (0, 1)-integer linear program-
ming is proposed to search the optimal charging profile for
rechargeable Lithium-ion batteries. Multi-step (level) constant
current method is applied in the charging experiments. The
grade of charging currents and number of segments are also
discussed. Here we proposed a novel algorithm using (0, 1)-
integer linear programming(ILP) to search the optimal charg-
ing profile for multi-step constant current and constant voltage
charging scheme. Experimental results show that the proposed
algorithm achieves up to 18.25% and 21.38% charging time
reduction in comparison to fast- and slow-charging specifica-
tions of a commercial product respectively, while the charging
efficiency is constrained at an acceptable level.
ACKNOWLEDGMENT
The authors would like to thank for the research grant from
the Science Park Administration Bureau, Taiwan.
REFERENCES
[1] R. A. Powers, “Batteries for low power electronics,” in Proc. of the
IEEE, vol. 83, no. 4, April 1995, pp. 687–693.
[2] A. W. Swager, “Smart battery technology: Power management’s missing
link,” EDN, pp. 47–64, March 1995.
[3] L. J. Curran, “Charger ics reflect shift to smart batteries,” EDN, pp.
10–11, 1997.
[4] R. Schweber, “Supervisory ics empower batteries to take charge,” EDN,
pp. 61–72, September 1997.
[5] D. Linden, Handbook of Batteries, 3rd ed. McGraw-Hill, 2002.
[6] T. Ikeya, N. Sawada, S. Takagi, J. Murakami, K. Kobayashi, T. Sakabe,
E. Kousaka, H. Yoshioka, S. Kato, M. Yamashita, H. Narisoko, Y. Mita,
K. Nishiyama, K. Adachi, and K. Ishihara, “Multi-step constant-current
charging method for an electric vehicle, valve-regulated, lead-acid
batteries during night time for load-leveling,” Journal of Power Sources,
vol. 75, no. 1, pp. 101–107, September 1998.
[7] T. Ikeya, N. Sawada, J. Murakami, K. Kobayashi, M. Hattori,
N. Murotani, S. Ujiie, K. Kajiyama, H. Nasu, H. Narisoko, Y. Tomaki,
K. Adachi, Y. Mita, and K. Ishihara, “Multi-step constant-current
charging method for an electric vehicle nickel/metal hybrid battery with
high-energy efficiency and long cycle time,” Journal of Power Sources,
vol. 105, no. 1, pp. 6–12, March 2002.
[8] Y. Liu, J. Teng, and Y. Lin, “Search for an optimal charging pattern for
lithium-ion battery using ant colony system algorithm,” IEEE Tran. on
Industrial Electronics, vol. 52, no. 5, pp. 1328–1336, October 2005.
[9] A. Schrijver, Theory of Linear and Integer Programming. John Wiley
& Sons, 1986.
[10] L. A. Wolsey, Integer Programming. John Wiley &Sons, 1998.
[11] H. Bergveld, W. Kruijt, and P. Notten, Battery Management Systems
Design by Modelling. Kluwer Academic Publishers, 2002, vol. 1.
[12] V. Pop, H. Bergveld, P. Danilov, and R. Regtien, Battery Management
Systems-Accurate State of Charge Indication for Battery-Power Appli-
cations. Springer, 2008.
 15 
此次參加會議主要是了解目前學術界有關生醫相關晶片設計之現況與未來趨勢。本
人發表的論文創新地提出利用窄波段影像偵測黏膜層下血管分布影像之整合晶片，
引起不錯的迴響。個人從中啟發出未來的研究改進與創新主意。 
三、考察參觀活動(無是項活動者略) 
無 
四、建議 
此次參與之會議為為全世界生醫電路與系統設計的最重要年度會議，會中有國際級
的演講者、課程、展示、以及論文發表。本人強烈建議國內學者積極參與是項會議，
與國際研究接軌互動。 
五、攜回資料名稱及內容 
會議光碟片與相關簡介資料。 
六、其他 
 
 
 
 
 
 
 
 
B image G image R image
415nm 540nm 600nm
Fig. 1. NBI principle (Olympus Corporation, Japan)
Monochromic CCD 
Tissue 
NBI filter 
Xenon Lamp 
Fig. 2. Configuration of Olympus SPECTRUM
band images. Because the absorption band of hemoglobin is
415nm [1], the microvasculature of its mucosal surface can
be seen clearly. Another absorption band of hemoglobin is
540nm. The 415nm light can not reach the depth where the
vessels presented on the 500nm because of multiple scattering
effect in tissue. Therefore, in the synthesized image, we can
see vessels on both superficial and deeper tissue.
The proposed wireless NBI capsule endoscope system is
composed of a capsule, a portable data recorder, a real-time
monitor, an computer with image viewer, and a DICOM
Gateway which is given in Fig. 3. The portable data recorder
receives the image raw data via RF receiver and saves in
large volume flash memory. Meanwhile, real-time monitor can
display the image of digestive tract during routine examination.
After inspection, the received image raw data can be uploaded
to computer through a USB port. The white light image(NBI)
and narrow band image(WLI) image are then synthesized and
shown by software on the computer. The DICOM gateway
provides a standard for handling, storing, printing, and trans-
mitting information in medical imaging.
Inside the wireless NBI capsule, a narrow band LED light
source, a 512-by-512 dual-mode CMOS image sensor, and a
RF transmitter are adopted as illustrated in Fig. 4. Two oxide
batteries and an antenna are also installed for power and RF
transmitter. The narrow band LED light source comprises six
LEDs : three white LEDs for WLI and three 430nm blue LEDs
for narrow NBI. The wireless RF transmitter designed by our
RF team furnishes FSK modulation with 8 Mbps for image
data transmitting which operates in 416MHz ISM band.
Capsule
Endoscope
Data
Recorder
Real-Time
Monitor
Image
Viewer
DICOM
Gateway
Target
Keyboard
Keyboard
Keyboard
Mouse
LCD
Monitor
Mouse
Mouse
LCD
Monitor
LCD
Monitor
Ethernet
Contral
Message
Contral
Message
Contral
Message
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
˖̂̀̀˴́˷
˂ʳ˗˴̇˴
Processing image
/ Information
Processing image
/ Information
Processing image
/ Information
Non-DICOM
Image
DICOM
Image
Light
Signal
RF
Signal
RF
Signal
Raw
Image
Fig. 3. The System description of NBI Capsule Endoscope.
3
2
14567
White Light LED 
Narrow Band LED 
Fig. 4. The structure of NBI Capsule Endoscope (1: Len; 2:LEDs; 3: LEDs;
4: CMOS sensor; 5: Battery; 6: RF transmitter; 7: Antenna)
III. DESIGN OF NARROW BAND CMOS IMAGE SENSOR
The design challenge of NBI capsule endoscope concen-
trates on the narrow band image acquisition and its power
consumption. Fig. 5 shows the block diagram of the CMOS
sensor. Each pixel contains three transistors and a photo diode.
Charge pumping produces higher voltage for pixel resetting
to increase output signal swing. Correlated double sampling
circuit is used for low-power noise canceling at the column.
The sampled charges are transferred to video amplifier by
horizontal shift register. The designed flash ADC generates
a 8-bit digital output with very low power consumption. To
acquire proper image intensity and decrease the power con-
sumption of LEDs, a auto expose control ASIC is integrated.
The PISO/Randomizer links the RFIC and image sensor. The
analog and digital circuits inside the chip are supplied by
bandgap reference and regulators.
Color filter array is one of the most singular hardware
elements in a single monochrome sensor to acquire color
CMOS APS
Imaging Area 
(512x512) 
Column CDS Circuits 
Horizontal Shift Register 
PISO
/Randomizer
Auto Expose Ctrl 
V
e
rt
ic
a
l 
S
h
if
t 
R
e
g
is
te
r 
T
im
in
g
 
G
e
n
.
A/D
Video Amp. 
BandGap
Reference 
Charge
Pumping
To RFIC
Regulator
Fig. 5. Block diagram of CMOS sensor
P
ix
el a
rra
y
 5
1
2
x
1
5
2
 
A
D
C
D
ig
ita
l co
re
Vertical Shift Register
Vertical Shift Register
C
o
lu
m
n
 C
D
S
 a
n
d
 H
o
rizo
n
ta
l S
h
ift
R
eg
ister
Fig. 7. Chip photomicrograph.
the sake of power, effective low power techniques need to
be utilized in the design to guarantee long working time.
With 3V power supply, implementation results show the sensor
consumes only 2mA at 2 frame/s and the entire wireless NBI
capsule that dissipates nearly 7∼8 mA can work for 6∼8
hours consecutively. Experiment results on backside mucosa
of a human tongue and pig’s small intestine demonstrate that
NBI capsule endoscope is a beneficial tools for discriminative
diagnosis by providing contrast-enhanced image of vascular
and white light image.
TABLE I
CHIP SPECIFICATIONS
Technology 0.25µm 1P4M CMOS
Chip Size 3.7mm x 3.95mm
Format 512x512
Pixel size 5.6µmx5.6µm
Fill Factor 47%
ADC resolution 8bit
Frame rate 2Hz
Power Consumption 2mW@3V
ACKNOWLEDGMENT
This work was supported by Chung-Shan Institute of Sci-
ence and Technology, Taiwan. The authors would like to thank
Dr. Shien-Ming Wu for his technical support and funds.
REFERENCES
[1] K. Gono, “Multifunctional endoscopic imaging system for support of
early cancer diagnosis,” IEEE Journal of Selected Topics in Quantum
Electronics, vol. 14, no. 1, pp. 62–69, Jan/Feb. 2008.
[2] K. Gono, T. Obi, M. Yamaguchi, N. Ohyama, H. Machida, Y. Sano,
S. Yoshida, Y. Hamamoto, and T. Endo, “Appearance of enhanced tissue
features in narrowband endoscopic imaging,” J. Biomed. Opt., vol. 9,
pp. 568V577, May/Jun. 2004.
[3] K. Gono, K. Yamazaki, N. Doguchi, T. Nonami, T. Obi, M. Yamagichi,
N. Ohyama, H.Machida, Y. Hamamoto Y. Saono S.Yoshida, and T. Endo,
“Endoscopic observation of tissue by narrowband illumination,” Opt.
Rev., vol. 10, pp. 211V215, 2003.
[4] Manabu Muto, Chikatoshi Katada, Yasushi Sano, and Shiegaki Yoshida,
“Narrow band imaging: A new diagnostic approach to visualize an-
giogenesis in superficial neoplasia,” Clinical Gastroenterology and
Hepatology, vol. 3, no. 7, pp. 3:S16–S20, 2005.
WLI
WLI
Color NBI 1 
Color NBI 1 
Fig. 8. WLI and synthesized NBI of live pig’s duodenum in inter-illumination
mode.
Fig. 9. The NBI Capsule Endoscope (Top Left: NBI Capsule Endoscope;
Top Right: LED module; Bottom Left: Receiver and Data Recorder; Bottom
Right: Image Viewer )
[5] Prateek Sharma, “Narrow band imaging in barrett’s esophagus,” Clinical
Gastroenterology and Hepatology, vol. 3, no. 7, pp. 3:S21–S22, 2005.
[6] G. Iddan, G. Meron, and A. Glukhovsky et al., “Wireless capsule
endoscopy,” Nature, vol. 405, pp. 417–418, May 25 2000.
[7] XinKai Chen, Xiaoyu Zhang, Linwei Zhang, Xiaowen Li, Nan Qi,
Hanjun Jiang, and Zhihua Wang, “A wireless capsule endoscope system
with low-power controlling and processing asic,” IEEE Trans. on
Biomedical and Systems, vol. 3, no. 1, pp. 11–22, Feb. 2009.
[8] Xiang Xie, Guolin Li, Xinkai Chen, Xiaowen Li, and Zhihua Wang,
“A low-power digital ic design inside the wireless endoscopic capsule,”
IEEE Journal of Solid-State Circuits, vol. 41, no. 11, pp. 2390–2400,
Nov. 2006.
[9] Jonathan Macdonald, Victoria Porter, and Deirdre McNamara, “Negative
capsule endoscopy in patients with obscure gi bleeding predicts low
rebleeding rates,” GASTROINTESTINAL ENDOSCOPY, vol. 68, no. 6,
pp. 1122–1127, 2008.
[10] Larry H. Lai, “Obscure gi bleeding: is capsule endoscopy sufficient?,”
GASTROINTESTINAL ENDOSCOPY, vol. 68, no. 6, pp. 1128–1130,
2008.
[11] OLYMPUS [Online], Available:http://www.olympus-europa.com.
[12] Rastislav Lukac and Konstantinos N. Plataniotis, “Color filter arrays
: Design and performance analysis,” IEEE Transactions on Consumer
Electronics, vol. 51, no. 4, Nov. 2005.
其他成果 
(無法以量化表達之成
果如辦理學術活動、獲
得獎項、重要國際合
作、研究成果國際影響
力及其他協助產業技
術發展之具體效益事
項等，請以文字敘述填
列。) 
無 
 成果項目 量化 名稱或內容性質簡述 
測驗工具(含質性與量性) 0  
課程/模組 0  
電腦及網路系統或工具 0  
教材 0  
舉辦之活動/競賽 0  
研討會/工作坊 0  
電子報、網站 0  
科 
教 
處 
計 
畫 
加 
填 
項 
目 計畫成果推廣之參與（閱聽）人數 0  
