 II
mechanism for H.264 video transmission over Diffserv network. The mechanism can adaptively 
adjust video priority based on each packet location and content information to increase H.264 
NAL network friendliness and robustness. Consequently, the received real-time surveillance 
image quality can be guaranteed. Finally, we propose a loss differentiation algorithm over WLAN 
environment, which could distinguish between packet losses due to buffer overflow or those due 
to bit errors. It avoids treating wireless losses as congestion, which leads to unnecessary rate 
reduction and poor performance. 
 
Keywords: multi-camera surveillance system, H.264 video coding, foreground block 
detection, rate allocation, video packet priority, DiffServ network, WLAN, TFRC 
 2
後，監控系統也會根據目前網路可得頻寬與前景偵測區塊數量，對各鏡頭依不同重要性做
位元率分配，使得較重要的攝影機有較佳視訊品質。另外在 Server與 Client端的溝通方面，
為了讓我們的監控視訊在網際網路傳輸時有較佳品質，我們針對 H.264 視訊提出一套傳送
於差異式服務網路之調適性視訊封包優先權策略，以提升 H.264 網路提取層的網路友善性
與抗錯性。 
    本計畫的系統架構及流程圖，如圖(二)所示。以下將針對每個區塊作簡單的說明： 
¾ 網路攝影機端(IP camera End) 
z 前景區塊偵測(Foreground Detection) 
偵測前景區塊數量，並將此資訊傳給 Server端以對各鏡頭做位元率分配。 
z 調適性位元率編碼(Rate Adaptive Encoding) 
根據網路可用頻寬以及前景偵測機制所得之前景區塊數量進行動態位元率控制編
碼，使輸出位元率符合目前的網路狀況，避免讓網路變得更為壅塞。 
z 抗錯性編碼器(Error Resilient Encoder) 
將視訊攝影監控系統所傳過來的畫面作編碼，並將 H.264 壓縮編碼中的抗錯機制
致能，以抵抗視訊封包在網路上傳送時可能發生的遺失或錯誤。 
z 優先權模組(Priority module) 
根據監控視訊內容做調適性視訊封包優先權分配，讓視訊封包在不同的網路狀況
中都能夠獲得最佳的視訊封包傳送效率。 
z 封包封裝器(Packetizer) 
將視訊資料封裝成封包並透過 RTP/UDP/IP傳送到伺服器端。 
z TFRC 
建立一套數學模型去評估網路的可用頻寬，並將其送至調適性位元率編碼區塊去
作動態位元率控制。 
z 重傳(Retransmission) 
重傳遺失或發生錯誤的封包，此機制將與 H.264 的抗錯機制作整合，以進一步地
增加視訊監控系統的抗錯性。 
¾ 伺服器端(Server End) 
z 位元率分配機制(Rate Allocation) 
根據網路可用頻寬以及前景偵測機制所得之前景區塊數量對各鏡頭進行動態位元
率分配，將此訊息回傳至 IP camera端。 
z Video/Priority Storage 
儲存視訊與優先權之資訊。 
¾ 用戶端(Client End) 
z 封包解封裝器(Depacketizer) 
讀取從網路上所收到的封包檔頭，並將解完檔頭之封包還原成原本之視訊資料。 
z QoS監測器(QoS Monitor) 
監測在用戶端收到封包的統計資訊(如：封包遺失率、封包延遲時間)，並將此資訊
傳到回傳控制機制作處理。 
z 回傳控制機制(Feedback Control Mechanism) 
將從 QoS監測器所獲得的資訊，利用 RTCP協定回傳到視訊伺服端的 TFRC區塊
並作相關之處理。 
 4
門檻值。 
                  
[ ][ -1] - [ ][ -1]
[ ][ ] - [ ][ ]
[ ][ 1] - [ ][ 1]
b n Row
b n Row
b n Row
F y x F y x TH
F y x F y x TH
F y x F y x TH
> ∩
> ∩
+ + >
      
      
    
                       (2) 
b. 如果 Row_Buffer中的值大於等於 ColTH ，則將其值設為 16，不是設為 0，作為行填
充的依據， ColTH 為過濾零散的區塊的門檻值。 
c. 接著以 Row_Buffer中 ColN 個區塊做行方向的填充，找出行第一個值為 16的區塊位
置當成填充的起始點，再找出以起始點開始的 ColN 個區塊內的最後一個值為 16 的
區塊位置當成截止點，最後將起始點到截止點之間都設定為前景區塊，再找出下一
個值為 16的區塊位置當成填充起始點並重複上面流程，最後完成前景區塊的萃取。 
1.1.3背景模型更新 
    背景相減法對於動態場景變化，如光照和偶發事件等特別敏感，因此透過我們設計的
背景更新機制，判斷背景有改變時，進行更新背景的動作，可以減少偵測的錯誤。 
 當前景偵測演算法找出前景區塊後，如果同一前景區塊連續一段時間在同一位置上靜
止不動，區塊要被歸類到背景模型中。由於我們是使用 Block 為基礎的偵測模式，因此也
選擇以 Block為基礎的方法來更新我們的背景模型。我們的背景更新模型會更新兩種情形，
第一是將在前景區塊中相同的位置上保持一段時間不變的區塊；第二是將在保持一段時間
不變的非 SNFB，更新至背景模型之中，SNFB為在相同的位置上保持不變的非前景區塊。 
 
1.2 位元率分配機制 
    在多鏡頭視訊位元率分配方面，我們提出一套基於 Q-R-D模型之多鏡頭下的調適性位
元率分配機制，稱為 AQRD位元率分配機制（Adaptive Q-R-D Rate Allocation）。此機制必
須 先 在 無 前 景 區 塊 的 狀 況 下 ， 設 定 一 個 最 低 畫 面 品 質
min , 1,2, , ,
nPSNR n N= L N 為攝影機總數，依此參數透過 Q-D線性趨近線與 Q-R冪次趨近線可
快速求出在無前景區塊下的最低品質的位元率，再依據使用者的需求則可求出可調位元
率，然後根據前景區塊數量去動態分配可調位元率，每個鏡頭分配到的位元率再由 H.264
位元率控制機制[4][5]來完成位元率控制，使得擷取到較重要畫面的攝影機擁有較高的位元
率配置及較佳的視訊品質。其位元率分配機制的步驟流程如下：  
a. 擷取M 張連續的背景影像，然後使用不同量化參數來對這些背景影像進行壓縮，並且
利用線性迴歸來求出 Q-D線性趨近線、乘冪迴歸來求出 Q-R乘冪趨近線。 
b. 給予每支攝影機最小畫面品質參數 minnPSNR ，然後使用 Q-D 線性趨近線求出每支攝影機
的最大量化參數 maxnQP ，再使用 Q-R乘冪趨近線找出每支攝影機的最小位元率 minnR 。 
c. 我們設定一個位元可調率參數( AR )， AR為總頻寬( BW )中位元率分配機制可調整的位
元率比例。由步驟 b找出每支攝影機的最小位元率後，考慮以下三種情形，並決定出每
支攝影機的初始位元率 nInitR ，其中 ARR 為真正可調的位元率。 
Case1： min min
1 1
(1 )
N N
n n
n n
R BW AR R BW
= =
≥ − ∩ ≤∑ ∑   
則 minn nInitR R= ，
1
N
n
AR Init
n
R BW R
=
= −∑ 。 
 6
                    , (1 )( ( ) ) ( )MB Intrak i I k i
MB
N NAP N k D
N
α α += − − +                   (4) 
其中α 為適性優先權參數。在設定 kD 時主要是考慮畫面之間的錯誤蔓延影響，所以將會使
用正規化後的錯誤平方差，為一定值來做評估。 
    計算視訊封包優先權大小，首先由我們擷取到的視訊影像特性來決定調適性優先權參
數α ，範圍( 0 < α  < 1 )，α 的設定將於下段中做討論。在決定調適性優先權參數α 後，
視訊封包將分為兩個部分來進行，第一部分，錯誤蔓延影響分析：利用視訊封包所屬的畫
面位置，計算錯誤蔓延的影響[6]，並得到以錯誤蔓延為基礎之子優先權。第二部分，視訊
品質提升能力分析：針對視訊封包內容進行內部更新巨方塊(Intra MB)解析，計算此封包擁
有視訊品質提升能力[8]，並得到以視訊品質提升能力為基礎之子優先權。分別計算個別的
子優先權後再乘上相對應的權重，最後將兩部分的子優先權做相加，得到此視訊封包所代
表的優先權等級。 
不同的α 參數會影響視訊封包的優先權計算，進而在錯誤蔓延效應與視訊品質提升能
力上有不同的權重。在α 參數的取決是由視訊影像(Video content)特性[10]來做為評量標
準。在視訊內容上大致分類成三大類：第一類是屬於 Class A，低變化與低畫面複雜度，例
如 Akiyo影片；第二類是屬於 Class B，高變化與低畫面複雜度，例如 Foreman影片；第三
類是屬於 Class C，高變化與高畫面複雜度，例如 Stefan影片。在我們所拍攝的監控視訊中，
針對以上三種不同類別的影像，進行錯誤蔓延效應分析，以觀察彼此間的差異，可以發現
不同影像特性對於錯誤蔓延影響是不同的，當視訊內容屬於高複雜度影片(Class C)時，應
重視錯誤蔓延效應所帶來的影響，故計算視訊封包優先權時，對於錯誤蔓延影響應該增加
權重，以防止嚴重的錯誤蔓延發生。反之，對於低複雜度影片(Class A)而言，可以相對地
降低錯誤蔓延影響的權重，增加對於視訊品質提升能力的權重。因此由視訊影像的特性可
以來決定如何調整調適性優先權演算法中α 參數，將 Class A 設為 0.9~0.6，Class B 設為
0.6~0.4，Class C設為 0.4~0.1。 
    我們將拍攝的監控影像做整體傳輸效能分析，結果如圖(六)所示。首先，針對網路是否
有提供服務品質的傳送機制進行比較。在一般網際網路上對於任何封包都一視同仁，使得
較高優先權等級的視訊封包也容易發生遺失，在視訊品質上將產生極大的影響。因此，視
訊傳送於網路上時，需要提供相對應的服務品質保證，加以保護不同優先權等級的視訊封
包，使得視訊品質不因網路發生封包遺失，而造成整體接收品質大幅地下滑。 
接著針對不同方法的優先權策略，分別為 Adaptive、Frame-based與 Packet-based進行
討論，皆使用差異式服務網路與合適的服務品質對應來傳送視訊封包。在不同的封包遺失
率下，發現使用調適性優先權訂定機制皆能維持較佳的視訊接收品質。由於調適性優先權
策略除了考量畫面的所在位置，亦同時依據每一個視訊封包的內容資訊來評估視訊封包擁
有的視訊品質提升能力，給予最適當的優先等級，故對視訊品質的強健性有所幫助，有效
降低我們所監控視訊在網路上不幸發生封包發生錯誤帶來的影響。 
 
(三) 多鏡頭視訊監控系統之無線網路傳輸效能提升 
 當我們的監控視訊經由 IP camera壓縮後於無線網路傳輸至 Server端，因為有線與無線
環境在本質上的差異性，造成原本一些壅塞控制協定如 TCP或 TFRC等效能不佳，為了改
善此問題，我們提出一套應用於無線網路下的改良式 TFRC 機制，以提昇整體頻寬使用效
能。 
 8
引用的概念很簡單，當底層傳遞無線傳輸錯誤訊息時，我們選擇性地將該視訊封包遺
失原因視為壅塞事件，忽視此回報訊息。因為啟動自動重送機制後，無線基地台緩衝區內
的封包等待服務時間拉長，佇列長度隨之增加，又無線環境所提供之傳輸率較有線網路慢，
通常為整段連線的頻寬瓶頸，因此，重傳程序可能會造成緩衝區出現溢滿狀況導致丟棄封
包。簡而言之，在啟動自動重送機制後，無線傳輸錯誤訊息也代表著某種程度的壅塞警示
訊息，TFRC 可以依此作適當的調整。我們採取的作法為在 TFRC 模組內的中加入機率條
件判斷式，當機率值大於預設變數 TH 時則啟動分離機制，反之則忽略該錯誤訊息，等同
於視為壅塞遺失封包。 
 
(四) 結論 
    我們發展一套多鏡頭視訊監控系統將前景區塊偵測與位元率分配機制整合，如圖(九)、
圖(十)。由實驗結果證明我們提出的 EFBD 機制能夠有效與及時的萃取出前景區塊，且不
容易受到光線變化的影響，產生誤動作現象。經由 EFBD 機制萃取出區塊後，再搭配上
AQRDRA機制讓有前景區塊的攝影機，給予較高的位元率配置，以獲得較佳的視訊品質，
我們將所提之演算法在實際有效頻寬 1.1Mbps 下做八路攝影機的模擬實驗，結果證實所提
的方法，在幾乎不影響非重點攝影機的視覺品質下，比起位元率均分法(URA)可大幅提升
重點攝影機的視訊品質最高達 8.7dB之多[13][14]。 
    將上述監控系統搭配我們所提出的調適性視訊封包優先權訂定機制，對於每個視訊封
包所位於的畫面位置與內容資訊ㄧ同進行評估，並依據不同的影像特性進行優先權調整，
達到較合適的優先權等級配置，以有效區分視訊封包的優先權來提供不同的保護，可提升
H.264 視訊的網路友善性與高抗錯性。由模擬結果可以發現，調適性視訊封包優先權訂定
機制相對於僅使用畫面位置/封包內容之優先權機制有 3dB/1.5dB提升，有助於我們的監控
視訊傳送在具有服務品質的網路上達到較佳的視訊品質[15][16]。 
    而監控攝影機所拍攝視訊利用無線網路傳輸時，我們使用一套適用無線網路的 TFRC
錯誤分離機制，藉此分離壅塞事件與無線傳輸錯誤所造成之封包遺失情形。由模擬結果發
現，加入錯誤分離機制的 TFRC 在有效接收率項目中的表現較未加入分離機制之 TFRC 至
少提升了 9 倍，當網路競爭程度降低或無線傳輸錯誤率升高時則有更高的提升。進一步分
析在具有自動重送機制之無線網路中，完全將無線傳輸錯誤排除於壅塞控制協定外對傳輸
效能的影響。當監控系統環境的網路競爭程度增加時，錯誤分離機制內的分離係數臨界值
需要作相對的提升，而無線傳輸錯誤率上升時則須調降係數值，確切的臨界值選擇則可依
照實驗結果中的收斂區間大小，及容許之傳輸率下降幅度作判斷。模擬結果顯示，錯誤分
離機制之臨界值在不同狀態之環境(競爭程度、無線傳輸錯誤率)中可以作適度的調整，使得
TFRC 的傳輸率與封包壅塞遺失率達到平衡狀態(使用者接受範圍內的傳輸率下降可降低壅
塞錯誤率與封包延遲)[17]。 
 
五、參考文獻 
[1]  W. Hu, T. Tan, L. Wang and S. Maybank, “A survey on visual surveillance of object motion 
and behaviors,” IEEE Transactions on Systems, Man and Cybernetics Part C: Applications 
and Reviews, vol. 34, pp. 334-352, 2004. 
 10
Delivering Streaming Videos over Differentiated Service Networks,” PSIVT 2006 
accepted. 
[16]  莊世榮, “H.264視訊傳送於差異式服務網路之跨層服務品質對應研究,＂ 國立中央
大學通訊工程研究所碩士論文, 中華民國九十五年六月. 
[17]  蔡怡安, “應用於無線區域網路之改良式對TCP友善的傳輸效能研究,＂ 國立中央大
學通訊工程研究所碩士論文, 中華民國九十五年六月. 
 
圖(一) 多鏡頭監控系統示意圖 
 
圖(二) 視訊監控系統架構及流程圖 
前景區塊偵測與 H.264調適
性視訊位元率壓縮，調適性
視訊封包優先權模組 
視訊位元率分配 
調適性視訊封包優先權策
適用於無線網路之 TFRC 
